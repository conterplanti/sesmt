<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"/>
<title>CONTERPLAN â€“ SGI / APR | ServiÃ§os de Campo e Obras</title>
<!-- Libs (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* Embedded QR (offline) â€“ based on qrcode-generator (Kazuhiko Arase, MIT) + lightweight wrapper */
(function(global){
  /* qrcode-generator core (compact) */
  function QR8bitByte(data){this.mode=1;this.data=data;this.parsed=[];for(var i=0;i<data.length;i++)this.parsed.push(data.charCodeAt(i));}
  QR8bitByte.prototype={getLength:function(){return this.parsed.length;},write:function(buffer){for(var i=0;i<this.parsed.length;i++)buffer.put(this.parsed[i],8);}};

  function QRBitBuffer(){this.buffer=[];this.length=0;}
  QRBitBuffer.prototype={
    get:function(index){var bufIndex=Math.floor(index/8);return ((this.buffer[bufIndex]>>> (7-index%8)) & 1)==1;},
    put:function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>> (length-i-1)) & 1)==1);},
    putBit:function(bit){var bufIndex=Math.floor(this.length/8);
      if(this.buffer.length<=bufIndex)this.buffer.push(0);
      if(bit)this.buffer[bufIndex]|=(0x80 >>> (this.length%8));
      this.length++;
    }
  };

  var QRMath = {
    glog:function(n){if(n<1)throw new Error("glog");return QRMath.LOG_TABLE[n];},
    gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n];},
    EXP_TABLE:new Array(256),
    LOG_TABLE:new Array(256)
  };
  for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;
  for(var i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
  for(var i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;

  function QRPolynomial(num,shift){
    var offset=0;while(offset<num.length && num[offset]==0)offset++;
    this.num=new Array(num.length-offset+shift);
    for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset];
  }
  QRPolynomial.prototype={
    get:function(index){return this.num[index];},
    getLength:function(){return this.num.length;},
    multiply:function(e){
      var num=new Array(this.getLength()+e.getLength()-1);
      for(var i=0;i<num.length;i++)num[i]=0;
      for(var i=0;i<this.getLength();i++){
        for(var j=0;j<e.getLength();j++){
          num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));
        }
      }
      return new QRPolynomial(num,0);
    },
    mod:function(e){
      if(this.getLength()-e.getLength()<0)return this;
      var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));
      var num=this.num.slice();
      for(var i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);
      return new QRPolynomial(num,0).mod(e);
    }
  };

  function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}
  QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){
    // Minimal RS block table (versions 1â€“10, M level) sufficient for typical text IDs in field.
    // If your payload grows, we automatically scale typeNumber up to 10.
    var table = {
      1:{M:[[1,26,16]]},2:{M:[[1,44,28]]},3:{M:[[1,70,44]]},4:{M:[[2,50,32]]},5:{M:[[2,67,43]]},
      6:{M:[[4,43,27]]},7:{M:[[4,49,31]]},8:{M:[[4,60,38]]},9:{M:[[5,58,36]]},10:{M:[[5,69,43]]}
    };
    var t = table[typeNumber] && table[typeNumber].M;
    if(!t) throw new Error("RS table missing for type "+typeNumber);
    var list=[];
    for(var i=0;i<t.length;i++){
      var n=t[i][0], total=t[i][1], data=t[i][2];
      for(var j=0;j<n;j++) list.push(new QRRSBlock(total,data));
    }
    return list;
  };

  function QRUtil(){}
  QRUtil.PATTERN_POSITION_TABLE=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]];
  QRUtil.G15=1335; QRUtil.G18=7973; QRUtil.G15_MASK=21522;

  QRUtil.getBCHDigit=function(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit;};
  QRUtil.getBCHTypeInfo=function(data){
    var d=data<<10;
    while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0){
      d^=(QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)));
    }
    return ((data<<10)|d)^QRUtil.G15_MASK;
  };
  QRUtil.getPatternPosition=function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber];};

  QRUtil.getMask=function(maskPattern,i,j){
    switch(maskPattern){
      case 0:return (i+j)%2==0;
      case 1:return i%2==0;
      case 2:return j%3==0;
      case 3:return (i+j)%3==0;
      case 4:return (Math.floor(i/2)+Math.floor(j/3))%2==0;
      case 5:return (i*j)%2+(i*j)%3==0;
      case 6:return ((i*j)%2+(i*j)%3)%2==0;
      case 7:return ((i*j)%3+(i+j)%2)%2==0;
      default: throw new Error("bad mask");
    }
  };

  QRUtil.getErrorCorrectPolynomial=function(errorCorrectLength){
    var a=new QRPolynomial([1],0);
    for(var i=0;i<errorCorrectLength;i++) a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));
    return a;
  };

  QRUtil.getLengthInBits=function(mode,type){
    if(1<=type && type<10) return 8; // byte mode
    return 16;
  };

  QRUtil.getLostPoint=function(qr){
    var moduleCount=qr.getModuleCount();
    var lostPoint=0;
    // level 1
    for(var row=0;row<moduleCount;row++){
      for(var col=0;col<moduleCount;col++){
        var sameCount=0;
        var dark=qr.isDark(row,col);
        for(var r=-1;r<=1;r++){
          if(row+r<0||moduleCount<=row+r)continue;
          for(var c=-1;c<=1;c++){
            if(col+c<0||moduleCount<=col+c)continue;
            if(r==0&&c==0)continue;
            if(dark==qr.isDark(row+r,col+c))sameCount++;
          }
        }
        if(sameCount>5) lostPoint += (3+sameCount-5);
      }
    }
    // level 2
    for(var row=0;row<moduleCount-1;row++){
      for(var col=0;col<moduleCount-1;col++){
        var count=0;
        if(qr.isDark(row,col))count++;
        if(qr.isDark(row+1,col))count++;
        if(qr.isDark(row,col+1))count++;
        if(qr.isDark(row+1,col+1))count++;
        if(count==0||count==4) lostPoint+=3;
      }
    }
    // level 3
    for(var row=0;row<moduleCount;row++){
      for(var col=0;col<moduleCount-6;col++){
        if(qr.isDark(row,col)&&!qr.isDark(row,col+1)&&qr.isDark(row,col+2)&&qr.isDark(row,col+3)&&qr.isDark(row,col+4)&&!qr.isDark(row,col+5)&&qr.isDark(row,col+6))
          lostPoint+=40;
      }
    }
    for(var col=0;col<moduleCount;col++){
      for(var row=0;row<moduleCount-6;row++){
        if(qr.isDark(row,col)&&!qr.isDark(row+1,col)&&qr.isDark(row+2,col)&&qr.isDark(row+3,col)&&qr.isDark(row+4,col)&&!qr.isDark(row+5,col)&&qr.isDark(row+6,col))
          lostPoint+=40;
      }
    }
    // level 4
    var darkCount=0;
    for(var col=0;col<moduleCount;col++){
      for(var row=0;row<moduleCount;row++) if(qr.isDark(row,col)) darkCount++;
    }
    var ratio = Math.abs(100*darkCount/moduleCount/moduleCount - 50)/5;
    lostPoint += ratio*10;
    return lostPoint;
  };

  function QRCodeModel(typeNumber,errorCorrectLevel){
    this.typeNumber=typeNumber;
    this.errorCorrectLevel=errorCorrectLevel; // 'M'
    this.modules=null;
    this.moduleCount=0;
    this.dataCache=null;
    this.dataList=[];
  }
  QRCodeModel.prototype={
    addData:function(data){this.dataList.push(new QR8bitByte(data)); this.dataCache=null;},
    isDark:function(row,col){ if(this.modules[row][col]===null) return false; return this.modules[row][col];},
    getModuleCount:function(){ return this.moduleCount; },
    make:function(){
      if(this.typeNumber<1)this.typeNumber=1;
      this.makeImpl(false, this.getBestMaskPattern());
    },
    makeImpl:function(test, maskPattern){
      this.moduleCount = this.typeNumber*4 + 17;
      this.modules = new Array(this.moduleCount);
      for(var row=0;row<this.moduleCount;row++){
        this.modules[row]=new Array(this.moduleCount);
        for(var col=0;col<this.moduleCount;col++) this.modules[row][col]=null;
      }
      this.setupPositionProbePattern(0,0);
      this.setupPositionProbePattern(this.moduleCount-7,0);
      this.setupPositionProbePattern(0,this.moduleCount-7);
      this.setupTimingPattern();
      this.setupPositionAdjustPattern();
      this.setupTypeInfo(test, maskPattern);
      if(this.typeNumber>=7){} // omitted
      if(this.dataCache===null) this.dataCache = QRCodeModel.createData(this.typeNumber, this.errorCorrectLevel, this.dataList);
      this.mapData(this.dataCache, maskPattern);
    },
    setupPositionProbePattern:function(row,col){
      for(var r=-1;r<=7;r++){
        if(row+r<=-1||this.moduleCount<=row+r) continue;
        for(var c=-1;c<=7;c++){
          if(col+c<=-1||this.moduleCount<=col+c) continue;
          if((0<=r&&r<=6&&(c==0||c==6)) || (0<=c&&c<=6&&(r==0||r==6)) || (2<=r&&r<=4&&2<=c&&c<=4))
            this.modules[row+r][col+c]=true;
          else
            this.modules[row+r][col+c]=false;
        }
      }
    },
    getBestMaskPattern:function(){
      var minLost=1e9; var best=0;
      for(var i=0;i<8;i++){
        this.makeImpl(true,i);
        var lost=QRUtil.getLostPoint(this);
        if(lost<minLost){minLost=lost;best=i;}
      }
      return best;
    },
    setupTimingPattern:function(){
      for(var i=8;i<this.moduleCount-8;i++){
        if(this.modules[i][6]===null) this.modules[i][6] = (i%2==0);
        if(this.modules[6][i]===null) this.modules[6][i] = (i%2==0);
      }
    },
    setupPositionAdjustPattern:function(){
      var pos=QRUtil.getPatternPosition(this.typeNumber);
      for(var i=0;i<pos.length;i++){
        for(var j=0;j<pos.length;j++){
          var row=pos[i], col=pos[j];
          if(this.modules[row][col]!==null) continue;
          for(var r=-2;r<=2;r++){
            for(var c=-2;c<=2;c++){
              this.modules[row+r][col+c] = (Math.abs(r)==2||Math.abs(c)==2|| (r==0&&c==0));
            }
          }
        }
      }
    },
    setupTypeInfo:function(test, maskPattern){
      var data = (1<<3) | maskPattern; // M=0
      var bits = QRUtil.getBCHTypeInfo(data);
      for(var i=0;i<15;i++){
        var mod = (!test && ((bits>>i)&1)==1);
        if(i<6) this.modules[i][8]=mod;
        else if(i<8) this.modules[i+1][8]=mod;
        else this.modules[this.moduleCount-15+i][8]=mod;
      }
      for(var i=0;i<15;i++){
        var mod = (!test && ((bits>>i)&1)==1);
        if(i<8) this.modules[8][this.moduleCount-i-1]=mod;
        else if(i<9) this.modules[8][15-i-1+1]=mod;
        else this.modules[8][15-i-1]=mod;
      }
      this.modules[this.moduleCount-8][8]=(!test);
    },
    mapData:function(data, maskPattern){
      var inc=-1; var row=this.moduleCount-1; var bitIndex=7; var byteIndex=0;
      for(var col=this.moduleCount-1; col>0; col-=2){
        if(col==6) col--;
        while(true){
          for(var c=0;c<2;c++){
            if(this.modules[row][col-c]===null){
              var dark=false;
              if(byteIndex < data.length) dark = (((data[byteIndex]>>>bitIndex)&1)==1);
              var mask = QRUtil.getMask(maskPattern,row,col-c);
              if(mask) dark = !dark;
              this.modules[row][col-c]=dark;
              bitIndex--;
              if(bitIndex==-1){byteIndex++;bitIndex=7;}
            }
          }
          row += inc;
          if(row<0 || this.moduleCount<=row){
            row -= inc;
            inc = -inc;
            break;
          }
        }
      }
    }
  };

  QRCodeModel.createData=function(typeNumber, ecl, dataList){
    var rsBlocks = QRRSBlock.getRSBlocks(typeNumber, ecl);
    var buffer = new QRBitBuffer();
    for(var i=0;i<dataList.length;i++){
      var data = dataList[i];
      buffer.put(1,4); // byte mode
      buffer.put(data.getLength(), QRUtil.getLengthInBits(1,typeNumber));
      data.write(buffer);
    }
    // calc total data count
    var totalDataCount=0;
    for(var i=0;i<rsBlocks.length;i++) totalDataCount += rsBlocks[i].dataCount;
    // terminator
    if(buffer.length + 4 <= totalDataCount*8) buffer.put(0,4);
    while(buffer.length % 8 != 0) buffer.putBit(false);
    // padding
    var padBytes = [0xec,0x11];
    var iPad=0;
    while(buffer.length < totalDataCount*8){
      buffer.put(padBytes[iPad%2],8);
      iPad++;
    }
    // create bytes
    var dataBytes = [];
    for(var i=0;i<buffer.buffer.length;i++) dataBytes.push(buffer.buffer[i]);
    // error correction
    var offset=0;
    var dcdata=[], ecdata=[];
    var maxDc=0, maxEc=0;
    for(var r=0;r<rsBlocks.length;r++){
      var dcCount=rsBlocks[r].dataCount;
      var ecCount=rsBlocks[r].totalCount - dcCount;
      maxDc=Math.max(maxDc, dcCount);
      maxEc=Math.max(maxEc, ecCount);
      dcdata[r]=new Array(dcCount);
      for(var i=0;i<dcdata[r].length;i++) dcdata[r][i]=0xff & dataBytes[i+offset];
      offset += dcCount;
      var rsPoly = QRUtil.getErrorCorrectPolynomial(ecCount);
      var rawPoly = new QRPolynomial(dcdata[r], rsPoly.getLength()-1);
      var modPoly = rawPoly.mod(rsPoly);
      ecdata[r]=new Array(rsPoly.getLength()-1);
      for(var i=0;i<ecdata[r].length;i++){
        var modIndex = i + modPoly.getLength() - ecdata[r].length;
        ecdata[r][i] = (modIndex>=0)? modPoly.get(modIndex):0;
      }
    }
    // interleave
    var totalCodeCount=0;
    for(var i=0;i<rsBlocks.length;i++) totalCodeCount += rsBlocks[i].totalCount;
    var dataArr = new Array(totalCodeCount);
    var idx=0;
    for(var i=0;i<maxDc;i++){
      for(var r=0;r<rsBlocks.length;r++){
        if(i<dcdata[r].length) dataArr[idx++] = dcdata[r][i];
      }
    }
    for(var i=0;i<maxEc;i++){
      for(var r=0;r<rsBlocks.length;r++){
        if(i<ecdata[r].length) dataArr[idx++] = ecdata[r][i];
      }
    }
    return dataArr;
  };

  function makeQR(text){
    // choose version up to 10 (enough for IDs, short URLs, JSON identifiers)
    for(var v=1; v<=10; v++){
      try{
        var qr = new QRCodeModel(v, "M");
        qr.addData(text);
        qr.make();
        return qr;
      }catch(e){}
    }
    // fallback to v10
    var qr = new QRCodeModel(10, "M");
    qr.addData(text); qr.make(); return qr;
  }

  // Wrapper compatible with qrcodejs: new QRCode(el,{text,width,height})
  function QRCode(el, opts){
    opts = opts || {};
    var txt = opts.text || "";
    var size = opts.width || 220;
    var qr = makeQR(txt);
    var count = qr.getModuleCount();
    var cell = Math.floor(size / count);
    var canvas = document.createElement("canvas");
    canvas.width = canvas.height = cell * count;
    var ctx = canvas.getContext("2d");
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#000";
    for(var r=0;r<count;r++){
      for(var c=0;c<count;c++){
        if(qr.isDark(r,c)) ctx.fillRect(c*cell, r*cell, cell, cell);
      }
    }
    el.innerHTML = "";
    el.appendChild(canvas);
  }
  global.QRCode = QRCode;
})(window);
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --sam-blue:#005c8f;
  --sam-blue-2:#003b5c;
  --sam-blue-light:#e6f0f6;
  --sam-green:#3a9d5d;
  --sam-orange:#f7941d;
  --sam-red:#d9534f;
  --sam-gray:#4b4b4b;
  --bg:#f3f6fb;
  --card:#ffffff;
  --border:#d5dde7;
  --shadow:0 10px 30px rgba(15,23,42,0.08);
  --shadow2:0 14px 44px rgba(15,23,42,0.12);
}

*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
body{background:var(--bg);color:var(--sam-gray);min-height:100vh;}
a{color:inherit}

.app-shell{min-height:100vh;display:flex;flex-direction:column;}
.header{
  position:sticky;top:0;z-index:50;
  background:linear-gradient(90deg,var(--sam-blue-2),var(--sam-blue));
  color:#fff;
  padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  box-shadow:0 6px 22px rgba(0,0,0,.22);
}
.header-left{display:flex;align-items:center;gap:10px;min-width:0;}
.logo{
  width:44px;height:44px;border-radius:999px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
}
.logo img{width:100%;height:100%;object-fit:contain;}
.title-wrap{min-width:0;}
.title{font-weight:800;font-size:15px;letter-spacing:.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.subtitle{font-size:11px;opacity:.88;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.header-right{text-align:right;font-size:11px;opacity:.95;}
.pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);white-space:nowrap;}
.dot{width:8px;height:8px;border-radius:50%;background:#9ae6b4;display:inline-block}
.dot.off{background:#fbd38d;}
.dot.err{background:#feb2b2;}

.main{flex:1;display:flex;min-height:0;}
.sidebar{
  width:248px;flex:0 0 auto;
  background:#fff;border-right:1px solid var(--border);
  padding:10px;
  display:flex;flex-direction:column;gap:6px;
}
.nav-group{margin-top:4px;font-size:10px;text-transform:uppercase;letter-spacing:.14em;color:#6b7280;padding:8px 10px 4px;}
.nav-btn{
  border:none;background:transparent;border-radius:999px;
  padding:10px 12px;
  display:flex;align-items:center;gap:10px;
  cursor:pointer;
  color:#445; font-size:13px;
  transition:.15s;
  white-space:nowrap;
}
.nav-btn .icon{width:18px;text-align:center;font-size:15px;}
.nav-btn:hover{background:#f3f7ff;}
.nav-btn.active{background:rgba(0,92,143,.10);color:var(--sam-blue);font-weight:700;}
.sidebar-footer{margin-top:auto;font-size:10px;color:#6b7280;padding:10px 10px 6px;}

.content{
  flex:1;min-width:0;
  padding:14px 14px 18px;
  overflow:auto;
  overscroll-behavior:contain; /* reduz â€œpuloâ€ */
}
.section{display:none;}
.section.active{display:block;}

.card{
  background:var(--card);
  border-radius:18px;
  padding:14px 14px 12px;
  border:1px solid rgba(148,163,184,.35);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;}
.card-title{font-weight:800;color:#243;color:var(--sam-blue);font-size:14px;display:flex;align-items:center;gap:8px;}
.card-sub{font-size:11px;color:#6b7280;margin-top:2px;}
.badge{padding:3px 9px;border-radius:999px;font-size:10px;background:var(--sam-blue-light);color:var(--sam-blue);white-space:nowrap;}

.grid{display:grid;gap:10px;}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr));}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr));}
@media (max-width:980px){.grid-2,.grid-3{grid-template-columns:1fr;}}

.kpi{
  border-radius:16px;
  padding:12px 12px 10px;
  background:linear-gradient(145deg,#fff,#eef6ff);
  border:1px solid rgba(148,163,184,.40);
}
.kpi-label{font-size:11px;color:#6b7280;}
.kpi-value{font-size:24px;font-weight:900;color:var(--sam-blue);margin-top:3px;line-height:1;}
.kpi-sub{font-size:11px;color:#6b7280;margin-top:6px;}

.form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:980px){.form-grid{grid-template-columns:1fr;}}
label{font-size:12px;font-weight:700;color:#334;}
.input,select,textarea{
  width:100%;
  border:1px solid var(--border);
  border-radius:10px;
  padding:9px 10px;
  font-size:12px;
  background:#fff;
}
textarea{min-height:84px;resize:vertical;}
.small{font-size:10px;color:#6b7280;margin-top:3px;}

.btn{
  border:none;border-radius:999px;
  padding:9px 12px;
  font-size:12px;
  cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;
  transition:.15s;
}
.btn-primary{background:var(--sam-blue);color:#fff;}
.btn-primary:hover{filter:brightness(.95);}
.btn-outline{background:#fff;border:1px solid var(--sam-blue);color:var(--sam-blue);}
.btn-danger{background:var(--sam-red);color:#fff;}
.btn-sm{padding:6px 10px;font-size:11px;}

.table-wrap{border:1px solid var(--border);border-radius:14px;overflow:auto;background:#fff;max-height:320px;}
table{width:100%;border-collapse:collapse;font-size:11px;}
th,td{padding:8px 10px;border-bottom:1px solid #edf0f5;text-align:left;vertical-align:top;}
th{background:#f7f9fd;position:sticky;top:0;z-index:5;font-size:11px;}
tr:nth-child(even){background:#fafbff;}

.tag{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:10px;font-weight:800}
.t-acidente{background:#fdecea;color:#b93730;}
.t-nc{background:#fff4e5;color:#b86e00;}
.t-ambiental{background:#e9f7ef;color:#2e7d32;}
.t-evidencia{background:#e9ecff;color:#2e3aa7;}
.t-apr{background:#eef2ff;color:#1d4ed8;}

.rp{background:#22c55e33;}
.rm{background:#eab30833;}
.ra{background:#f9731633;}
.rc{background:#ef444433;}

.chart-card{min-height:260px;}
.chart-card canvas{width:100% !important;height:220px !important;display:block;}

.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
.chip{
  border:1px solid var(--border);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  cursor:pointer;
  background:#fff;
}
.chip.sel{background:var(--sam-blue);border-color:var(--sam-blue);color:#fff;}
.rdo-progress{display:flex;align-items:center;gap:10px;margin-top:8px;}
.rdo-progress-track{flex:1;height:12px;border-radius:999px;background:#e5e7eb;overflow:hidden;border:1px solid #d1d5db;}
.rdo-progress-fill{height:100%;background:var(--sam-blue);width:0%;}
.rdo-progress-pct{min-width:52px;text-align:right;font-weight:800;color:#0f172a;}


.apr-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.apr-tab{
  border:1px solid var(--border);
  border-radius:999px;
  padding:7px 12px;
  background:#fff;
  cursor:pointer;
  font-size:11px;
}
.apr-tab.active{background:var(--sam-blue);border-color:var(--sam-blue);color:#fff;}
.apr-sub{display:none;margin-top:10px;}
.apr-sub.active{display:block;}
.apr-etapa{
  border:1px solid var(--border);
  border-radius:16px;
  padding:10px;
  background:linear-gradient(145deg,#fff,#f7fbff);
}
.apr-etapa-head{
  display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
  margin-bottom:8px;
}
.apr-etapa-title{
  font-weight:900;color:#003b5c;font-size:12px;
}
.apr-etapa-grid{
  display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;
}
@media (max-width:980px){ .apr-etapa-grid{grid-template-columns:1fr;} }


.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.48);display:none;align-items:center;justify-content:center;z-index:999;}
.modal{background:#fff;border-radius:18px;max-width:880px;width:94%;max-height:90vh;overflow:auto;padding:14px;box-shadow:0 22px 60px rgba(0,0,0,.35);position:relative;}
.modal-close{position:absolute;right:12px;top:8px;font-size:22px;cursor:pointer;}
hr{border:none;border-top:1px solid #e7ecf5;margin:10px 0;}

@media (max-width:980px){
  .main{flex-direction:column;}
  .sidebar{
    width:100%;
    border-right:none;border-bottom:1px solid var(--border);
    flex-direction:row;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    gap:6px;
    padding:10px 10px 8px;
    position:sticky;top:64px;z-index:40; /* acompanha rolagem */
  }
  .nav-group,.sidebar-footer{display:none;}
  .nav-btn{padding:10px 12px;}
}

/* ====== ADD (v4 modules) ====== */
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr));}
@media (max-width:980px){.grid-4{grid-template-columns:1fr;}}
.tag{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:10px;font-weight:800}
.t-estoque{background:#f0f9ff;color:#0369a1;}
.t-treinamento{background:#f0fdf4;color:#15803d;}
.t-residuo{background:#fefce8;color:#ca8a04;}
.t-saude{background:#fdf2f8;color:#be185d;}
.t-aso{background:#f5f3ff;color:#7c3aed;}
.t-rdo{background:#ecfeff;color:#0e7490;}
.status-badge{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:bold;}
.status-ativo{background:#dcfce7;color:#166534;}
.status-vencido{background:#fee2e2;color:#991b1b;}
.status-alerta{background:#fef3c7;color:#92400e;}
.status-pendente{background:#e0f2fe;color:#0369a1;}
.assinatura-canvas{border:2px dashed #ccc;border-radius:10px;background:#f9f9f9;cursor:crosshair;touch-action:none;}
.assinatura-img{max-width:200px;max-height:80px;border:1px solid #ddd;border-radius:4px;}


/* === APR â€¢ PCRC / BLOQUEIO (v7.1) === */
.apr-tools{border:1px dashed #cbd5e1;border-radius:16px;padding:12px;background:linear-gradient(180deg,#ffffff, #f8fafc);} 
.apr-tools-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.apr-tools-title{font-weight:900;color:var(--sam-blue);}
.apr-tools-actions{display:flex;gap:8px;flex-wrap:wrap;}
.apr-tools-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.apr-tool-tab{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;}
.apr-tool-tab.active{background:var(--sam-blue);color:#fff;border-color:var(--sam-blue);}
.apr-tool-panel{display:none;margin-top:8px;}
.apr-tool-panel.active{display:block;}
.pcrc-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.pcrc-col{border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#fff;}
.pcrc-col-title{font-weight:900;color:#0f172a;margin-bottom:6px;}
.pcrc-list{display:grid;gap:6px;}
.pcrc-item{display:flex;gap:8px;align-items:flex-start;padding:6px 8px;border-radius:10px;border:1px solid #eef2f7;background:#f8fafc;}
.pcrc-item input{margin-top:3px;}
.pcrc-item .crit{color:#b91c1c;font-weight:900;}
.bloq-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:12px;}
.bloq-card{border:1px solid #e5e7eb;border-radius:14px;padding:10px;background:#fff;}
.bloq-title{font-weight:900;color:#0f172a;margin-bottom:8px;}
.bloq-list{display:grid;gap:6px;}
@media (max-width: 900px){
  .pcrc-grid{grid-template-columns:1fr;}
  .bloq-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app-shell">
<header class="header">
<div class="header-left">
<div class="logo">CONTERPLAN</div>
<div class="title-wrap">
<div class="title">CONTERPLAN â€“ SGI / APR</div>
<div class="subtitle">SeguranÃ§a Â· Meio Ambiente Â· Acidentes Â· EvidÃªncias Â· APR ()</div>
</div>
</div>
<div class="header-right">
<div id="hoje"></div>
<div class="pill" title="Status de sincronizaÃ§Ã£o">
<span class="dot off" id="dotSync"></span>
<span id="txtSync">Offline</span>
</div>
</div>
</header>
<div class="main">
<nav class="sidebar" id="sidebar">
<div class="nav-group">VisÃ£o</div>
<button class="nav-btn active" data-sec="sec-dashboard"><span class="icon">ğŸ“Š</span>Dashboard</button>
<div class="nav-group">Registros</div>
<button class="nav-btn" data-sec="sec-acidente"><span class="icon">ğŸ©º</span>Acidente / LesÃ£o</button>
<button class="nav-btn" data-sec="sec-nc"><span class="icon">âš ï¸</span>NÃ£o Conformidade</button>
<button class="nav-btn" data-sec="sec-ambiental"><span class="icon">ğŸŒ±</span>Ambiental</button>
<button class="nav-btn" data-sec="sec-evidencias"><span class="icon">ğŸ“·</span>EvidÃªncias</button>
<button class="nav-btn" data-sec="sec-apr"><span class="icon">ğŸ“</span>APR</button>
<div class="nav-group">Controles EspecÃ­ficos</div>
<button class="nav-btn" data-sec="sec-estoque"><span class="icon">ğŸ“¦</span>Controle de Estoque</button>
<button class="nav-btn" data-sec="sec-treinamentos"><span class="icon">ğŸ“</span>Treinamentos</button>
<button class="nav-btn" data-sec="sec-residuos"><span class="icon">ğŸ—‘ï¸</span>DestinaÃ§Ã£o ResÃ­duos</button>
<button class="nav-btn" data-sec="sec-saude"><span class="icon">ğŸ¥</span>SaÃºde Ocupacional</button>
<button class="nav-btn" data-sec="sec-aso"><span class="icon">ğŸ“‹</span>Controle de ASO</button>
<button class="nav-btn" data-sec="sec-engenharia"><span class="icon">ğŸ—ï¸</span>Engenharia / RDO</button>
<button class="nav-btn" data-sec="sec-banco-controles"><span class="icon">ğŸ—„ï¸</span>Banco - Controles</button>
<div class="nav-group">GestÃ£o</div>
<button class="nav-btn" data-sec="sec-banco"><span class="icon">ğŸ“š</span>Banco de Dados</button>
<button class="nav-btn" data-sec="sec-relatorios"><span class="icon">ğŸ“„</span>RelatÃ³rios</button>
<button class="nav-btn" data-sec="sec-config"><span class="icon">âš™ï¸</span>Config</button>
<div class="sidebar-footer">
        Modo <b>Offline</b> com sincronizaÃ§Ã£o opcional (Supabase).<br/>
        QR Code + PDF + WhatsApp + E-mail.
      </div>
</nav>
<main class="content" id="content">
<!-- DASHBOARD -->
<section class="section active" id="sec-dashboard">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“Š VisÃ£o Geral</div>
<div class="card-sub">Indicadores do mÃªs (filtros por perÃ­odo no Banco de Dados).</div>
</div>
<span class="badge" id="badgeMesAtual">MÃªs atual</span>
</div>
<div class="grid grid-3">
<div class="kpi">
<div class="kpi-label">Total de registros (mÃªs)</div>
<div class="kpi-value" id="kpiTotalMes">0</div>
<div class="kpi-sub" id="kpiTotalMesSub">â€“</div>
</div>
<div class="kpi">
<div class="kpi-label">Acidentes (mÃªs)</div>
<div class="kpi-value" id="kpiAcidentesMes">0</div>
<div class="kpi-sub" id="kpiAcidentesMesSub">0 com lesÃ£o Â· 0 sem perda</div>
</div>
<div class="kpi">
<div class="kpi-label">TF / TG</div>
<div class="kpi-value" id="kpiTF">â€“</div>
<div class="kpi-sub" id="kpiTG">Taxa de frequÃªncia / gravidade (1.000.000 hâ€‘h)</div>
</div>
</div>
</div>
<div class="grid grid-2">
<div class="card chart-card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“ˆ OcorrÃªncias por tipo</div>
<div class="card-sub">Acidente Â· NC Â· Ambiental Â· EvidÃªncia Â· APR</div>
</div>
</div>
<canvas id="chartTipos"></canvas>
</div>
<div class="card chart-card">
<div class="card-header">
<div>
<div class="card-title">ğŸ­ Ranking de setores</div>
<div class="card-sub">Top 5 do mÃªs (acidentes e NC)</div>
</div>
</div>
<canvas id="chartSetores"></canvas>
</div>
</div>
<div class="grid grid-2">
<div class="card chart-card">
<div class="card-header">
<div>
<div class="card-title">ğŸ©¹ Com perda x Sem perda</div>
<div class="card-sub">Acidentes do mÃªs</div>
</div>
</div>
<canvas id="chartPerda"></canvas>
</div>
<div class="card chart-card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“ APR por macroÃ¡rea</div>
<div class="card-sub">Obras Â· Acessos Â· Estradas Â· Drenagem</div>   
</div>
</div>
<canvas id="chartAprMacro"></canvas>
</div>
</div>
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ§© Matriz de AvaliaÃ§Ã£o de Riscos</div>
<div class="card-sub">Probabilidade x Impacto (visual). Para cÃ¡lculo automÃ¡tico, use o â€œCalculadorâ€ abaixo.</div>
</div>
<span class="badge">RP Â· RM Â· RA Â· RC</span>
</div>
<div style="overflow:auto;border:1px solid var(--border);border-radius:14px;">
<table style="width:100%;border-collapse:collapse;font-size:11px;">
<tr>
<th rowspan="2" style="background:var(--sam-blue);color:#fff;padding:8px;border:1px solid #e5e7eb;">Probabilidade</th>
<th colspan="5" style="background:var(--sam-blue);color:#fff;padding:8px;border:1px solid #e5e7eb;">Impacto</th>
</tr>
<tr>
<th style="padding:8px;border:1px solid #e5e7eb;background:#f8fafc;">Muito Baixo<br/>1</th>
<th style="padding:8px;border:1px solid #e5e7eb;background:#f8fafc;">Baixo<br/>2</th>
<th style="padding:8px;border:1px solid #e5e7eb;background:#f8fafc;">MÃ©dio<br/>3</th>
<th style="padding:8px;border:1px solid #e5e7eb;background:#f8fafc;">Alto<br/>4</th>
<th style="padding:8px;border:1px solid #e5e7eb;background:#f8fafc;">Muito Alto<br/>5</th>
</tr>
<tr>
<td style="padding:8px;border:1px solid #e5e7eb;background:#eff6ff;font-weight:800;">5 â€“ Praticamente certo</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="ra" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RA</td>
<td class="ra" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RA</td>
<td class="rc" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RC</td>
<td class="rc" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RC</td>
</tr>
<tr>
<td style="padding:8px;border:1px solid #e5e7eb;background:#eff6ff;font-weight:800;">4 â€“ Muito provÃ¡vel</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="ra" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RA</td>
<td class="ra" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RA</td>
<td class="rc" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RC</td>
</tr>
<tr>
<td style="padding:8px;border:1px solid #e5e7eb;background:#eff6ff;font-weight:800;">3 â€“ ProvÃ¡vel</td>
<td class="rp" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RP</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="ra" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RA</td>
<td class="ra" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RA</td>
</tr>
<tr>
<td style="padding:8px;border:1px solid #e5e7eb;background:#eff6ff;font-weight:800;">2 â€“ Pouco provÃ¡vel</td>
<td class="rp" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RP</td>
<td class="rp" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RP</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="ra" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RA</td>
</tr>
<tr>
<td style="padding:8px;border:1px solid #e5e7eb;background:#eff6ff;font-weight:800;">1 â€“ Raro</td>
<td class="rp" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RP</td>
<td class="rp" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RP</td>
<td class="rp" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RP</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
<td class="rm" style="padding:8px;border:1px solid #e5e7eb;text-align:center;font-weight:900;">RM</td>
</tr>
</table>
</div>
<div class="grid grid-3" style="margin-top:10px;">
<div>
<label>Probabilidade</label>
<select class="input" id="calcProb">
<option value="">Selecioneâ€¦</option>
<option value="1">1 â€“ Raro</option>
<option value="2">2 â€“ Pouco provÃ¡vel</option>
<option value="3">3 â€“ ProvÃ¡vel</option>
<option value="4">4 â€“ Muito provÃ¡vel</option>
<option value="5">5 â€“ Praticamente certo</option>
</select>
</div>
<div>
<label>Impacto</label>
<select class="input" id="calcImp">
<option value="">Selecioneâ€¦</option>
<option value="1">1 â€“ Muito baixo</option>
<option value="2">2 â€“ Baixo</option>
<option value="3">3 â€“ MÃ©dio</option>
<option value="4">4 â€“ Alto</option>
<option value="5">5 â€“ Muito alto</option>
</select>
</div>
<div>
<label>Resultado</label>
<div class="input" id="calcRes" style="display:flex;align-items:center;gap:8px;font-weight:900;">
                â€”
              </div>
<div class="small">Este resultado pode ser salvo nos registros (Acidente/NC/Amb/APR).</div>
</div>
</div>
</div>

<div class="card" style="margin-top:14px;">
<div class="card-header" style="padding:10px 12px;">
<div>
<div class="card-title" style="font-size:14px;">ğŸ“Š Dashboard â€” Controles</div>
<div class="card-sub">Resumo rÃ¡pido dos mÃ³dulos de controles</div>
</div>
</div>
<div style="padding:12px 12px;">
<div class="kpi-grid">
<div class="kpi"><div class="k">ğŸ“¦ Estoque</div><div class="v" id="kpiDashEstoque">0</div><div class="s">itens cadastrados</div></div>
<div class="kpi"><div class="k">ğŸ“ Treinamentos</div><div class="v" id="kpiDashTrein">0</div><div class="s">registros</div></div>
<div class="kpi"><div class="k">ğŸ¥ SaÃºde</div><div class="v" id="kpiDashSaude">0</div><div class="s">registros</div></div>
<div class="kpi"><div class="k">ğŸ“‹ ASO</div><div class="v" id="kpiDashASO">0</div><div class="s">registros</div></div>
<div class="kpi"><div class="k">ğŸ—’ï¸ RDO</div><div class="v" id="kpiDashRDO">0</div><div class="s">registros</div></div>
</div>
<div style="height:220px; margin-top:10px;">
<canvas id="chartDashControles"></canvas>
</div>
</div>
</div>

    <div class="grid-2" style="margin-top:12px">
      <div class="card chart-card">
        <div class="card-title">NÃ£o Conformidades â€” Em aberto x Atendidas</div>
        <div class="muted" style="margin-top:2px">"Atendida" = status <b>ConcluÃ­do</b> (com evidÃªncia anexada).</div>
        <div style="height:260px;margin-top:8px">
          <canvas id="chartNCStatus"></canvas>
        </div>
      </div>
      <div class="card chart-card">
        <div class="card-title">Pareto â€” Tipos de NÃ£o Conformidade</div>
        <div class="muted" style="margin-top:2px">Contagem por tipo + % acumulado (estilo Minitab).</div>
        <div style="height:260px;margin-top:8px">
          <canvas id="chartNCPareto"></canvas>
        </div>
      </div>
    </div>

</section>
<!-- ACIDENTE -->
<section class="section" id="sec-acidente">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ©º Registro de Acidente / LesÃ£o</div>
<div class="card-sub">Campos alinhados para evidenciar CAT, perda e classificaÃ§Ã£o por matriz.</div>
</div>
<span class="badge">Modelo â€œAcidente com lesÃ£oâ€ no PDF</span>
</div>

<div class="form-grid">
<div>
<label>Data do acidente</label>
<input class="input" id="acData" type="date"/>
</div>
<div>
<label>Hora (opcional)</label>
<input class="input" id="acHora" type="time"/>
</div>
<div>
<label>Turno</label>
<select class="input" id="acTurno">
<option value="">Selecioneâ€¦</option>
<option>D</option><option>N</option><option>C</option>
</select>
</div>
<div>
<label>Setor / Ãrea</label>
<input class="input" id="acSetor" placeholder="Ex.: Pilha , Oficina, Geralâ€¦"/>
</div>
<div>
<label>Nome do colaborador</label>
<input class="input" id="acNome" placeholder="Nome completo"/>
</div>
<div>
<label>FunÃ§Ã£o</label>
<input class="input" id="acFuncao"/>
</div>
<div>
<label>CPF</label>
<input class="input" id="acCPF" placeholder="Somente nÃºmeros"/>
</div>
<div>
<label>Chefe imediato</label>
<input class="input" id="acChefe"/>
</div>
<div>
<label>Local do acidente</label>
<input class="input" id="acLocal" placeholder="Local exato / referÃªncia"/>
</div>
<div>
<label>Tipo de ocorrÃªncia</label>
<select class="input" id="acTipo">
<option value="">Selecioneâ€¦</option>
<option value="com_lesao">Acidente com lesÃ£o</option>
<option value="sem_lesao">Acidente sem lesÃ£o (sem perda)</option>
<option value="quase">Quase acidente</option>
</select>
</div>
<div>
<label>Abertura de CAT</label>
<select class="input" id="acCAT">
<option value="">Selecioneâ€¦</option>
<option>SIM</option><option>NÃƒO</option>
</select>
</div>
<div>
<label>Perda de tempo</label>
<select class="input" id="acPerda">
<option value="">Selecioneâ€¦</option>
<option value="sem_perda">Sem perda</option>
<option value="restricao">RestriÃ§Ã£o</option>
<option value="afastamento">Com afastamento</option>
</select>
</div>
<div>
<label>Dias perdidos (se houver)</label>
<input class="input" id="acDias" min="0" step="1" type="number"/>
</div>
<div>
<label>ClassificaÃ§Ã£o (matriz)</label>
<select class="input" id="acRisco">
<option value="">Selecioneâ€¦</option>
<option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
<div class="small">Dica: use o calculador da matriz no Dashboard.</div>
</div>
<div>
<label>LesÃ£o / parte do corpo</label>
<input class="input" id="acLesao" placeholder="Ex.: corte na mÃ£o, contusÃ£o joelhoâ€¦"/>
</div>
<div>
<label>Fotos (pode tirar na hora)</label>
<input accept="image/*" capture="environment" class="input" id="acFotos" multiple="" type="file"/>
<div class="small">As fotos ficam salvas no registro e entram no PDF.</div>
</div>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o do ocorrido</label>
<textarea class="input" id="acDesc" placeholder="O que ocorreu, condiÃ§Ãµes, ato/condiÃ§Ã£o insegura, clima, interferÃªnciasâ€¦"></textarea>
</div>
<div style="margin-top:10px;">
<label>Medidas a serem tomadas</label>
<textarea class="input" id="acMedidas" placeholder="AÃ§Ãµes imediatas, corretivas e preventivas, responsÃ¡veis e prazosâ€¦"></textarea>
</div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarAc" type="button">ğŸ’¾ Salvar</button>
<button class="btn btn-outline btn-sm" id="btnLimparAc">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Data</th><th>Colaborador</th><th>Setor</th><th>Tipo</th><th>CAT</th><th>Risco</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbAc"></tbody>
</table>
</div>
</div>
</section>
<!-- NC -->
<section class="section" id="sec-nc">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">âš ï¸ NÃ£o Conformidade</div>
<div class="card-sub">Relacionada a SeguranÃ§a / SaÃºde / Meio Ambiente (SGI).</div>
</div>
<span class="badge">Com evidÃªncia fotogrÃ¡fica</span>
</div>
<div class="form-grid">
<div>
<label>Data</label>
<input class="input" id="ncData" type="date"/>
</div>
<div>
<label>Turno</label>
<select class="input" id="ncTurno">
<option value="">Selecioneâ€¦</option>
<option>D</option><option>N</option><option>C</option>
</select>
</div>
<div>
<label>Ãrea / Setor</label>
<input class="input" id="ncSetor" placeholder="Ex.: Pilha PulmÃ£o, Correias, Oficinaâ€¦"/>
</div>
<div>
<label>Quem identificou</label>
<input class="input" id="ncIdentificou"/>
</div>
<div>
<label>Tipo</label>
<select class="input" id="ncTipo">
<option value="">Selecioneâ€¦</option>
<option>SeguranÃ§a</option>
<option>SaÃºde</option>
<option>Meio Ambiente</option>
<option>Comportamental</option>
<option>Documental</option>
<option>Processo / Procedimento</option>
</select>
</div>
<div>
<label>Status</label>
<select class="input" id="ncStatus">
<option>Aberto</option>
<option>Em andamento</option>
<option>ConcluÃ­do</option>
</select>
</div>
<div>
<label>ClassificaÃ§Ã£o (matriz)</label>
<select class="input" id="ncRisco">
<option value="">Selecioneâ€¦</option>
<option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
</div>
<div>
<label>Fotos</label>
<input accept="image/*" capture="environment" class="input" id="ncFotos" multiple="" type="file"/>
</div>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o</label>
<textarea class="input" id="ncDesc" placeholder="Descreva a nÃ£o conformidade / condiÃ§Ã£o inseguraâ€¦"></textarea>
</div>
<div style="margin-top:10px;">
<label>Medidas a serem tomadas</label>
<textarea class="input" id="ncAcoes" placeholder="Plano de aÃ§Ã£o, responsÃ¡veis, prazosâ€¦"></textarea>
</div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarNC" type="button">ğŸ’¾ Salvar</button>
<button class="btn btn-outline btn-sm" id="btnLimparNC">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Data</th><th>Ãrea</th><th>Tipo</th><th>Status</th><th>Risco</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbNC"></tbody>
</table>
</div>
</div>
</section>
<!-- AMBIENTAL -->
<section class="section" id="sec-ambiental">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸŒ± OcorrÃªncia Ambiental</div>
<div class="card-sub">Vazamento, resÃ­duos, erosÃ£o, fauna/flora, evidÃªncia positiva etc.</div>
</div>
<span class="badge">Antes/Durante/Depois</span>
</div>
<div class="form-grid">
<div>
<label>Data</label>
<input class="input" id="amData" type="date"/>
</div>
<div>
<label>Ãrea / Local</label>
<input class="input" id="amLocal" placeholder="Ex.: GalpÃ£o, acesso, pilhaâ€¦"/>
</div>
<div>
<label>ResponsÃ¡vel</label>
<input class="input" id="amResp"/>
</div>
<div>
<label>Tipo</label>
<select class="input" id="amTipo">
<option value="">Selecioneâ€¦</option>
<option>Vazamento de Ã³leo / fluido</option>
<option>ResÃ­duos / entulho</option>
<option>ErosÃ£o / talude</option>
<option>Limpeza preventiva</option>
<option>Fauna / flora</option>
<option>Outro / evidÃªncia positiva</option>
</select>
</div>
<div>
<label>ClassificaÃ§Ã£o (matriz)</label>
<select class="input" id="amRisco">
<option value="">Selecioneâ€¦</option>
<option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
</div>
<div>
<label>Fotos</label>
<input accept="image/*" capture="environment" class="input" id="amFotos" multiple="" type="file"/>
</div>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o</label>
<textarea class="input" id="amDesc"></textarea>
</div>
<div style="margin-top:10px;">
<label>Medidas adotadas / a serem tomadas</label>
<textarea class="input" id="amMed"></textarea>
</div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarAM" type="button">ğŸ’¾ Salvar</button>
<button class="btn btn-outline btn-sm" id="btnLimparAM">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Data</th><th>Local</th><th>Tipo</th><th>Risco</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbAM"></tbody>
</table>
</div>
</div>
</section>
<!-- EVIDÃŠNCIAS -->
<section class="section" id="sec-evidencias">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“· EvidÃªncias â€“ Antes x Depois</div>
<div class="card-sub">Para comprovar aÃ§Ãµes de SeguranÃ§a e Meio Ambiente (com fotos e textos).</div>
</div>
<span class="badge">Arquivo visual</span>
</div>
<div class="form-grid">
<div>
<label>TÃ­tulo</label>
<input class="input" id="evTitulo" placeholder="Ex.: Limpeza ao redor do galpÃ£o"/>
</div>
<div>
<label>Data</label>
<input class="input" id="evData" type="date"/>
</div>
<div>
<label>Ãrea / Setor</label>
<input class="input" id="evArea"/>
</div>
<div>
<label>ResponsÃ¡vel</label>
<input class="input" id="evResp"/>
</div>
<div>
<label>Fotos ANTES</label>
<input accept="image/*" capture="environment" class="input" id="evAntes" multiple="" type="file"/>
</div>
<div>
<label>Fotos DEPOIS</label>
<input accept="image/*" capture="environment" class="input" id="evDepois" multiple="" type="file"/>
</div>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o (antes)</label>
<textarea class="input" id="evDescAntes"></textarea>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o (depois)</label>
<textarea class="input" id="evDescDepois"></textarea>
</div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarEV" type="button">ğŸ’¾ Salvar</button>
<button class="btn btn-outline btn-sm" id="btnLimparEV">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Data</th><th>TÃ­tulo</th><th>Ãrea</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbEV"></tbody>
</table>
</div>
</div>
</section>
<!-- APR -->
<section class="section" id="sec-apr">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“ APR â€“ AnÃ¡lise Preliminar de Risco</div>
<div class="card-sub">Estrutura com prÃ©-filtros por macroÃ¡rea: Acesso, Barragem, Vias e Geral. (CONTERPLAN â†’ CONTERPLAN)</div>
</div>
<span class="badge">Campos + atividades prÃ©â€‘definidas</span>    
</div>
<div class="form-grid">
<div>
<label>Data da APR</label>
<input class="input" id="aprData" type="date"/>
</div>
<div>
<label>Turno</label>
<select class="input" id="aprTurno">
<option value="">Selecioneâ€¦</option>
<option>D</option><option>N</option><option>C</option>
</select>
</div>
<div>
<label>ResponsÃ¡vel pela APR</label>
<input class="input" id="aprResp" placeholder="Ex.: TÃ©cnico de SeguranÃ§a"/>
</div>
<div>
<label>Equipe / Contrato</label>
<input class="input" id="aprEquipe" placeholder="Ex.: CONTERPLAN / Contratada"/>
</div>
</div>
<div class="apr-tabs">
<button class="apr-tab active" data-tab="Acesso">Acesso</button>
<button class="apr-tab" data-tab="Barragem">Barragem</button>
<button class="apr-tab" data-tab="Vias">Vias</button>
<button class="apr-tab" data-tab="Geral">Geral</button>
</div>
<!-- ACESSO -->
<div class="apr-sub active" id="apr-mina">
<div class="form-grid">
<div>
<label>Ãrea / Frente (Acesso)</label>
<select class="input" id="aprAreaAcesso">
<option value="">Selecioneâ€¦</option>
<option>Acesso 1</option>
<option>Acesso 2</option>
<option>Infraestrutura</option>
<option>UrbanizaÃ§Ã£o</option>
<option>Projeto</option>
<option>Pilha de rejeito</option>
<option>Cava</option>
<option>Apoio</option>
<option>Taludes</option>
<option>Procedimento</option>
<option>Obras-Geral</option>
</select>
</div>
<div>
<label>CondiÃ§Ãµes climÃ¡ticas</label>
<select class="input" id="aprClimaMina">
<option value="">Selecioneâ€¦</option>
<option>Tempo seco / normal</option>
<option>Chuva leve</option>
<option>Chuva forte</option>
<option>Neblina / visibilidade reduzida</option>
</select>
</div>
<div>
<label>Tipo de material</label>
<select class="input" id="aprMatMina">
<option value="">Selecioneâ€¦</option>
<option>ROMminÃ©rio</option>
<option>ROM estÃ©ril</option>
<option>Rejeito filtrado</option>
<option>Solo / argila</option>
</select>
</div>
<div>
<label>ClassificaÃ§Ã£o (matriz)</label>
<select class="input" id="aprRiscoMina">
<option value="">Selecioneâ€¦</option><option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
</div>
</div>
<div style="margin-top:8px;">
<label>Atividades principais envolvidas (Mina)</label>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
<button class="btn btn-attn btn-sm" id="btnTaludeMina" type="button">â›°ï¸ Checklist Talude â€” PrioritÃ¡rio</button>
</div>
<div class="chips" id="chipsMina">
<div class="chip" data-v="caminhao">CaminhÃ£o foraâ€‘deâ€‘estrada</div>
<div class="chip" data-v="carregadeira">Carregadeira</div>
<div class="chip" data-v="trator">Trator (esteira/pneus)</div>
<div class="chip" data-v="patrol">Patrol / motoniveladora</div>
<div class="chip" data-v="pilha">Pilha pulmÃ£o / cÃ´nica (120 t)</div>
<div class="chip" data-v="lokotrack">Lokotrack / britagem mÃ³vel</div>
<div class="chip" data-v="acesso">Acesso escorregadio / rampa</div>
<div class="chip" data-v="clima">OperaÃ§Ã£o sob chuva / neblina</div>
<div class="chip" data-v="talude">AvaliaÃ§Ã£o de talude (crista/pÃ©/altura)</div>
</div>
<div class="small">Clique para selecionar. VocÃª pode complementar com texto abaixo.</div>
</div>
</div>
<!-- BARRAGEM -->
<div class="apr-sub" id="apr-eixo1">
<div class="form-grid">
<div>
<label>Ãrea / Barragem</label>
<select class="input" id="aprBarragem">
<option value="">Selecioneâ€¦</option>
<option>Dique / talude principal</option>
<option>Talude interno</option>
<option>Corpo da barragem</option>
<option>Patamar de serviÃ§os</option>
<option>Canaleta / drenagem</option>
<option>Ãrea de alteamento</option>
<option>Outra frente do Eixo 1</option>
</select>
</div>
<div>
<label>CondiÃ§Ãµes climÃ¡ticas</label>
<select class="input" id="aprClimaEixo1">
<option value="">Selecioneâ€¦</option>
<option>Tempo seco / normal</option>
<option>Chuva leve</option>
<option>Chuva forte</option>
<option>Neblina / visibilidade reduzida</option>
</select>
</div>
<div>
<label>SituaÃ§Ã£o geotÃ©cnica</label>
<select class="input" id="aprGeoEixo1">
<option value="">Selecioneâ€¦</option>
<option>Ãrea liberada por geotecnia</option>
<option>Ãrea com restriÃ§Ã£o</option>
<option>Ãrea em monitoramento</option>
</select>
</div>
<div>
<label>ClassificaÃ§Ã£o (matriz)</label>
<select class="input" id="aprRiscoEixo1">
<option value="">Selecioneâ€¦</option><option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
</div>
</div>
<div style="margin-top:8px;">
<label>Atividades principais (Eixo 1)</label>
<div class="chips" id="chipsEixo1">
<div class="chip" data-v="caminhao">TrÃ¡fego de caminhÃµes</div>
<div class="chip" data-v="carregadeira">Carregadeira / escavadeira</div>
<div class="chip" data-v="trator">Trator</div>
<div class="chip" data-v="patrol">Patrol</div>
<div class="chip" data-v="drenagem">Drenagem / canaletas</div>
<div class="chip" data-v="alteamento">Alteamento / conformaÃ§Ã£o</div>
<div class="chip" data-v="acesso">Acesso escorregadio</div>
<div class="chip" data-v="clima">OperaÃ§Ã£o sob chuva/neblina</div>
</div>
</div>
</div>
<!-- PDE -->
<div class="apr-sub" id="apr-pdesul">
<div class="form-grid">
<div>
<label>Ãrea / Frente (Vias)</label>
<select class="input" id="aprVias">
<option value="">Selecioneâ€¦</option>
<option>Pilha de estÃ©ril</option>
<option>Pilha de rejeito filtrado</option>
<option>Acesso / rampa</option>
<option>PÃ¡tio / manobra</option>
<option>Drenagem / canaletas</option>
<option>Outra frente PDE</option>
</select>
</div>
<div>
<label>CondiÃ§Ã£o do acesso</label>
<select class="input" id="aprAcessoPde">
<option value="">Selecioneâ€¦</option>
<option>Bom</option>
<option>Escorregadio</option>
<option>Com buracos</option>
<option>Visibilidade reduzida</option>
</select>
</div>
<div>
<label>CondiÃ§Ãµes climÃ¡ticas</label>
<select class="input" id="aprClimaPde">
<option value="">Selecioneâ€¦</option>
<option>Tempo seco / normal</option>
<option>Chuva leve</option>
<option>Chuva forte</option>
<option>Neblina / visibilidade reduzida</option>
</select>
</div>
<div>
<label>ClassificaÃ§Ã£o (matriz)</label>
<select class="input" id="aprRiscoPde">
<option value="">Selecioneâ€¦</option><option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
</div>
</div>
<div style="margin-top:8px;">
<label>Atividades principais (Vias)</label>
<div class="chips" id="chipsPde">
<div class="chip" data-v="caminhao">TrÃ¡fego de caminhÃµes</div>
<div class="chip" data-v="carregadeira">Carregadeira</div>
<div class="chip" data-v="trator">Trator</div>
<div class="chip" data-v="patrol">Patrol</div>
<div class="chip" data-v="pilha">OperaÃ§Ã£o em pilhas</div>
<div class="chip" data-v="drenagem">Drenagem</div>
<div class="chip" data-v="acesso">Acesso escorregadio</div>
<div class="chip" data-v="clima">OperaÃ§Ã£o sob chuva/neblina</div>
</div>
</div>
</div>
<!-- GERAL -->
<div class="apr-sub" id="apr-usina">
<div class="form-grid">
<div>
<label>Ãrea / Setor (Geral)</label>
<select class="input" id="aprGeral">
<option value="">Selecioneâ€¦</option>
<option>Britagem</option>
<option>Correias / TransferÃªncias</option>
<option>Moegas / Alimentadores</option>
<option>Ãrea de manutenÃ§Ã£o</option>
<option>TrÃ¡fego interno / pÃ¡tio</option>
<option>Outro</option>
</select>
</div>
<div>
<label>CondiÃ§Ã£o operacional</label>
<select class="input" id="aprCondUsina">
<option value="">Selecioneâ€¦</option>
<option>OperaÃ§Ã£o normal</option>
<option>OperaÃ§Ã£o reduzida</option>
<option>Parada / bloqueio</option>
<option>IntervenÃ§Ã£o / manutenÃ§Ã£o</option>
</select>
</div>
<div>
<label>CondiÃ§Ãµes climÃ¡ticas</label>
<select class="input" id="aprClimaUsina">
<option value="">Selecioneâ€¦</option>
<option>Tempo seco / normal</option>
<option>Chuva leve</option>
<option>Chuva forte</option>
<option>Neblina / visibilidade reduzida</option>
</select>
</div>
<div>
<label>ClassificaÃ§Ã£o (matriz)</label>
<select class="input" id="aprRiscoUsina">
<option value="">Selecioneâ€¦</option><option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
</div>
</div>
<div style="margin-top:8px;">
<label>Atividades principais (Usina)</label>
<div class="chips" id="chipsUsina">
<div class="chip" data-v="bloqueio">Bloqueio/ET</div>
<div class="chip" data-v="trabalho_altura">Trabalho em altura</div>
<div class="chip" data-v="espaco_confinado">EspaÃ§o confinado</div>
<div class="chip" data-v="energia">Energias perigosas</div>
<div class="chip" data-v="limpeza">Limpeza de correias/transferÃªncias</div>
<div class="chip" data-v="guindaste">IÃ§amento/guindaste</div>
<div class="chip" data-v="trafego">TrÃ¡fego interno</div>
<div class="chip" data-v="poeira">Poeira/ruÃ­do</div>
</div>
</div>
</div>
<div style="margin-top:10px;">
<div style="margin-top:12px;">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
<div>
<div style="font-weight:900;color:var(--sam-blue);">ğŸ§± Etapas da atividade (organizado)</div>
<div class="small">Use o botÃ£o para adicionar etapas. Cada etapa ajuda a organizar o que seria texto livre.</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-outline btn-sm" id="btnAddEtapa" type="button">â• Adicionar etapa</button>
<button class="btn btn-outline btn-sm" id="btnLimparEtapas" type="button">ğŸ§¹ Limpar etapas</button>
</div>
</div>
<div id="aprEtapas" style="margin-top:10px;display:grid;gap:10px;"></div>
</div>
<label>Perigos / ConsequÃªncias / Controles (texto livre)</label>
<textarea class="input" id="aprTexto" placeholder="Ex.: risco de tombamento em acesso escorregadio; controles: inspeÃ§Ã£o do acesso, limite de velocidade, sinalizaÃ§Ã£o, comunicaÃ§Ã£o via rÃ¡dio, checklist, etc."></textarea>
</div>

<!-- APR â€¢ PCRC / BLOQUEIO (acrÃ©scimo v7.1) -->
<div class="apr-tools" style="margin-top:12px;">
  <div class="apr-tools-head">
    <div>
      <div class="apr-tools-title">ğŸ“‹ PCRC e Checklist de Bloqueio</div>
      <div class="small">Selecione a PCRC para marcar riscos e medidas de controle (X). Para atividade de bloqueio, use o checklist especÃ­fico.</div>
    </div>
    <div class="apr-tools-actions">
      <button class="btn btn-outline btn-sm" id="btnPdfPcrc" type="button">ğŸ“„ PDF (PCRC)</button>
      <button class="btn btn-outline btn-sm" id="btnPdfBloq" type="button">ğŸ“„ PDF (Bloqueio)</button>
    </div>
  </div>

  <div class="apr-tools-tabs">
    <button class="apr-tool-tab active" data-tool="pcrc" type="button">ğŸ§© PCRC â€¢ Riscos & Controles</button>
    <button class="apr-tool-tab" data-tool="bloqueio" type="button">ğŸ”’ Bloqueio â€¢ Checklist</button>
    <button class="apr-tool-tab" data-tool="epi" type="button">ğŸ§¤ EPIs & SaÃºde</button>
  </div>

  <div class="apr-tool-panel active" id="apr-tool-pcrc">
    <div class="form-grid" style="margin-top:10px;">
      <div>
        <label>PCRC *</label>
        <select class="input" id="pcrcSelect">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div>
        <label>ObservaÃ§Ã£o (opcional)</label>
        <input class="input" id="pcrcObs" placeholder="Ex.: atividade especÃ­fica, frente, restriÃ§Ãµes, etc."/>
      </div>
    </div>

    <div class="pcrc-grid" style="margin-top:10px;">
      <div class="pcrc-col">
        <div class="pcrc-col-title">âš ï¸ Riscos</div>
        <div id="pcrcRiscos" class="pcrc-list"></div>
        <label style="margin-top:10px;">Outros riscos (se necessÃ¡rio)</label>
        <textarea class="input" id="pcrcRiscosOutros" placeholder="Digite aqui..." style="min-height:70px;"></textarea>
      </div>
      <div class="pcrc-col">
        <div class="pcrc-col-title">ğŸ›¡ï¸ Medidas de controle</div>
        <div id="pcrcControles" class="pcrc-list"></div>
        <label style="margin-top:10px;">Outras medidas (se necessÃ¡rio)</label>
        <textarea class="input" id="pcrcControlesOutros" placeholder="Digite aqui..." style="min-height:70px;"></textarea>
      </div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <div style="font-weight:900;color:var(--sam-blue);margin-bottom:6px;">ğŸ“š PCRCs selecionadas (podem ser vÃ¡rias)</div>
    <div class="small" style="margin-bottom:10px;">Cada PCRC adicionada fica aberta para vocÃª marcar/desmarcar quando precisar.</div>
    <div id="pcrcMultiContainer" style="display:grid;gap:12px;"></div>
  </div>


  <div class="apr-tool-panel" id="apr-tool-bloqueio">
    <div class="small" style="margin-top:10px;">Preencha o checklist conforme a efetivaÃ§Ã£o do bloqueio/ET. Se algum item nÃ£o estiver conforme, a atividade nÃ£o deve iniciar.</div>

    <div class="bloq-grid" style="margin-top:10px;">
      <div class="bloq-card">
        <div class="bloq-title">ğŸ”’ Check-list de verificaÃ§Ã£o da efetividade do bloqueio</div>
        <div class="bloq-list" id="bloqChecklist"></div>
      </div>

      <div class="bloq-card">
        <div class="bloq-title">ğŸ§¾ InformaÃ§Ãµes</div>
        <div class="form-grid">
          <div>
            <label>Local / Equipamento</label>
            <input class="input" id="bloqLocal" placeholder="Ex.: 11LK02 / 11CV07 / Sala elÃ©trica..."/>
          </div>
          <div>
            <label>ResponsÃ¡vel pelo bloqueio</label>
            <input class="input" id="bloqResp" placeholder="Nome"/>
          </div>
          <div>
            <label>Data/Hora</label>
            <input class="input" id="bloqDataHora" placeholder="dd/mm/aaaa hh:mm"/>
          </div>
          <div>
            <label>ObservaÃ§Ã£o</label>
            <input class="input" id="bloqObs" placeholder="Ex.: energia residual, vÃ¡lvula, segunda equipe, etc."/>
          </div>
        </div>
        <label style="margin-top:10px;">DescriÃ§Ã£o (se necessÃ¡rio)</label>
        <textarea class="input" id="bloqDescricao" placeholder="Registro complementar..." style="min-height:90px;"></textarea>
      </div>
    </div>
  

  <div class="apr-tool-panel" id="apr-tool-epi">
    <div class="small" style="margin-top:10px;">Marque os EPIs necessÃ¡rios e, se aplicÃ¡vel, os riscos de saÃºde e seus controles.</div>

    <div class="bloq-grid" style="margin-top:10px;">
      <div class="bloq-card">
        <div class="bloq-title">ğŸ§¤ EPIs â€” Equipamento de ProteÃ§Ã£o Individual</div>
        <div id="epiChecklist" class="pcrc-list" style="grid-template-columns:repeat(2, minmax(0, 1fr));"></div>
        <div style="margin-top:10px;">
          <label>Justificativa (se necessÃ¡rio)</label>
          <input class="input" id="epiJust" placeholder="Ex.: atividade elÃ©trica, produto quÃ­mico, corte, altura, etc."/>
        </div>
      </div>

      <div class="bloq-card">
        <div class="bloq-title">ğŸ©º Riscos de SaÃºde</div>
        <div class="small">Preencha etapas (se necessÃ¡rio) e marque riscos e controles.</div>

        <div style="margin-top:10px;display:grid;gap:12px;">
          <div style="border:1px solid #e3eef7;border-radius:14px;padding:10px;">
            <div style="font-weight:900;color:#003b5c;">ğŸ¦º ExposiÃ§Ã£o a Agentes Ambientais</div>
            <div class="form-grid" style="margin-top:8px;">
              <div>
                <label>Etapas (opcional)</label>
                <textarea class="input" id="saudeAgentesEtapas" placeholder="Descreva as etapas relacionadas..." style="min-height:60px;"></textarea>
              </div>
            </div>
            <div class="pcrc-grid" style="margin-top:10px;">
              <div class="pcrc-col">
                <div class="pcrc-col-title">âš ï¸ Riscos</div>
                <div id="saudeAgentesRiscos" class="pcrc-list"></div>
                <label style="margin-top:10px;">Outros riscos</label>
                <textarea class="input" id="saudeAgentesOutrosRiscos" style="min-height:60px;" placeholder="Digite aqui..."></textarea>
              </div>
              <div class="pcrc-col">
                <div class="pcrc-col-title">ğŸ›¡ï¸ Controles</div>
                <div id="saudeAgentesControles" class="pcrc-list"></div>
                <label style="margin-top:10px;">Outros controles</label>
                <textarea class="input" id="saudeAgentesOutrosControles" style="min-height:60px;" placeholder="Digite aqui..."></textarea>
              </div>
            </div>
          </div>

          <div style="border:1px solid #e3eef7;border-radius:14px;padding:10px;">
            <div style="font-weight:900;color:#003b5c;">ğŸ’ª EsforÃ§o FÃ­sico</div>
            <div class="form-grid" style="margin-top:8px;">
              <div>
                <label>Etapas (opcional)</label>
                <textarea class="input" id="saudeEsforcoEtapas" placeholder="Descreva as etapas relacionadas..." style="min-height:60px;"></textarea>
              </div>
            </div>
            <div class="pcrc-grid" style="margin-top:10px;">
              <div class="pcrc-col">
                <div class="pcrc-col-title">âš ï¸ Riscos</div>
                <div id="saudeEsforcoRiscos" class="pcrc-list"></div>
                <label style="margin-top:10px;">Outros riscos</label>
                <textarea class="input" id="saudeEsforcoOutrosRiscos" style="min-height:60px;" placeholder="Digite aqui..."></textarea>
              </div>
              <div class="pcrc-col">
                <div class="pcrc-col-title">ğŸ›¡ï¸ Controles</div>
                <div id="saudeEsforcoControles" class="pcrc-list"></div>
                <label style="margin-top:10px;">Outros controles</label>
                <textarea class="input" id="saudeEsforcoOutrosControles" style="min-height:60px;" placeholder="Digite aqui..."></textarea>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
</div>



<div style="margin-top:12px;border:1px solid #e3eef7;border-radius:16px;padding:12px;background:#fff;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
    <div>
      <div style="font-weight:900;color:var(--sam-blue);">ğŸ§‘â€ğŸ”§ Executantes (nome, chapa e assinatura)</div>
      <div class="small">Adicione todos os executantes. Cada um pode assinar digitalmente.</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-outline btn-sm" id="btnAddExecutante" type="button">â• Adicionar executante</button>
      <button class="btn btn-outline btn-sm" id="btnLimparExecutantes" type="button">ğŸ§¹ Limpar executantes</button>
    </div>
  </div>
  <div id="aprExecutantes" style="margin-top:10px;display:grid;gap:10px;"></div>
</div>
<div class="form-grid" style="margin-top:10px;">
<div>
<label>Fotos (opcional)</label>
<input accept="image/*" capture="environment" class="input" id="aprFotos" multiple="" type="file"/>
</div>
<div>
<label>Setor / referÃªncia (para ranking)</label>
<input class="input" id="aprSetor" placeholder="Ex.: Mina Norte / Pilha Centro / PDEâ€‘Sulâ€¦"/>
</div>
</div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarAPR" type="button">ğŸ’¾ Salvar APR</button>
<button class="btn btn-outline btn-sm" id="btnLimparAPR">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Data</th><th>Macro</th><th>Ãrea</th><th>Setor</th><th>Risco</th><th>Atividades</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbAPR"></tbody>
</table>
</div>
</div>
</section>
<!-- BANCO -->
<section class="section" id="sec-estoque">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">ğŸ“¦ Estoque / EPIs (mÃ³dulo integrado)</div>
        <div class="card-sub">MÃ³dulo completo (mesmo do arquivo SAMARCO) carregado dentro do sistema, sem alterar APR/Talude e demais abas.</div>
      </div>
      <span class="badge">Integrado</span>
    </div>

    <div style="border:1px solid rgba(148,163,184,.45);border-radius:16px;overflow:hidden;background:#fff;box-shadow:0 10px 30px rgba(15,23,42,0.06);">
      <iframe id="ifrEstoqueSamarco" title="Estoque/EPIs" style="width:100%;height:78vh;min-height:720px;border:0;display:block;background:#fff;"></iframe>
    </div>

    <div class="small" style="margin-top:8px;">
      Dica: se a altura ficar grande no celular, role dentro do mÃ³dulo. Os dados ficam salvos no navegador (localStorage) como antes.
    </div>
  </div>
</section>
<section class="section" id="sec-treinamentos">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“ Treinamentos - Homem Hora</div>
<div class="card-sub">Controle de treinamentos e geraÃ§Ã£o de certificados</div>
</div>
<span class="badge">Certificados AutomÃ¡ticos</span>
</div>
<div class="grid grid-3">
<div class="kpi">
<div class="kpi-label">Total Treinamentos</div>
<div class="kpi-value" id="kpiTotalTreinamentos">0</div>
<div class="kpi-sub" id="kpiHHTreinamentos">HH: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">Vencidos (30 dias)</div>
<div class="kpi-value" id="kpiTreinamentosVencidos">0</div>
<div class="kpi-sub" id="kpiAVencer">A vencer: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">Participantes (MÃªs)</div>
<div class="kpi-value" id="kpiParticipantesMes">0</div>
<div class="kpi-sub" id="kpiTreinamentoTop">â€“</div>
</div>
</div>
<div class="form-grid">
<div>
<label>NR do Treinamento *</label>
<select class="input" id="treinamentoNR" required="">
<option value="">Selecione...</option>
<option value="nr1">NR1 - DisposiÃ§Ãµes Gerais</option>
<option value="nr5">NR5 - CIPA</option>
<option value="nr6">NR6 - EPIs</option>
<option value="nr10">NR10 - SeguranÃ§a em InstalaÃ§Ãµes ElÃ©tricas</option>
<option value="nr12">NR12 - MÃ¡quinas e Equipamentos</option>
<option value="nr18">NR18 - ConstruÃ§Ã£o Civil</option>
<option value="nr25">NR25 - ResÃ­duos Industriais</option>
<option value="nr33">NR33 - EspaÃ§os Confinados</option>
<option value="nr35">NR35 - Trabalho em Altura</option>
<option value="outro">Outro</option>
</select>
</div>
<div id="divOutroTreinamento" style="display:none;">
<label>Nome do Treinamento *</label>
<input class="input" id="treinamentoOutro" placeholder="Especificar..."/>
</div>
<div>
<label>Data do Treinamento *</label>
<input class="input" id="treinamentoData" required="" type="date"/>
</div>
<div>
<label>DuraÃ§Ã£o (horas) *</label>
<input class="input" id="treinamentoDuracao" min="1" required="" type="number" value="8"/>
</div>
<div>
<label>Instrutor *</label>
<input class="input" id="treinamentoInstrutor" placeholder="Nome do instrutor" required=""/>
</div>
<div>
<label>Local *</label>
<input class="input" id="treinamentoLocal" placeholder="Local do treinamento" required=""/>
</div>
</div>
<div style="margin-top:10px;">
<label>Participantes * (um por linha: Nome;CPF;FunÃ§Ã£o)</label>
<textarea class="input" id="treinamentoParticipantes" placeholder="Exemplo:
JoÃ£o Silva;12345678900;Operador
Maria Santos;98765432100;MecÃ¢nico
Pedro Oliveira;45678912300;Eletricista" required="" rows="4"></textarea>
</div>
<div style="margin-top:10px;">
<label>ConteÃºdo ProgramÃ¡tico</label>
<textarea class="input" id="treinamentoConteudo" placeholder="Descreva o conteÃºdo do treinamento..." rows="3"></textarea>
</div>
<div style="margin-top:10px;">
<label>Anexos (Lista de presenÃ§a, fotos, materiais)</label>
<input accept=".pdf,.jpg,.png,.doc,.docx" class="input" id="treinamentoAnexos" multiple="" type="file"/>
</div>
<div style="margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarTreinamento">ğŸ’¾ Salvar Treinamento</button>
<button class="btn btn-success" id="btnGerarCertificados">ğŸ“ Gerar Certificados</button>
<button class="btn btn-outline" id="btnImportarTreinamento">ğŸ“‹ Importar Lista</button>
<button class="btn btn-outline" id="btnPDFTreinamentos">ğŸ“„ PDF Treinamentos</button>
<button class="btn btn-outline" id="btnLimparTreinamento">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:15px;">
<table>
<thead>
<tr>
<th>Data</th>
<th>Treinamento</th>
<th>DuraÃ§Ã£o</th>
<th>Participantes</th>
<th>Instrutor</th>
<th>Validade</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbTreinamentos">
<!-- Dados serÃ£o carregados via JS -->
</tbody>
</table>
</div>
</div>
</section>
<section class="section" id="sec-residuos">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ—‘ï¸ DestinaÃ§Ã£o de ResÃ­duos</div>
<div class="card-sub">Controle de resÃ­duos sÃ³lidos e lÃ­quidos com MTR e CDF</div>
</div>
<span class="badge">Rastreabilidade Total</span>
</div>
<div class="grid grid-3">
<div class="kpi">
<div class="kpi-label">ResÃ­duos (MÃªs)</div>
<div class="kpi-value" id="kpiResiduosMes">0</div>
<div class="kpi-sub" id="kpiPesoTotal">Peso: 0 kg</div>
</div>
<div class="kpi">
<div class="kpi-label">Pendentes</div>
<div class="kpi-value" id="kpiResiduosPendentes">0</div>
<div class="kpi-sub">Aguardando coleta</div>
</div>
<div class="kpi">
<div class="kpi-label">DestinaÃ§Ã£o Correta</div>
<div class="kpi-value" id="kpiDestinacaoCorreta">100%</div>
<div class="kpi-sub">Conformidade</div>
</div>
</div>
<div class="form-grid">
<div>
<label>Tipo de ResÃ­duo *</label>
<select class="input" id="residuoTipo" required="">
<option value="">Selecione...</option>
<option value="solido">ResÃ­duo SÃ³lido</option>
<option value="liquido">ResÃ­duo LÃ­quido (Efluente)</option>
<option value="oleoso">Ã“leo/Lubrificante</option>
<option value="eletronico">EletrÃ´nico</option>
<option value="organico">OrgÃ¢nico</option>
<option value="perigoso">Perigoso/Contaminado</option>
</select>
</div>
<div>
<label>ClassificaÃ§Ã£o *</label>
<select class="input" id="residuoClassificacao" required="">
<option value="">Selecione...</option>
<option value="classe1">Classe I - Perigoso</option>
<option value="classe2a">Classe II A - NÃ£o Inerte</option>
<option value="classe2b">Classe II B - Inerte</option>
</select>
</div>
<div>
<label>Quantidade/Peso (kg) *</label>
<input class="input" id="residuoQuantidade" min="0.1" required="" step="0.1" type="number"/>
</div>
<div>
<label>Volume (litros)</label>
<input class="input" id="residuoVolume" min="0.1" step="0.1" type="number"/>
</div>
<div>
<label>Local de GeraÃ§Ã£o *</label>
<select class="input" id="residuoLocal" required="">
<option value="">Selecione...</option>
<option value="obras_acessos">Obras / Abertura de Acessos</option>
<option value="estradas">ManutenÃ§Ã£o de Estradas / Patrolamento</option>
<option value="drenagem">Drenagem / Bueiros</option>
<option value="terraplenagem">Terraplenagem</option>
<option value="rocada_limpeza">RoÃ§ada / Limpeza de Faixas</option>
<option value="sinalizacao">SinalizaÃ§Ã£o / Apoio de TrÃ¡fego</option>
<option value="base_logistica">Base / LogÃ­stica</option>
<option value="oficina">Oficina</option>
<option value="almoxarifado">Almoxarifado</option>
<option value="administrativo">Administrativo</option>
</select>
</div>
<div>
<label>ResponsÃ¡vel GeraÃ§Ã£o *</label>
<input class="input" id="residuoResponsavel" placeholder="Nome do responsÃ¡vel" required=""/>
</div>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o Detalhada *</label>
<textarea class="input" id="residuoDescricao" placeholder="DescriÃ§Ã£o do resÃ­duo, composiÃ§Ã£o, caracterÃ­sticas, etc..." required="" rows="3"></textarea>
</div>
<div class="form-grid">
<div>
<label>DestinaÃ§Ã£o *</label>
<select class="input" id="residuoDestinacao" required="">
<option value="">Selecione...</option>
<option value="aterro">Aterro Industrial</option>
<option value="reciclagem">Reciclagem</option>
<option value="incineracao">IncineraÃ§Ã£o</option>
<option value="tratamento">Tratamento</option>
<option value="reuso">Reuso</option>
<option value="coprocessamento">Co-processamento</option>
</select>
</div>
<div>
<label>Transportadora</label>
<input class="input" id="residuoTransportadora" placeholder="Nome da transportadora"/>
</div>
<div>
<label>Placa do VeÃ­culo</label>
<input class="input" id="residuoPlaca" placeholder="AAA1A11"/>
</div>
<div>
<label>Data Coleta</label>
<input class="input" id="residuoDataColeta" type="date"/>
</div>
</div>
<div style="margin-top:10px;">
<label>NÂº MTR / DocumentaÃ§Ã£o</label>
<input class="input" id="residuoMTR" placeholder="NÃºmero do Manifesto"/>
</div>
<div class="form-grid" style="margin-top:10px;">
<div>
<label>Anexar MTR</label>
<input accept=".pdf,.jpg,.png" class="input" id="residuoAnexoMTR" type="file"/>
</div>
<div>
<label>Anexar CDF</label>
<input accept=".pdf,.jpg,.png" class="input" id="residuoAnexoCDF" type="file"/>
</div>
<div>
<label>Anexar Fotos</label>
<input accept="image/*" class="input" id="residuoAnexoFotos" multiple="" type="file"/>
</div>
</div>
<div style="margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarResiduo">ğŸ’¾ Salvar Registro</button>
<button class="btn btn-success" id="btnGerarMTR">ğŸ“„ Gerar MTR</button>
<button class="btn btn-warning" id="btnAgendarColeta">ğŸ“… Agendar Coleta</button>
<button class="btn btn-outline" id="btnPDFResiduos">ğŸ“„ PDF ResÃ­duos</button>
<button class="btn btn-outline" id="btnLimparResiduo">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:15px;">
<table>
<thead>
<tr>
<th>Data</th>
<th>Tipo</th>
<th>ClassificaÃ§Ã£o</th>
<th>Quantidade</th>
<th>Local</th>
<th>DestinaÃ§Ã£o</th>
<th>Status</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbResiduos">
<!-- Dados serÃ£o carregados via JS -->
</tbody>
</table>
</div>
</div>
</section>
<section class="section" id="sec-saude">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ¥ SaÃºde Ocupacional</div>
<div class="card-sub">Controle de exames ocupacionais e fichas de registro</div>
</div>
<span class="badge">IntegraÃ§Ã£o ASO</span>
</div>
<div class="grid grid-4">
<div class="kpi">
<div class="kpi-label">Colaboradores</div>
<div class="kpi-value" id="kpiColaboradoresTotal">0</div>
<div class="kpi-sub" id="kpiColaboradoresAtivos">Ativos: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">ASOs Vencidos</div>
<div class="kpi-value" id="kpiASOsVencidosSaude">0</div>
<div class="kpi-sub" id="kpiASOsAVencerSaude">A vencer: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">Exames (MÃªs)</div>
<div class="kpi-value" id="kpiExamesMes">0</div>
<div class="kpi-sub" id="kpiExamesPendentes">Pendentes: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">Conformidade</div>
<div class="kpi-value" id="kpiConformidadeSaude">0%</div>
<div class="kpi-sub">ASOs em dia</div>
</div>
</div>
<div class="form-grid">
<div>
<label>Nome do Colaborador *</label>
<input class="input" id="saudeNome" placeholder="Nome completo" required=""/>
</div>
<div>
<label>CPF *</label>
<input class="input" id="saudeCPF" placeholder="Somente nÃºmeros" required=""/>
</div>
<div>
<label>FunÃ§Ã£o *</label>
<input class="input" id="saudeFuncao" placeholder="FunÃ§Ã£o atual" required=""/>
</div>
<div>
<label>Setor *</label>
<select class="input" id="saudeSetor" required="">
<option value="">Selecione...</option>
<option value="obras_acessos">Obras / Abertura de Acessos</option>
<option value="estradas">ManutenÃ§Ã£o de Estradas / Patrolamento</option>
<option value="drenagem">Drenagem / Bueiros</option>
<option value="terraplenagem">Terraplenagem</option>
<option value="rocada_limpeza">RoÃ§ada / Limpeza de Faixas</option>
<option value="sinalizacao">SinalizaÃ§Ã£o / Apoio de TrÃ¡fego</option>
<option value="base_logistica">Base / LogÃ­stica</option>
<option value="oficina">Oficina</option>
<option value="almoxarifado">Almoxarifado</option>
<option value="administrativo">Administrativo</option>
</select>
</div>
<div>
<label>Data AdmissÃ£o</label>
<input class="input" id="saudeAdmissao" type="date"/>
</div>
<div>
<label>Status *</label>
<select class="input" id="saudeStatus" required="">
<option value="ativo">Ativo</option>
<option value="afastado">Afastado</option>
<option value="ferias">FÃ©rias</option>
<option value="desligado">Desligado</option>
</select>
</div>
<div>
<label>Tipo de Exame *</label>
<select class="input" id="saudeTipoExame" required="">
<option value="">Selecione...</option>
<option value="admissional">Admissional</option>
<option value="periodico">PeriÃ³dico</option>
<option value="retorno">Retorno ao Trabalho</option>
<option value="mudanca">MudanÃ§a de FunÃ§Ã£o</option>
<option value="demissional">Demissional</option>
</select>
</div>
<div>
<label>Data do Exame *</label>
<input class="input" id="saudeDataExame" required="" type="date"/>
</div>
</div>
<div class="form-grid">
<div>
<label>ClÃ­nica/MÃ©dico *</label>
<input class="input" id="saudeClinica" placeholder="Nome da clÃ­nica/mÃ©dico" required=""/>
</div>
<div>
<label>Validade (meses) *</label>
<select class="input" id="saudeValidade" required="">
<option value="12">12 meses</option>
<option value="24">24 meses</option>
<option value="36">36 meses</option>
<option value="outro">Outro</option>
</select>
</div>
<div id="divOutraValidade" style="display:none;">
<label>Especificar Validade (meses)</label>
<input class="input" id="saudeValidadeOutro" max="120" min="1" type="number"/>
</div>
<div>
<label>Resultado *</label>
<select class="input" id="saudeResultado" required="">
<option value="apto">Apto</option>
<option value="apto_com_restricao">Apto com RestriÃ§Ã£o</option>
<option value="inapto">Inapto</option>
</select>
</div>
</div>
<div class="form-grid" style="margin-top:10px;">
<div>
<label>Anexar ASO</label>
<input accept=".pdf,.jpg,.png" class="input" id="saudeAnexoASO" type="file"/>
</div>
<div>
<label>Anexar Ficha de Registro</label>
<input accept=".pdf,.jpg,.png" class="input" id="saudeAnexoFicha" type="file"/>
</div>
<div>
<label>Anexar Laudos/Exames</label>
<input accept=".pdf,.jpg,.png" class="input" id="saudeAnexoLaudos" multiple="" type="file"/>
</div>
</div>
<div style="margin-top:10px;">
<label>ObservaÃ§Ãµes/RestriÃ§Ãµes</label>
<textarea class="input" id="saudeObservacoes" placeholder="ObservaÃ§Ãµes mÃ©dicas, restriÃ§Ãµes, recomendaÃ§Ãµes..." rows="3"></textarea>
</div>
<div style="margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarSaude">ğŸ’¾ Salvar Registro</button>
<button class="btn btn-success" id="btnNovoExame">â• Novo Exame</button>
<button class="btn btn-warning" id="btnRelatorioSaude">ğŸ“Š RelatÃ³rio SaÃºde</button>
<button class="btn btn-outline" id="btnLimparSaude">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:15px;">
<table>
<thead>
<tr>
<th>Colaborador</th>
<th>CPF</th>
<th>FunÃ§Ã£o</th>
<th>Setor</th>
<th>Ãšltimo Exame</th>
<th>Validade</th>
<th>Resultado</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbSaude">
<!-- Dados serÃ£o carregados via JS -->
</tbody>
</table>
</div>
</div>
</section>
<section class="section" id="sec-aso">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“‹ Controle de ASO</div>
<div class="card-sub">Cadastro de efetivo e controle de validade de ASOs</div>
</div>
<span class="badge">Alertas AutomÃ¡ticos</span>
</div>
<div class="grid grid-4">
<div class="kpi">
<div class="kpi-label">Efetivo Total</div>
<div class="kpi-value" id="kpiEfetivoTotal">0</div>
<div class="kpi-sub" id="kpiEfetivoAtivoASO">Ativos: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">ASOs em Dia</div>
<div class="kpi-value" id="kpiASOsEmDia">0</div>
<div class="kpi-sub" id="kpiPercentualDia">0%</div>
</div>
<div class="kpi">
<div class="kpi-label">A Vencer (30 dias)</div>
<div class="kpi-value" id="kpiASOsAVencer">0</div>
<div class="kpi-sub" id="kpiVencimentoProximo">PrÃ³ximo 7 dias: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">Vencidos</div>
<div class="kpi-value" id="kpiASOsVencidosControle">0</div>
<div class="kpi-sub" id="kpiVencidos30">+30 dias: 0</div>
</div>
</div>
<div style="margin-bottom:15px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-outline btn-sm" id="btnImportarEfetivo">ğŸ“‹ Importar Efetivo</button>
<button class="btn btn-outline btn-sm" id="btnCadastroRapido">â• Cadastro RÃ¡pido</button>
<button class="btn btn-outline btn-sm" id="btnRelatorioASO">ğŸ“Š RelatÃ³rio ASO</button>
<button class="btn btn-outline btn-sm" id="btnEnviarLembretes">ğŸ“§ Enviar Lembretes</button>
</div>
<div class="form-grid">
<div>
<label>Nome do Colaborador *</label>
<input class="input" id="asoNome" placeholder="Nome completo" required=""/>
</div>
<div>
<label>CPF *</label>
<input class="input" id="asoCPF" placeholder="Somente nÃºmeros" required=""/>
</div>
<div>
<label>FunÃ§Ã£o *</label>
<input class="input" id="asoFuncao" placeholder="FunÃ§Ã£o atual" required=""/>
</div>
<div>
<label>Setor *</label>
<select class="input" id="asoSetor" required="">
<option value="">Selecione...</option>
<option value="campo">Campo / Frentes</option>
<option value="oficina">Oficina</option>
<option value="almoxarifado">Almoxarifado</option>
<option value="logistica">LogÃ­stica</option>
<option value="operacao">OperaÃ§Ã£o</option>
<option value="manutencao">ManutenÃ§Ã£o</option>
<option value="administrativo">Administrativo</option>
</select>
</div>
<div>
<label>Empresa *</label>
<select class="input" id="asoEmpresa" required="">
<option value="CONTERPLAN">CONTERPLAN</option>
<option value="terceirizada">Terceirizada</option>
<option value="outra">Outra</option>
</select>
</div>
<div id="divOutraEmpresa" style="display:none;">
<label>Nome da Empresa</label>
<input class="input" id="asoEmpresaOutra" placeholder="Nome da empresa"/>
</div>
<div>
<label>Data AdmissÃ£o *</label>
<input class="input" id="asoAdmissao" required="" type="date"/>
</div>
<div>
<label>Status *</label>
<select class="input" id="asoStatus" required="">
<option value="ativo">Ativo</option>
<option value="afastado">Afastado</option>
<option value="ferias">FÃ©rias</option>
<option value="desligado">Desligado</option>
</select>
</div>
<div>
<label>Ãšltimo ASO *</label>
<input class="input" id="asoUltimo" required="" type="date"/>
</div>
<div>
<label>Validade ASO *</label>
<input class="input" id="asoValidade" required="" type="date"/>
</div>
</div>
<div style="margin-top:10px;">
<label>ObservaÃ§Ãµes</label>
<textarea class="input" id="asoObservacoes" placeholder="ObservaÃ§Ãµes sobre o colaborador..." rows="2"></textarea>
</div>
<div style="margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarASO">ğŸ’¾ Salvar Cadastro</button>
<button class="btn btn-success" id="btnAtualizarASO">ğŸ”„ Atualizar ASO</button>
<button class="btn btn-warning" id="btnAlertasVencimento">ğŸš¨ Alertas</button>
<button class="btn btn-outline" id="btnLimparASO">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:15px;">
<table>
<thead>
<tr>
<th>Status ASO</th>
<th>Colaborador</th>
<th>FunÃ§Ã£o</th>
<th>Setor</th>
<th>Empresa</th>
<th>Ãšltimo ASO</th>
<th>Validade</th>
<th>Dias Restantes</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbControleASO">
<!-- Dados serÃ£o carregados via JS -->
</tbody>
</table>
</div>
</div>
</section>
<section class="section" id="sec-engenharia">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ—ï¸ Engenharia / RDO</div>
<div class="card-sub">Registro DiÃ¡rio de Obras com controle de efetivo e condiÃ§Ãµes climÃ¡ticas</div>
</div>
<span class="badge">RDO + Fotos</span>
</div>
<div class="grid grid-3">
<div class="kpi">
<div class="kpi-label">RDOs Hoje</div>
<div class="kpi-value" id="kpiRDOsHoje">0</div>
<div class="kpi-sub" id="kpiRDOsMes">Este mÃªs: 0</div>
</div>
<div class="kpi">
<div class="kpi-label">Efetivo Hoje</div>
<div class="kpi-value" id="kpiEfetivoHoje">0</div>
<div class="kpi-sub" id="kpiSetorMaior">Maior setor: â€”</div>
</div>
<div class="kpi">
<div class="kpi-label">CondiÃ§Ã£o ClimÃ¡tica</div>
<div class="kpi-value" id="kpiCondicaoClima">â€”</div>
<div class="kpi-sub" id="kpiChuvaHoje">Choveu: NÃ£o</div>
</div>
</div>
<div class="form-grid">
<div>
<label>Data do RDO *</label>
<input class="input" id="rdoData" required="" type="date"/>
</div>
<div>
<label>Turno *</label>
<select class="input" id="rdoTurno" required="">
<option value="diurno">Diurno</option>
<option value="noturno">Noturno</option>
<option value="integral">Integral</option>
</select>
</div>
<div>
<label>ResponsÃ¡vel RDO *</label>
<input class="input" id="rdoResponsavel" placeholder="Engenheiro/ResponsÃ¡vel" required=""/>
</div>
<div>
<label>MacroÃ¡rea *</label>
<select class="input" id="rdoMacroarea" required="">
<option value="">Selecione...</option>
<option value="vias_urbanas">Vias Urbanas</option>
<option value="vias_rurais">Vias Rurais</option>
<option value="abertura_acessos">Abertura de Acessos</option>
<option value="manutencao_estradas">ManutenÃ§Ã£o de Estradas</option>
<option value="drenagem">Drenagem / Bueiros</option>
<option value="terraplenagem">Terraplenagem</option>
<option value="pavimentacao">PavimentaÃ§Ã£o</option>
<option value="sinalizacao">SinalizaÃ§Ã£o</option>
<option value="limpeza_urbana">Limpeza / RoÃ§ada</option>
<option value="obras_civis">Obras Civis</option>
<option value="infraestrutura">Infraestrutura</option>
<option value="geral">Geral</option>
</select>
</div>
<div>
<label>Ãrea EspecÃ­fica *</label>
<input class="input" id="rdoAreaEspecifica" placeholder="Ex.: Pilha Centro" required=""/>
</div>
<div>
<label>CondiÃ§Ã£o ClimÃ¡tica *</label>
<select class="input" id="rdoClima" required="">
<option value="ensolarado">Ensolarado</option>
<option value="nublado">Nublado</option>
<option value="chuvoso">Chuvoso</option>
<option value="neblina">Neblina</option>
</select>
</div>
<div>
<label>Choveu? *</label>
<select class="input" id="rdoChoveu" required="">
<option value="nao">NÃ£o</option>
<option value="sim_leve">Sim - Leve</option>
<option value="sim_moderada">Sim - Moderada</option>
<option value="sim_forte">Sim - Forte</option>
</select>
</div>
<div>
<label>Temperatura MÃ­nima (Â°C)</label>
<input class="input" id="rdoTempMin" placeholder="Ex.: 18" type="number"/>
</div>
<div>
<label>Temperatura MÃ¡xima (Â°C)</label>
<input class="input" id="rdoTempMax" placeholder="Ex.: 32" type="number"/>
</div>
<div>
<label>Efetivo Total *</label>
<input class="input" id="rdoEfetivoTotal" min="0" required="" type="number" value="0"/>
</div>
</div>
<div style="margin-top:10px;">
<label>Qual atividade estÃ¡ sendo executada? *</label>
<div class="chips" id="chipsAtividades">
<div class="chip" data-v="movimentacao_terra">MovimentaÃ§Ã£o de Terra</div>
<div class="chip" data-v="compactacao">CompactaÃ§Ã£o</div>
<div class="chip" data-v="drenagem">Drenagem</div>
<div class="chip" data-v="terraplanagem">Terraplanagem</div>
<div class="chip" data-v="construcao_talude">ConstruÃ§Ã£o de Talude</div>
<div class="chip" data-v="monitoramento">Monitoramento</div>
<div class="chip" data-v="manutencao_equip">ManutenÃ§Ã£o Equipamentos</div>
<div class="chip" data-v="operacao_britagem">OperaÃ§Ã£o Britagem</div>
</div>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o das Atividades *</label>
<textarea class="input" id="rdoDescricao" placeholder="Descreva detalhadamente as atividades executadas..." required="" rows="4"></textarea>
</div>
<div style="margin-top:10px;">
<label>OcorrÃªncias / IntercorrÃªncias</label>
<textarea class="input" id="rdoOcorrencias" placeholder="Registre ocorrÃªncias do dia (paradas, problemas, etc)..." rows="3"></textarea>
</div>
<div style="margin-top:10px;">
<label>AvanÃ§o FÃ­sico (%)</label>
<input class="input" id="rdoAvancoSlider" max="100" min="0" style="width:100%;" type="range" value="0"/>
<div style="display:flex;justify-content:space-between;margin-top:5px;">
<span>0%</span>
<span id="rdoAvancoValor">0%</span>
<span>100%</span>
</div>
<div class="rdo-progress" aria-label="Progresso do avanÃ§o fÃ­sico">
  <div class="rdo-progress-track"><div class="rdo-progress-fill" id="rdoAvancoBar" style="width:0%"></div></div>
  <div class="rdo-progress-pct" id="rdoAvancoPct">0%</div>
</div>
</div>
<div style="margin-top:10px;">
<label>Anexo de Fotos</label>
<input accept="image/*" capture="environment" class="input" id="rdoFotos" multiple="" type="file"/>
</div>
<div style="margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarRDO">ğŸ’¾ Salvar RDO</button>
<button class="btn btn-success" id="btnCopiarRDOAnterior">ğŸ“‹ Copiar Anterior</button>
<button class="btn btn-warning" id="btnGerarRelatorioRDO">ğŸ“„ Gerar RelatÃ³rio</button>
<button class="btn btn-outline" id="btnLimparRDO">Limpar</button>
</div>
<div class="table-wrap" style="margin-top:15px;">
<table>
<thead>
<tr>
<th>Data</th>
<th>MacroÃ¡rea</th>
<th>Ãrea EspecÃ­fica</th>
<th>Atividades</th>
<th>Efetivo</th>
<th>Clima</th>
<th>AvanÃ§o</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbRDO">
<!-- Dados serÃ£o carregados via JS -->
</tbody>
</table>
</div>
</div>
</section>
<section class="section" id="sec-banco-controles">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ—„ï¸ Banco de Dados - Controles EspecÃ­ficos</div>
<div class="card-sub">Base separada para Estoque, Treinamentos, SaÃºde, ASO e RDO (sem misturar com o banco principal)</div>
</div>
<span class="badge">Exportar / Importar</span>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
<button class="btn btn-outline" id="btnExportControles">â¬‡ï¸ Exportar JSON</button>
<button class="btn btn-outline" id="btnImportControles">â¬†ï¸ Importar JSON</button>
<button class="btn btn-warning" id="btnLimparControles">ğŸ—‘ï¸ Limpar Banco (Controles)</button>
</div>
<div class="grid grid-5">
<div class="kpi"><div class="kpi-label">Estoque</div><div class="kpi-value" id="kpiBC_Estoque">0</div><div class="kpi-sub">itens</div></div>
<div class="kpi"><div class="kpi-label">Treinamentos</div><div class="kpi-value" id="kpiBC_Trein">0</div><div class="kpi-sub">registros</div></div>
<div class="kpi"><div class="kpi-label">SaÃºde</div><div class="kpi-value" id="kpiBC_Saude">0</div><div class="kpi-sub">registros</div></div>
<div class="kpi"><div class="kpi-label">ASO</div><div class="kpi-value" id="kpiBC_ASO">0</div><div class="kpi-sub">colaboradores</div></div>
<div class="kpi"><div class="kpi-label">RDO</div><div class="kpi-value" id="kpiBC_RDO">0</div><div class="kpi-sub">registros</div></div>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Tipo</th>
<th>Data</th>
<th>Resumo</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbBancoControles"></tbody>
</table>
</div>
</div>
</section>
<section class="section" id="sec-banco">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“š Banco de Dados</div>
<div class="card-sub">Filtros por tipo, perÃ­odo, texto e risco. Use â€œPDFâ€ para mandar ao RelatÃ³rios.</div>
</div>
<span class="badge">Pesquisa rÃ¡pida</span>
</div>
<div class="grid grid-3">
<div>
<label>Tipo</label>
<select class="input" id="fTipo">
<option value="">Todos</option>
<option value="acidente">Acidente</option>
<option value="nc">NÃ£o conformidade</option>
<option value="ambiental">Ambiental</option>
<option value="evidencia">EvidÃªncia</option>
<option value="apr">APR</option>
</select>
</div>
<div>
<label>Data inicial</label>
<input class="input" id="fIni" type="date"/>
</div>
<div>
<label>Data final</label>
<input class="input" id="fFim" type="date"/>
</div>
<div>
<label>Buscar (nome / setor / local / tÃ­tulo)</label>
<input class="input" id="fTexto" placeholder="Digite parte do textoâ€¦"/>
</div>
<div>
<label>Risco</label>
<select class="input" id="fRisco">
<option value="">Todos</option><option>RP</option><option>RM</option><option>RA</option><option>RC</option>
</select>
</div>
<div style="display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;">
<button class="btn btn-outline btn-sm" id="btnFiltrar">Aplicar</button>
<button class="btn btn-outline btn-sm" id="btnLimparFiltro">Limpar</button>
<button class="btn btn-primary btn-sm" id="btnExportJson">Exportar JSON</button>
</div>
</div>
<div class="table-wrap" style="margin-top:12px;">
<table>
<thead>
<tr>
<th>Data</th><th>Tipo</th><th>Resumo</th><th>Risco</th><th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbBanco"></tbody>
</table>
</div>
<div class="small" style="margin-top:8px;">
            Dica: no celular, o menu vira uma faixa horizontal no topo e acompanha a orientaÃ§Ã£o. Se o iPhone nÃ£o abrir â€œcaptura de cÃ¢meraâ€, troque o navegador (Safari/Chrome) e permita acesso Ã  cÃ¢mera.
          </div>
</div>
</section>
<!-- RELATÃ“RIOS -->
<section class="section" id="sec-relatorios">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“„ RelatÃ³rios, PDF, WhatsApp &amp; E-mail</div>
<div class="card-sub">Selecione um registro no Banco de Dados e clique em â€œPDFâ€. O relatÃ³rio aparece aqui.</div>
</div>
<span class="badge">Fotos + texto</span>
</div>
<div class="card" style="margin:0;border-style:dashed;">
<div id="previewRel" style="font-size:12px;color:#334;">
              Nenhum relatÃ³rio selecionado ainda.
            </div>
</div>
<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnGerarPDF">ğŸ“¥ Gerar PDF</button>
<button class="btn btn-outline" id="btnCopiarTexto">ğŸ“‹ Copiar texto</button>
<button class="btn btn-outline" id="btnWhats">ğŸ’¬ Abrir WhatsApp</button>
<button class="btn btn-outline" id="btnEmail">âœ‰ï¸ Abrir E-mail</button>
</div>
<div class="small" style="margin-top:8px;">
            ObservaÃ§Ã£o: por seguranÃ§a, o navegador nÃ£o envia e-mail/WhatsApp diretamente â€” ele abre a mensagem pronta (vocÃª confirma o envio).
          </div>
</div>
</section>
<!-- CONFIG -->
<section class="section" id="sec-config">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">âš™ï¸ ConfiguraÃ§Ãµes</div>
<div class="card-sub">Indicadores (TF/TG) + Supabase (backup em nuvem) + ImportaÃ§Ã£o JSON.</div>
</div>
<span class="badge">Offline + Supabase</span>
</div>
<div class="form-grid">
<div>
<label>Horas-homem trabalhadas no mÃªs</label>
<input class="input" id="cfgHH" min="0" placeholder="Para TF/TG" step="1" type="number"/>
<div class="small">TF = (acidentes com perda Ã— 1.000.000) / HH</div>
</div>
<div>
<label>Dias perdidos (mÃªs)</label>
<input class="input" id="cfgDiasMes" min="0" placeholder="Se preferir fixo" step="1" type="number"/>
<div class="small">Se vazio, TG usa a soma de dias perdidos dos acidentes.</div>
</div>
</div>
<hr/>
<div class="form-grid">
<div>
<label>Supabase URL</label>
<input class="input" id="cfgSupURL" placeholder="https://svjysfphfonvsqcqhphc.supabase.co"/>
</div>
<div>
<label>Supabase Anon Key</label>
<input class="input" id="cfgSupKey" placeholder="ceyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2anlzZnBoZm9udnNxY3FocGhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NjMyNDgsImV4cCI6MjA4MTAzOTI0OH0.ZCa2mWvCs5PEofwV2A-JJFYws3kzBe7Fso7Ss3kBVK4"/>
</div>
<div>
<label>Nome da tabela</label>
<input class="input" id="cfgSupTable" value="sgiCONTERPLAN_registros"/>
<div class="small">SugestÃ£o: criar tabela com colunas (id, tipo, data, setor, risco, payload jsonb).</div>
</div>
<div style="display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;">
<button class="btn btn-outline btn-sm" id="btnSalvarCfg" type="button">Salvar config</button>
<button class="btn btn-outline btn-sm" id="btnSync">Sincronizar (upsert)</button>
</div>
</div>
<hr/>
<div class="form-grid">
<div>
<label>Importar JSON (backup)</label>
<input accept="application/json" class="input" id="importJson" type="file"/>
<div class="small">Importa e junta registros (nÃ£o apaga; vocÃª pode limpar pelo navegador se quiser).</div>
</div>
<div style="display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap;">
<button class="btn btn-danger btn-sm" id="btnLimparTudo">âš ï¸ Limpar dados deste dispositivo</button>
</div>
</div>
</div>
<div class="card" style="border:2px dashed #dc2626;background:#fff5f5">
<div class="card-title">ğŸ—‘ AdministraÃ§Ã£o do Banco</div>
</div></section>
</main>
</div>
</div>
<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
<div class="modal">
<div class="modal-close" id="modalClose">Ã—</div>
<div id="modalBody"></div>
</div>
</div>
<script>
/* =========================
   Storage & Helpers
   ========================= */
const LS_KEY = "CONTERPLAN_SGI_APR_DB_V3";

// IndexedDB fallback (mobile/offline/maior capacidade que localStorage)
const IDB_NAME = "CONTERPLAN_SGI_APR_DB";
const IDB_STORE = "kv";
function idbOpen(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(IDB_NAME, 1);
    req.onupgradeneeded = ()=> {
      const db = req.result;
      if(!db.objectStoreNames.contains(IDB_STORE)){
        db.createObjectStore(IDB_STORE);
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbSet(key, val){
  const dbi = await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx = dbi.transaction(IDB_STORE, "readwrite");
    tx.objectStore(IDB_STORE).put(val, key);
    tx.oncomplete = ()=> resolve(true);
    tx.onerror = ()=> reject(tx.error);
  });
}
async function idbGet(key){
  const dbi = await idbOpen();
  return new Promise((resolve,reject)=>{
    const tx = dbi.transaction(IDB_STORE, "readonly");
    const req = tx.objectStore(IDB_STORE).get(key);
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

const LS_CFG = "CONTERPLAN_SGI_APR_CFG_V3";

let db = []; // {id,tipo,dataISO,setor,risco,createdAt,payload, fotos:[{name,dataUrl}]} etc.
let cfg = { hh:0, diasMes:0, supUrl:"", supKey:"", supTable:"sgiCONTERPLAN_registros" };

let supa = null;
let relAtual = null;

const $ = (q)=>document.querySelector(q);
const $$ = (q)=>Array.from(document.querySelectorAll(q));

function nowISO(){ return new Date().toISOString(); }
function uid(){
  return "SGI-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,7).toUpperCase();
}
function safeText(v){ return (v||"").toString().trim(); }
function toDateISO(dateStr){ // yyyy-mm-dd
  if(!dateStr) return "";
  return dateStr + "T00:00:00.000Z";
}
function fmtData(iso){
  if(!iso) return "â€”";
  const d = new Date(iso);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function monthKey(iso){
  const d = new Date(iso);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}
function isSameMonth(iso, y, m0){
  const d = new Date(iso);
  return d.getFullYear()===y && d.getMonth()===m0;
}

let _saveLock=false;
function saveDB(){
  if(_saveLock) return;
  _saveLock=true;
  setTimeout(()=>_saveLock=false,300);

  const payload = JSON.stringify(db);
  let lsOk = false;
  try{
    localStorage.setItem(LS_KEY, payload);
    lsOk = true;
  }catch(e){
    console.warn("localStorage falhou:", e);
  }
  // Sempre tenta gravar no IndexedDB (melhor para celular e fotos)
  if(window.indexedDB){
    idbSet(LS_KEY, payload).catch(err=>console.warn("IndexedDB falhou:", err));
  }
  // Se localStorage falhar, avisar (sem travar)
  if(!lsOk){
    toast("âš ï¸ No celular, o armazenamento local falhou. O app tentou salvar no banco interno (IndexedDB).");
  }
}
function loadDB(){
  // 1) tenta localStorage
  try{
    const raw = localStorage.getItem(LS_KEY);
    db = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(db)) db=[];
  }catch(e){ db=[]; }

  // 2) se vazio, tenta IndexedDB (principal no celular)
  if((!db || !db.length) && window.indexedDB){
    idbGet(LS_KEY).then(raw=>{
      if(raw){
        try{
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed) && parsed.length){
            db = parsed;
            // Re-render apÃ³s recuperar do IndexedDB
            try{ renderAll(); atualizarDashboard(); }catch(e){}
            try{ renderEtapas(); }catch(e){}
          }
        }catch(e){}
      }
    }).catch(()=>{});
  }
}
function saveCFG(){
  localStorage.setItem(LS_CFG, JSON.stringify(cfg));
}
function loadCFG(){
  try{
    const raw = localStorage.getItem(LS_CFG);
    const c = raw ? JSON.parse(raw) : {};
    cfg = { ...cfg, ...c };
  }catch(e){}
}

async function fileToDataUrl(file, maxW=1280, quality=0.82){
  // Comprime/normaliza para nÃ£o â€œestourarâ€ storage
  const dataUrl = await new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
  if(!dataUrl.startsWith("data:image/")) return {name:file.name, dataUrl};

  const img = await new Promise((res,rej)=>{
    const i = new Image();
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src=dataUrl;
  });

  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width*scale);
  const h = Math.round(img.height*scale);

  const canvas = document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0,w,h);
  const out = canvas.toDataURL("image/jpeg", quality);
  return {name:file.name, dataUrl: out};
}

async function readFiles(inputEl){
  const files = Array.from(inputEl?.files||[]);
  const out = [];
  for(const f of files){
    try{ out.push(await fileToDataUrl(f)); }catch(e){ console.warn(e); }
  }
  return out;
}

function tagTipo(tipo){
  const map = {
    acidente:'<span class="tag t-acidente">ACIDENTE</span>',
    nc:'<span class="tag t-nc">NC</span>',
    ambiental:'<span class="tag t-ambiental">AMBIENTAL</span>',
    evidencia:'<span class="tag t-evidencia">EVIDÃŠNCIA</span>',
    apr:'<span class="tag t-apr">APR</span>',
  };
  return map[tipo]||tipo;
}

function resumoRegistro(o){
  const p = o.payload||{};
  if(o.tipo==="acidente"){
    return `${safeText(p.nome)||"â€”"} â€¢ ${safeText(p.setor)||"â€”"} â€¢ ${safeText(p.tipo)||"â€”"}`;
  }
  if(o.tipo==="nc"){
    return `${safeText(p.setor)||"â€”"} â€¢ ${safeText(p.tipo)||"â€”"} â€¢ ${safeText(p.status)||"â€”"}`;
  }
  if(o.tipo==="ambiental"){
    return `${safeText(p.local)||"â€”"} â€¢ ${safeText(p.tipo)||"â€”"}`;
  }
  if(o.tipo==="evidencia"){
    return `${safeText(p.titulo)||"â€”"} â€¢ ${safeText(p.area)||"â€”"}`;
  }
  if(o.tipo==="apr"){
    return `${safeText(p.macro)||"â€”"} â€¢ ${safeText(p.area)||"â€”"} â€¢ ${safeText(p.setor)||"â€”"}`;
  }
  return "â€”";
}

/* =========================
   Navigation
   ========================= */
function setSection(id){
  $$(".section").forEach(s=>s.classList.remove("active"));
  $("#"+id).classList.add("active");

  $$(".nav-btn").forEach(b=>b.classList.toggle("active", b.dataset.sec===id));

  // em mobile, mantÃ©m botÃ£o ativo visÃ­vel
  const activeBtn = $(`.nav-btn[data-sec="${id}"]`);
  if(activeBtn){
    activeBtn.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
  }

  // â€œdestravaâ€ resize dos grÃ¡ficos quando muda de aba
  requestAnimationFrame(()=>{ resizeCharts(); 
    // garante que o botÃ£o de Talude reapareÃ§a ao voltar para a APR
    if(id === "sec-apr") { try{ ensureTaludeButtonVisible(); }catch(e){} }
});
}

$$(".nav-btn").forEach(btn=>{
  btn.addEventListener("click", ()=> setSection(btn.dataset.sec));
});

// acompanha rotaÃ§Ã£o do celular
window.addEventListener("orientationchange", ()=> {
  setTimeout(()=> {
    const active = $(".nav-btn.active");
    if(active) active.scrollIntoView({behavior:"smooth", inline:"center", block:"nearest"});
    resizeCharts();
  }, 350);
});

/* =========================
   Risk calculator (Dashboard)
   ========================= */
function riscoPorPI(p, i){
  // Baseado na matriz exibida (RP/RM/RA/RC)
  p = Number(p); i = Number(i);
  if(!p || !i) return "";
  const key = `${p}-${i}`;
  const map = {
    "5-1":"RM","5-2":"RA","5-3":"RA","5-4":"RC","5-5":"RC",
    "4-1":"RM","4-2":"RM","4-3":"RA","4-4":"RA","4-5":"RC",
    "3-1":"RP","3-2":"RM","3-3":"RM","3-4":"RA","3-5":"RA",
    "2-1":"RP","2-2":"RP","2-3":"RM","2-4":"RM","2-5":"RA",
    "1-1":"RP","1-2":"RP","1-3":"RP","1-4":"RM","1-5":"RM",
  };
  return map[key] || "";
}
function updateCalc(){
  const p = $("#calcProb").value;
  const i = $("#calcImp").value;
  const r = riscoPorPI(p,i);
  const el = $("#calcRes");
  if(!r){ el.textContent="â€”"; el.style.background="#fff"; return; }
  el.innerHTML = `<span class="tag ${r.toLowerCase()}">${r}</span><span style="font-weight:700;color:#334;">Prob ${p} Ã— Imp ${i}</span>`;
}
$("#calcProb").addEventListener("change", updateCalc);
$("#calcImp").addEventListener("change", updateCalc);

/* =========================
   CRUD: Save records
   ========================= */
function upsertRecord(rec){
  const ix = db.findIndex(x=>x.id===rec.id);
  if(ix>=0) db[ix]=rec; else db.unshift(rec);
  saveDB();
}

function deleteRecord(id){
  db = db.filter(x=>x.id!==id);
  saveDB();
  renderAll();
  atualizarDashboard();

  try{ ensureTaludeButtonVisible(); }catch(e){}
}

function clearInputs(ids){
  ids.forEach(id=>{
    const el = $("#"+id);
    if(!el) return;
    if(el.type==="file") el.value="";
    else el.value="";
  });
}

/* ACIDENTE */
$("#btnSalvarAc").addEventListener("click", async ()=>{
  const data = $("#acData").value;
  if(!data){ alert("Preencha a data do acidente."); return; }

  const fotos = await readFiles($("#acFotos"));
  const payload = {
    data,
    hora: safeText($("#acHora").value),
    turno: safeText($("#acTurno").value),
    setor: safeText($("#acSetor").value),
    nome: safeText($("#acNome").value),
    funcao: safeText($("#acFuncao").value),
    cpf: safeText($("#acCPF").value),
    chefe: safeText($("#acChefe").value),
    local: safeText($("#acLocal").value),
    tipo: safeText($("#acTipo").value),
    cat: safeText($("#acCAT").value),
    perda: safeText($("#acPerda").value),
    dias: Number($("#acDias").value||0),
    risco: safeText($("#acRisco").value),
    lesao: safeText($("#acLesao").value),
    desc: safeText($("#acDesc").value),
    medidas: safeText($("#acMedidas").value),
    fotos
  };

  const rec = {
    id: uid(),
    tipo: "acidente",
    dataISO: toDateISO(data),
    setor: payload.setor || payload.local || "",
    risco: payload.risco || "",
    createdAt: nowISO(),
    payload
  };
  upsertRecord(rec);
  renderAll();
  atualizarDashboard();
  alert("Acidente salvo.");
  clearInputs(["acHora","acSetor","acNome","acFuncao","acCPF","acChefe","acLocal","acTipo","acCAT","acPerda","acDias","acRisco","acLesao","acDesc","acMedidas"]);
  $("#acFotos").value="";
});
$("#btnLimparAc").addEventListener("click", ()=> {
  clearInputs(["acData","acHora","acTurno","acSetor","acNome","acFuncao","acCPF","acChefe","acLocal","acTipo","acCAT","acPerda","acDias","acRisco","acLesao","acDesc","acMedidas"]);
  $("#acFotos").value="";
});

/* NC */
$("#btnSalvarNC").addEventListener("click", async ()=>{
  const data = $("#ncData").value;
  if(!data){ alert("Preencha a data."); return; }
  const fotos = await readFiles($("#ncFotos"));
  const payload = {
    data,
    turno: safeText($("#ncTurno").value),
    setor: safeText($("#ncSetor").value),
    identificou: safeText($("#ncIdentificou").value),
    tipo: safeText($("#ncTipo").value),
    status: safeText($("#ncStatus").value),
    risco: safeText($("#ncRisco").value),
    desc: safeText($("#ncDesc").value),
    acoes: safeText($("#ncAcoes").value),
    fotos
  };

  // Regra: para marcar como "ConcluÃ­do/Atendida", exigir evidÃªncia anexada
  if(status === 'ConcluÃ­do' && (!fotos || fotos.length === 0)){
    alert('Para marcar como CONCLUÃDO, Ã© obrigatÃ³rio anexar pelo menos 1 evidÃªncia (foto/arquivo).');
    return;
  }

  const rec = { id: uid(), tipo:"nc", dataISO: toDateISO(data), setor: payload.setor, risco: payload.risco, createdAt: nowISO(), payload };
  upsertRecord(rec);
  renderAll(); atualizarDashboard();
  alert("NÃ£o conformidade salva.");
  clearInputs(["ncData","ncTurno","ncSetor","ncIdentificou","ncTipo","ncStatus","ncRisco","ncDesc","ncAcoes"]);
  $("#ncFotos").value="";
});
$("#btnLimparNC").addEventListener("click", ()=> {
  clearInputs(["ncData","ncTurno","ncSetor","ncIdentificou","ncTipo","ncStatus","ncRisco","ncDesc","ncAcoes"]);
  $("#ncFotos").value="";
});

/* Ambiental */
$("#btnSalvarAM").addEventListener("click", async ()=>{
  const data = $("#amData").value;
  if(!data){ alert("Preencha a data."); return; }
  const fotos = await readFiles($("#amFotos"));
  const payload = {
    data,
    local: safeText($("#amLocal").value),
    responsavel: safeText($("#amResp").value),
    tipo: safeText($("#amTipo").value),
    risco: safeText($("#amRisco").value),
    desc: safeText($("#amDesc").value),
    medidas: safeText($("#amMed").value),
    fotos
  };
  const rec = { id: uid(), tipo:"ambiental", dataISO: toDateISO(data), setor: payload.local, risco: payload.risco, createdAt: nowISO(), payload };
  upsertRecord(rec);
  renderAll(); atualizarDashboard();
  alert("Registro ambiental salvo.");
  clearInputs(["amData","amLocal","amResp","amTipo","amRisco","amDesc","amMed"]);
  $("#amFotos").value="";
});
$("#btnLimparAM").addEventListener("click", ()=> {
  clearInputs(["amData","amLocal","amResp","amTipo","amRisco","amDesc","amMed"]);
  $("#amFotos").value="";
});

/* EvidÃªncia */
$("#btnSalvarEV").addEventListener("click", async ()=>{
  const data = $("#evData").value;
  if(!data){ alert("Preencha a data."); return; }
  const fotosAntes = await readFiles($("#evAntes"));
  const fotosDepois = await readFiles($("#evDepois"));
  const payload = {
    data,
    titulo: safeText($("#evTitulo").value),
    area: safeText($("#evArea").value),
    responsavel: safeText($("#evResp").value),
    descAntes: safeText($("#evDescAntes").value),
    descDepois: safeText($("#evDescDepois").value),
    fotosAntes, fotosDepois
  };
  const rec = { id: uid(), tipo:"evidencia", dataISO: toDateISO(data), setor: payload.area, risco: "", createdAt: nowISO(), payload };
  upsertRecord(rec);
  renderAll(); atualizarDashboard();
  alert("EvidÃªncia salva.");
  clearInputs(["evData","evTitulo","evArea","evResp","evDescAntes","evDescDepois"]);
  $("#evAntes").value=""; $("#evDepois").value="";
});
$("#btnLimparEV").addEventListener("click", ()=> {
  clearInputs(["evData","evTitulo","evArea","evResp","evDescAntes","evDescDepois"]);
  $("#evAntes").value=""; $("#evDepois").value="";
});

/* APR chips */
function setupChips(containerId){
  const cont = $("#"+containerId);
  if(!cont) return;
  cont.addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;
    chip.classList.toggle("sel");
  });
}
["chipsMina","chipsEixo1","chipsPde","chipsUsina"].forEach(setupChips);


// BotÃµes de etapas (APR)
if(document.getElementById("btnAddEtapa")) {
  $("#btnAddEtapa").addEventListener("click", ()=> addEtapa());
  $("#btnLimparEtapas").addEventListener("click", ()=> clearEtapas());
}
if(document.getElementById("btnTaludeMina")){
  $("#btnTaludeMina").addEventListener("click", ()=> applyTaludePresetMina());
}

function getSelectedChips(containerId){
  return $$("#"+containerId+" .chip.sel").map(x=>x.textContent.trim());
}

function setChipSelected(containerId, dataV, selected=true){
  const cont = document.getElementById(containerId);
  if(!cont) return;
  const chip = cont.querySelector('.chip[data-v="'+dataV+'"]');
  if(!chip) return;
  chip.classList.toggle("sel", !!selected);
}
function clearChips(containerId){
  $$("#"+containerId+" .chip.sel").forEach(x=>x.classList.remove("sel"));
}


/* APR etapas (organizado) */
let aprEtapas = [];

function _escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function _escapeAttr(s){ return _escapeHtml(s).replaceAll("\n"," "); }

function etapaTemplate(et, idx){
  const n = idx+1;
  const titulo = et.titulo ? " â€” "+_escapeHtml(et.titulo) : "";
  return `
    <div class="apr-etapa" data-idx="${idx}">
      <div class="apr-etapa-head">
        <div class="apr-etapa-title">Etapa ${n}${titulo}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn btn-outline btn-sm" type="button" onclick="moveEtapa(${idx},-1)">â†‘</button>
          <button class="btn btn-outline btn-sm" type="button" onclick="moveEtapa(${idx},1)">â†“</button>
          <button class="btn btn-danger btn-sm" type="button" onclick="delEtapa(${idx})">Remover</button>
        </div>
      </div>

      <div class="apr-etapa-grid">
        <div>
          <label>TÃ­tulo / atividade da etapa</label>
          <input class="input" value="${_escapeAttr(et.titulo||"")}" oninput="setEtapaField(${idx},'titulo',this.value)" placeholder="Ex.: Patrolar acesso / Operar trator na pilha">
        </div>
        <div>
          <label>Local / referÃªncia</label>
          <input class="input" value="${_escapeAttr(et.local||"")}" oninput="setEtapaField(${idx},'local',this.value)" placeholder="Ex.: Pilha Centro / Rampa 3 / Talude">
        </div>

        <div>
          <label>Perigos / consequÃªncias</label>
          <textarea class="input" oninput="setEtapaField(${idx},'perigos',this.value)" placeholder="Ex.: tombamento, atropelamento, escorregamento, poeira...">${_escapeHtml(et.perigos||"")}</textarea>
        </div>
        <div>
          <label>Controles / barreiras</label>
          <textarea class="input" oninput="setEtapaField(${idx},'controles',this.value)" placeholder="Ex.: inspeÃ§Ã£o do acesso, limite de velocidade, checklist, sinalizaÃ§Ã£o, rÃ¡dio...">${_escapeHtml(et.controles||"")}</textarea>
        </div>

        <div>
          <label>EPI / EPC (opcional)</label>
          <input class="input" value="${_escapeAttr(et.epi||"")}" oninput="setEtapaField(${idx},'epi',this.value)" placeholder="Ex.: capacete, Ã³culos, protetor auricular...">
        </div>
        <div>
          <label>ResponsÃ¡vel / prazo (opcional)</label>
          <input class="input" value="${_escapeAttr(et.respPrazo||"")}" oninput="setEtapaField(${idx},'respPrazo',this.value)" placeholder="Ex.: ManutenÃ§Ã£o / atÃ© 10/01">
        </div>

        <div>
          <label>Risco (matriz)</label>
          <select class="input" onchange="setEtapaField(${idx},'risco',this.value)">
            <option value="">Selecioneâ€¦</option>
            <option value="RP" ${et.risco==="RP"?"selected":""}>RP</option>
            <option value="RM" ${et.risco==="RM"?"selected":""}>RM</option>
            <option value="RA" ${et.risco==="RA"?"selected":""}>RA</option>
            <option value="RC" ${et.risco==="RC"?"selected":""}>RC</option>
          </select>
        </div>
        <div>
          <label>Status (opcional)</label>
          <select class="input" onchange="setEtapaField(${idx},'status',this.value)">
            <option value="">â€”</option>
            <option value="Planejado" ${et.status==="Planejado"?"selected":""}>Planejado</option>
            <option value="Em andamento" ${et.status==="Em andamento"?"selected":""}>Em andamento</option>
            <option value="ConcluÃ­do" ${et.status==="ConcluÃ­do"?"selected":""}>ConcluÃ­do</option>
          </select>
        </div>
      </div>
    </div>
  `;
}

function renderEtapas(){
  const cont = document.getElementById("aprEtapas");
  if(!cont) return;
  cont.innerHTML = aprEtapas.length
    ? aprEtapas.map(etapaTemplate).join("")
    : `<div class="small" style="color:#6b7280;">Nenhuma etapa adicionada. Clique em â€œAdicionar etapaâ€.</div>`;
}

function addEtapa(){
  aprEtapas.push({ titulo:"", local:"", perigos:"", controles:"", epi:"", respPrazo:"", risco:"", status:"" });
  renderEtapas();
}

window.setEtapaField = (idx, k, v)=>{
  if(!aprEtapas[idx]) return;
  aprEtapas[idx][k]=v;
  // Atualiza apenas o tÃ­tulo visual sem re-render geral
  const card = document.querySelector('.apr-etapa[data-idx="'+idx+'"]');
  if(card && k==='titulo'){
    const t = card.querySelector('.apr-etapa-title');
    if(t) t.textContent = 'Etapa ' + (idx+1) + (v ? ' â€” ' + v : '');
  }
};

window.delEtapa = (idx)=>{
  aprEtapas.splice(idx,1);
  renderEtapas();
};

window.moveEtapa = (idx, dir)=>{
  const j = idx + dir;
  if(j<0 || j>=aprEtapas.length) return;
  const tmp = aprEtapas[idx];
  aprEtapas[idx]=aprEtapas[j];
  aprEtapas[j]=tmp;
  renderEtapas();
};

function clearEtapas(){
  aprEtapas = [];
  renderEtapas();
}


function applyTaludePresetMina(){
  // Seleciona chip e cria etapas padrÃ£o (ajuste livre depois)
  setChipSelected("chipsMina","talude", true);

  // Gera etapas (organizaÃ§Ã£o sugerida para inspeÃ§Ã£o/avaliaÃ§Ã£o)
  const base = [
    {titulo:"InspeÃ§Ã£o visual do talude (crista e face)", local:"", perigos:"Queda de blocos, escorregamento, instabilidade localizada.", controles:"Manter afastamento seguro, inspeÃ§Ã£o com binÃ³culo, isolamento/fitas, comunicar geotecnia.", risco:"", status:""},
    {titulo:"Verificar trincas/tensÃµes na crista", local:"", perigos:"Trinca tensionada, abertura/propagaÃ§Ã£o de fissuras.", controles:"Marcar/monitorar (pintura/estacas), registrar abertura e extensÃ£o, sinalizar e restringir acesso.", risco:"", status:""},
    {titulo:"CondiÃ§Ã£o do pÃ© de talude (toe)", local:"", perigos:"Empolamento/bulging, acÃºmulo de material solto, risco de escorregamento.", controles:"Manter Ã¡rea limpa, remover material instÃ¡vel conforme procedimento, definir zona de exclusÃ£o.", risco:"", status:""},
    {titulo:"Altura/banquetas/bermas e drenagem", local:"", perigos:"ErosÃ£o, Ã¡gua infiltrando, perda de bermas, queda de material.", controles:"Checar bermas/banquetas, drenos/valetas, manter drenagem ativa, corrigir erosÃµes.", risco:"", status:""},
    {titulo:"Sinais de Ã¡gua (seepage) / umidade", local:"", perigos:"Aumento de poro-pressÃ£o e instabilidade.", controles:"Identificar pontos de seepage, acionar drenagem/bombeamento, registrar e comunicar geotecnia.", risco:"", status:""},
    {titulo:"Necessidade de corte/escalaÃ§Ã£o/limpeza (se aplicÃ¡vel)", local:"", perigos:"Queda de blocos durante corte, exposiÃ§Ã£o de equipe.", controles:"Planejar com geotecnia, APR especÃ­fica, isolamento, equipamento adequado, comunicaÃ§Ã£o via rÃ¡dio.", risco:"", status:""}
  ];
  // Junta com o que jÃ¡ existe
  if(!Array.isArray(aprEtapas)) aprEtapas = [];
  aprEtapas = aprEtapas.concat(base);
  renderEtapas();
  // Ajuda o usuÃ¡rio a ver a seÃ§Ã£o de etapas
  const el = document.getElementById("aprEtapas");
  if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
}

/* APR sub-tabs */
$$(".apr-tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".apr-tab").forEach(b=>b.classList.toggle("active", b===btn));
    const tab = btn.dataset.tab;
    $$(".apr-sub").forEach(s=>s.classList.toggle("active", s.id===("apr-"+tab)));
  });
});

$("#btnSalvarAPR").addEventListener("click", async ()=>{
  const data = $("#aprData").value;
  if(!data){ alert("Preencha a data da APR."); return; }

  const activeTab = $(".apr-tab.active")?.dataset.tab || "mina";
  const macroMap = { mina:"Mina", eixo1:"Eixo 1", pdesul:"PDEâ€‘Sul", usina:"Usina" };
  const macro = macroMap[activeTab] || "Mina";

  let area="", risco="", atividades=[];
  if(activeTab==="mina"){
    area = $("#aprAreaMina").value;
    risco = $("#aprRiscoMina").value;
    atividades = getSelectedChips("chipsMina");
  }else if(activeTab==="eixo1"){
    area = $("#aprAreaEixo1").value;
    risco = $("#aprRiscoEixo1").value;
    atividades = getSelectedChips("chipsEixo1");
  }else if(activeTab==="pdesul"){
    area = $("#aprAreaPde").value;
    risco = $("#aprRiscoPde").value;
    atividades = getSelectedChips("chipsPde");
  }else{
    area = $("#aprAreaUsina").value;
    risco = $("#aprRiscoUsina").value;
    atividades = getSelectedChips("chipsUsina");
  }

  const fotos = await readFiles($("#aprFotos"));
  const payload = {
    data,
    turno: safeText($("#aprTurno").value),
    responsavel: safeText($("#aprResp").value),
    equipe: safeText($("#aprEquipe").value),
    macro,
    area,
    setor: safeText($("#aprSetor").value),
    risco,
    atividades,
    etapas: aprEtapas,
    texto: safeText($("#aprTexto").value),
    fotos,

    // filtros extras por tab (guardamos tambÃ©m)
    mina: {
      clima: safeText($("#aprClimaMina").value),
      material: safeText($("#aprMatMina").value),
    },
    eixo1: {
      clima: safeText($("#aprClimaEixo1").value),
      geo: safeText($("#aprGeoEixo1").value),
    },
    pdesul: {
      clima: safeText($("#aprClimaPde").value),
      acesso: safeText($("#aprAcessoPde").value),
    },
    usina: {
      clima: safeText($("#aprClimaUsina").value),
      cond: safeText($("#aprCondUsina").value),
    },

    // PCRC / EPIs / SaÃºde / Bloqueio / Executantes (v7.2)
    pcrc: {
      // compat (mantÃ©m)
      pcrcId: (window.aprPcrcState && window.aprPcrcState.pcrcId) || "",
      riscos: Array.isArray(window.aprPcrcState?.riscos) ? window.aprPcrcState.riscos : [],
      controles: Array.isArray(window.aprPcrcState?.controles) ? window.aprPcrcState.controles : [],
      obs: safeText(document.getElementById("pcrcObs")?.value || ""),
      outrosRiscos: safeText(document.getElementById("pcrcRiscosOutros")?.value || ""),
      outrosControles: safeText(document.getElementById("pcrcControlesOutros")?.value || ""),

      // novo (mÃºltiplas)
      pcrcMulti: Array.isArray(window.aprPcrcMultiState) ? window.aprPcrcMultiState : (Array.isArray(aprPcrcMulti)?aprPcrcMulti:[]),
    },
    epi_saude: {
      epis: window.aprEpiState || {selected:[], just:""},
      saude: window.aprSaudeState || {},
    },
    executantes: Array.isArray(window.aprExecutantesState) ? window.aprExecutantesState : [],
    bloqueio: {
      checks: (typeof window.aprBloqState?.checks === "object" && window.aprBloqState.checks) ? window.aprBloqState.checks : {},
      local: safeText(document.getElementById("bloqLocal")?.value || ""),
      resp: safeText(document.getElementById("bloqResp")?.value || ""),
      dataHora: safeText(document.getElementById("bloqDataHora")?.value || ""),
      obs: safeText(document.getElementById("bloqObs")?.value || ""),
      descricao: safeText(document.getElementById("bloqDescricao")?.value || ""),
    }
  };

  const rec = { id: uid(), tipo:"apr", dataISO: toDateISO(data), setor: payload.setor || area || macro, risco, createdAt: nowISO(), payload };
  upsertRecord(rec);
  renderAll(); atualizarDashboard();
  alert("APR salva."); window._currentFormId = null;
  clearEtapas();
  // limpeza parcial
  clearInputs(["aprData","aprTurno","aprResp","aprEquipe","aprTexto","aprSetor","aprAreaMina","aprClimaMina","aprMatMina","aprRiscoMina","aprAreaEixo1","aprClimaEixo1","aprGeoEixo1","aprRiscoEixo1","aprAreaPde","aprAcessoPde","aprClimaPde","aprRiscoPde","aprAreaUsina","aprCondUsina","aprClimaUsina","aprRiscoUsina"]);
  $("#aprFotos").value="";
  ["chipsMina","chipsEixo1","chipsPde","chipsUsina"].forEach(id=> $$("#"+id+" .chip").forEach(c=>c.classList.remove("sel")));
});
$("#btnLimparAPR").addEventListener("click", ()=> {
  clearEtapas();
  clearInputs(["aprData","aprTurno","aprResp","aprEquipe","aprTexto","aprSetor","aprAreaMina","aprClimaMina","aprMatMina","aprRiscoMina","aprAreaEixo1","aprClimaEixo1","aprGeoEixo1","aprRiscoEixo1","aprAreaPde","aprAcessoPde","aprClimaPde","aprRiscoPde","aprAreaUsina","aprCondUsina","aprClimaUsina","aprRiscoUsina"]);
  $("#aprFotos").value="";
  ["chipsMina","chipsEixo1","chipsPde","chipsUsina"].forEach(id=> $$("#"+id+" .chip").forEach(c=>c.classList.remove("sel")));
});

/* =========================
   Render tables
   ========================= */
function btnRow(actionsHtml){ return `<div style="display:flex;gap:6px;flex-wrap:wrap;">${actionsHtml}</div>`; }

function renderAcidentes(){
  const rows = db.filter(x=>x.tipo==="acidente").slice(0,200).map(o=>{
    const p=o.payload||{};
    const tipoTxt = p.tipo==="com_lesao"?"Com lesÃ£o":(p.tipo==="sem_lesao"?"Sem perda":(p.tipo==="quase"?"Quase":"â€”"));
    return `<tr>
      <td>${fmtData(o.dataISO)}</td>
      <td>${safeText(p.nome)||"â€”"}</td>
      <td>${safeText(p.setor)||"â€”"}</td>
      <td>${tipoTxt}</td>
      <td>${safeText(p.cat)||"â€”"}</td>
      <td>${safeText(p.risco)||"â€”"}</td>
      <td>${btnRow(`
        <button class="btn btn-outline btn-sm" onclick="openQR('${o.id}')">QR</button>
        <button class="btn btn-outline btn-sm" onclick="selectForReport('${o.id}')">PDF</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDel('${o.id}')">Del</button>
      `)}</td>
    </tr>`;
  }).join("");
  $("#tbAc").innerHTML = rows || `<tr><td colspan="7" style="color:#6b7280;">Nenhum acidente salvo.</td></tr>`;
}

function renderNC(){
  const rows = db.filter(x=>x.tipo==="nc").slice(0,200).map(o=>{
    const p=o.payload||{};
    return `<tr>
      <td>${fmtData(o.dataISO)}</td>
      <td>${safeText(p.setor)||"â€”"}</td>
      <td>${safeText(p.tipo)||"â€”"}</td>
      <td>${safeText(p.status)||"â€”"}</td>
      <td>${safeText(p.risco)||"â€”"}</td>
      <td>${btnRow(`
        <button class="btn btn-outline btn-sm" onclick="openQR('${o.id}')">QR</button>
        <button class="btn btn-outline btn-sm" onclick="selectForReport('${o.id}')">PDF</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDel('${o.id}')">Del</button>
      `)}</td>
    </tr>`;
  }).join("");
  $("#tbNC").innerHTML = rows || `<tr><td colspan="6" style="color:#6b7280;">Nenhuma NC salva.</td></tr>`;
}

function renderAmbiental(){
  const rows = db.filter(x=>x.tipo==="ambiental").slice(0,200).map(o=>{
    const p=o.payload||{};
    return `<tr>
      <td>${fmtData(o.dataISO)}</td>
      <td>${safeText(p.local)||"â€”"}</td>
      <td>${safeText(p.tipo)||"â€”"}</td>
      <td>${safeText(p.risco)||"â€”"}</td>
      <td>${btnRow(`
        <button class="btn btn-outline btn-sm" onclick="openQR('${o.id}')">QR</button>
        <button class="btn btn-outline btn-sm" onclick="selectForReport('${o.id}')">PDF</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDel('${o.id}')">Del</button>
      `)}</td>
    </tr>`;
  }).join("");
  $("#tbAM").innerHTML = rows || `<tr><td colspan="5" style="color:#6b7280;">Nenhum registro ambiental salvo.</td></tr>`;
}

function renderEvidencias(){
  const rows = db.filter(x=>x.tipo==="evidencia").slice(0,200).map(o=>{
    const p=o.payload||{};
    return `<tr>
      <td>${fmtData(o.dataISO)}</td>
      <td>${safeText(p.titulo)||"â€”"}</td>
      <td>${safeText(p.area)||"â€”"}</td>
      <td>${btnRow(`
        <button class="btn btn-outline btn-sm" onclick="openQR('${o.id}')">QR</button>
        <button class="btn btn-outline btn-sm" onclick="selectForReport('${o.id}')">PDF</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDel('${o.id}')">Del</button>
      `)}</td>
    </tr>`;
  }).join("");
  $("#tbEV").innerHTML = rows || `<tr><td colspan="4" style="color:#6b7280;">Nenhuma evidÃªncia salva.</td></tr>`;
}

function renderAPR(){
  const rows = db.filter(x=>x.tipo==="apr").slice(0,200).map(o=>{
    const p=o.payload||{};
    const acts = (p.atividades||[]).slice(0,4).join(" Â· ") + ((p.atividades||[]).length>4 ? "â€¦" : "");
    return `<tr>
      <td>${fmtData(o.dataISO)}</td>
      <td>${safeText(p.macro)||"â€”"}</td>
      <td>${safeText(p.area)||"â€”"}</td>
      <td>${safeText(p.setor)||"â€”"}</td>
      <td>${safeText(p.risco)||"â€”"}</td>
      <td>${acts||"â€”"}</td>
      <td>${btnRow(`
        <button class="btn btn-outline btn-sm" onclick="openQR('${o.id}')">QR</button>
        <button class="btn btn-outline btn-sm" onclick="selectForReport('${o.id}')">PDF</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDel('${o.id}')">Del</button>
      `)}</td>
    </tr>`;
  }).join("");
  $("#tbAPR").innerHTML = rows || `<tr><td colspan="7" style="color:#6b7280;">Nenhuma APR salva.</td></tr>`;
}

function renderBanco(){
  const ft = $("#fTipo").value;
  const ini = $("#fIni").value ? new Date($("#fIni").value+"T00:00:00") : null;
  const fim = $("#fFim").value ? new Date($("#fFim").value+"T23:59:59") : null;
  const texto = safeText($("#fTexto").value).toLowerCase();
  const risco = $("#fRisco").value;

  const out = db.filter(o=>{
    if(ft && o.tipo!==ft) return false;
    if(risco && (o.risco||"")!==risco) return false;
    const d = o.dataISO ? new Date(o.dataISO) : null;
    if(ini && d && d<ini) return false;
    if(fim && d && d>fim) return false;
    if(texto){
      const blob = (resumoRegistro(o)+" "+JSON.stringify(o.payload||{})).toLowerCase();
      if(!blob.includes(texto)) return false;
    }
    return true;
  });

  const rows = out.slice(0,500).map(o=>{
    return `<tr>
      <td>${fmtData(o.dataISO)}</td>
      <td>${tagTipo(o.tipo)}</td>
      <td>${resumoRegistro(o)}</td>
      <td>${o.risco||"â€”"}</td>
      <td>${btnRow(`
        <button class="btn btn-outline btn-sm" onclick="openQR('${o.id}')">QR</button>
        <button class="btn btn-outline btn-sm" onclick="selectForReport('${o.id}')">PDF</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDel('${o.id}')">Del</button>
      `)}</td>
    </tr>`;
  }).join("");

  $("#tbBanco").innerHTML = rows || `<tr><td colspan="5" style="color:#6b7280;">Nenhum registro encontrado.</td></tr>`;
}

function renderAll(){
  renderAcidentes(); renderNC(); renderAmbiental(); renderEvidencias(); renderAPR(); renderBanco();
}

/* Global for inline onclick */
window.confirmDel = (id)=>{
  if(confirm("Excluir registro?")) deleteRecord(id);
};

/* =========================
   QR Code Modal
   ========================= */
function showModal(html){
  $("#modalBody").innerHTML = html;
  $("#modalBackdrop").style.display = "flex";
}
$("#modalClose").addEventListener("click", ()=> $("#modalBackdrop").style.display="none");
$("#modalBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="modalBackdrop") $("#modalBackdrop").style.display="none"; });

window.openQR = (id)=>{
  const o = db.find(x=>x.id===id);
  if(!o){ alert("Registro nÃ£o encontrado."); return; }
  const payload = {
    id:o.id, tipo:o.tipo, data: o.payload?.data || "", setor:o.setor||"", risco:o.risco||"",
    resumo: resumoRegistro(o)
  };
  const txt = JSON.stringify(payload);
  const divId = "qr"+Math.random().toString(36).slice(2);
  showModal(`
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <div style="font-weight:900;color:var(--sam-blue);">QR Code do Registro</div>
      <div class="badge">${o.id}</div>
    </div>
    <div style="margin-top:8px;font-size:12px;color:#334;">
      <b>Resumo:</b> ${resumoRegistro(o)}<br>
      <b>Data:</b> ${fmtData(o.dataISO)} Â· <b>Risco:</b> ${o.risco||"â€”"}
    </div>
    <div id="${divId}" style="margin-top:10px;display:flex;justify-content:center;"></div>
    <div style="margin-top:10px;font-size:11px;color:#6b7280;">
      O QR contÃ©m um resumo (nÃ£o inclui fotos). Use para referÃªncia rÃ¡pida em campo.
    </div>
  `);
  setTimeout(()=>{
    const node = document.getElementById(divId);
    if(!node) return;
    node.innerHTML = "";
    if(window.QRCode){
      new QRCode(node, {text:txt, width:220, height:220});
    }else{
      // Fallback online (se o app estiver offline e sem a lib, o QR vira imagem via web)
      const img = document.createElement("img");
      img.alt = "QR Code";
      img.width = 220; img.height = 220;
      img.src = "https://chart.googleapis.com/chart?cht=qr&chs=220x220&chld=L|1&chl=" + encodeURIComponent(txt);
      node.appendChild(img);
    }
  }, 30);
};

/* =========================
   Reports
   ========================= */
function buildReportHTML(o){
  const p = o.payload||{};
  const isLesao = (o.tipo==="acidente" && p.tipo==="com_lesao");
  const head = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <div style="width:54px;height:54px;border-radius:999px;background:#fff;border:2px solid #0f172a;display:flex;align-items:center;justify-content:center;overflow:hidden;">
        <span style="font-size:26px;">ğŸ¦º</span>
      </div>
      <div style="min-width:0;">
        <div style="font-size:16px;font-weight:900;color:#003b5c;">CONTERPLAN â€“ SGI / APR</div>
        <div style="font-size:11px;color:#334;">RelatÃ³rio detalhado â€¢ ${o.tipo.toUpperCase()} â€¢ ID ${o.id}</div>
      </div>
      <div style="margin-left:auto;text-align:right;font-size:11px;color:#334;">
        <div><b>Data:</b> ${fmtData(o.dataISO)}</div>
        <div><b>Risco:</b> ${o.risco||"â€”"}</div>
      </div>
    </div>
    <hr>
  `;

  const fotosHtml = (arr, label)=> {
    if(!arr || !arr.length) return "";
    const imgs = arr.map(f=>`<img src="${f.dataUrl}" style="width:100%;max-width:520px;border-radius:12px;border:1px solid #e5e7eb;margin:6px 0;">`).join("");
    return `<div style="margin-top:10px;">
      <div style="font-weight:900;color:#003b5c;">${label}</div>
      ${imgs}
    </div>`;
  };

  if(o.tipo==="acidente"){
    const perdaTxt = p.perda==="afastamento"?"Com afastamento":(p.perda==="restricao"?"RestriÃ§Ã£o":"Sem perda");
    const tipoTxt = p.tipo==="com_lesao"?"Acidente com lesÃ£o":(p.tipo==="sem_lesao"?"Acidente sem lesÃ£o":"Quase acidente");
    const blocoLesao = isLesao ? `
      <div style="margin-top:10px;padding:10px;border-radius:14px;border:1px solid #fde2e2;background:#fff5f5;">
        <div style="font-weight:900;color:#b93730;">Modelo especÃ­fico: Acidente com lesÃ£o</div>
        <div style="font-size:12px;margin-top:6px;">
          <b>CAT:</b> ${p.cat||"â€”"} Â· <b>Perda:</b> ${perdaTxt} Â· <b>Dias perdidos:</b> ${Number(p.dias||0)}
        </div>
        <div style="font-size:12px;margin-top:6px;"><b>LesÃ£o:</b> ${p.lesao||"â€”"}</div>
      </div>
    ` : ``;

    return `
      ${head}
      ${blocoLesao}
      <div style="font-size:12px;line-height:1.45;color:#334;">
        <div><b>Colaborador:</b> ${p.nome||"â€”"} Â· <b>FunÃ§Ã£o:</b> ${p.funcao||"â€”"} Â· <b>CPF:</b> ${p.cpf||"â€”"}</div>
        <div><b>Chefe:</b> ${p.chefe||"â€”"} Â· <b>Turno:</b> ${p.turno||"â€”"} Â· <b>Hora:</b> ${p.hora||"â€”"}</div>
        <div><b>Setor/Ãrea:</b> ${p.setor||"â€”"} Â· <b>Local:</b> ${p.local||"â€”"}</div>
        <div><b>Tipo:</b> ${tipoTxt} Â· <b>CAT:</b> ${p.cat||"â€”"} Â· <b>Perda:</b> ${perdaTxt}</div>
      </div>

      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">DescriÃ§Ã£o do ocorrido</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.desc||"â€”"}</div>
      </div>

      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">Medidas a serem tomadas</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.medidas||"â€”"}</div>
      </div>

      ${fotosHtml(p.fotos, "Fotos / EvidÃªncias")}
    `;
  }

  if(o.tipo==="nc"){
    return `
      ${head}
      <div style="font-size:12px;line-height:1.45;color:#334;">
        <div><b>Ãrea/Setor:</b> ${p.setor||"â€”"} Â· <b>Tipo:</b> ${p.tipo||"â€”"} Â· <b>Status:</b> ${p.status||"â€”"}</div>
        <div><b>Turno:</b> ${p.turno||"â€”"} Â· <b>Quem identificou:</b> ${p.identificou||"â€”"}</div>
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">DescriÃ§Ã£o</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.desc||"â€”"}</div>
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">Plano de aÃ§Ã£o</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.acoes||"â€”"}</div>
      </div>
      ${fotosHtml(p.fotos, "Fotos")}
    `;
  }

  if(o.tipo==="ambiental"){
    return `
      ${head}
      <div style="font-size:12px;line-height:1.45;color:#334;">
        <div><b>Local:</b> ${p.local||"â€”"} Â· <b>Tipo:</b> ${p.tipo||"â€”"} Â· <b>ResponsÃ¡vel:</b> ${p.responsavel||"â€”"}</div>
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">DescriÃ§Ã£o</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.desc||"â€”"}</div>
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">Medidas</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.medidas||"â€”"}</div>
      </div>
      ${fotosHtml(p.fotos, "Fotos")}
    `;
  }

  if(o.tipo==="evidencia"){
    return `
      ${head}
      <div style="font-size:12px;line-height:1.45;color:#334;">
        <div><b>TÃ­tulo:</b> ${p.titulo||"â€”"} Â· <b>Ãrea:</b> ${p.area||"â€”"} Â· <b>ResponsÃ¡vel:</b> ${p.responsavel||"â€”"}</div>
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">SituaÃ§Ã£o (antes)</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.descAntes||"â€”"}</div>
      </div>
      ${fotosHtml(p.fotosAntes, "Fotos ANTES")}
      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">Melhoria (depois)</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.descDepois||"â€”"}</div>
      </div>
      ${fotosHtml(p.fotosDepois, "Fotos DEPOIS")}
    `;
  }

  if(o.tipo==="apr"){
    return `
      ${head}
      <div style="font-size:12px;line-height:1.45;color:#334;">
        <div><b>Macro:</b> ${p.macro||"â€”"} Â· <b>Ãrea:</b> ${p.area||"â€”"} Â· <b>Setor:</b> ${p.setor||"â€”"}</div>
        <div><b>Turno:</b> ${p.turno||"â€”"} Â· <b>ResponsÃ¡vel:</b> ${p.responsavel||"â€”"} Â· <b>Equipe:</b> ${p.equipe||"â€”"}</div>
        <div><b>Atividades:</b> ${(p.atividades||[]).join(" Â· ")||"â€”"}</div>
        ${ (p.etapas && p.etapas.length) ? `
          <div style="margin-top:10px;">
            <div style="font-weight:900;color:#003b5c;">Etapas (organizado)</div>
            ${ p.etapas.map((e,ix)=>`
              <div style="margin-top:6px;padding:8px;border:1px solid #e5e7eb;border-radius:12px;background:#f8fafc;">
                <div style="font-weight:900;color:#0f172a;">${ix+1}. ${(e.titulo||"Etapa")}</div>
                <div style="font-size:12px;color:#334;">
                  ${ e.local ? `<div><b>Local:</b> ${e.local}</div>` : `` }
                  ${ e.perigos ? `<div><b>Perigos:</b> ${e.perigos}</div>` : `` }
                  ${ e.controles ? `<div><b>Controles:</b> ${e.controles}</div>` : `` }
                  ${ e.epi ? `<div><b>EPI/EPC:</b> ${e.epi}</div>` : `` }
                  ${ e.respPrazo ? `<div><b>Resp./prazo:</b> ${e.respPrazo}</div>` : `` }
                  ${ e.risco ? `<div><b>Risco:</b> ${e.risco}</div>` : `` }
                  ${ e.status ? `<div><b>Status:</b> ${e.status}</div>` : `` }
                </div>
              </div>
            `).join("") }
          </div>
        ` : `` }
      </div>

      ${ (p.pcrc && ((p.pcrc.pcrcMulti && p.pcrc.pcrcMulti.length) || p.pcrc.pcrcId)) ? `
        <div style="margin-top:10px;">
          <div style="font-weight:900;color:#003b5c;">PCRC â€” Riscos e Controles</div>
          <div style="font-size:12px;color:#334;">
            ${ (p.pcrc.pcrcMulti && p.pcrc.pcrcMulti.length) ? `
              ${ p.pcrc.pcrcMulti.map(it=>{
                const cat = (typeof PCRC_CATALOG!=="undefined") ? PCRC_CATALOG.find(x=>x.id===it.pcrcId) : null;
                const title = `${cat?.emoji||'ğŸ§©'} ${it.pcrcId} â€” ${cat?.nome||''}`;
                return `
                  <div style="margin-top:8px;padding:8px;border:1px solid #e5e7eb;border-radius:12px;background:#f8fafc;">
                    <div style="font-weight:900;color:#0f172a;">${title}</div>
                    ${ (it.riscos && it.riscos.length) ? `<div><b>Riscos (X):</b> ${it.riscos.join(' Â· ')}</div>` : `` }
                    ${ (it.controles && it.controles.length) ? `<div><b>Controles (X):</b> ${it.controles.join(' Â· ')}</div>` : `` }
                    ${ it.outrosRiscos ? `<div><b>Outros riscos:</b> ${it.outrosRiscos}</div>` : `` }
                    ${ it.outrosControles ? `<div><b>Outros controles:</b> ${it.outrosControles}</div>` : `` }
                    ${ it.obs ? `<div><b>Obs.:</b> ${it.obs}</div>` : `` }
                  </div>
                `;
              }).join('') }
            ` : `
              <div><b>PCRC:</b> ${p.pcrc.pcrcId || "â€”"}</div>
              ${ (p.pcrc.riscos && p.pcrc.riscos.length) ? `<div><b>Riscos (X):</b> ${p.pcrc.riscos.join(" Â· ")}</div>` : `` }
              ${ (p.pcrc.controles && p.pcrc.controles.length) ? `<div><b>Controles (X):</b> ${p.pcrc.controles.join(" Â· ")}</div>` : `` }
              ${ p.pcrc.outrosRiscos ? `<div><b>Outros riscos:</b> ${p.pcrc.outrosRiscos}</div>` : `` }
              ${ p.pcrc.outrosControles ? `<div><b>Outros controles:</b> ${p.pcrc.outrosControles}</div>` : `` }
              ${ p.pcrc.obs ? `<div><b>Obs.:</b> ${p.pcrc.obs}</div>` : `` }
            ` }
          </div>
        </div>
      ` : `` }

      ${ (p.bloqueio && (p.bloqueio.checks || p.bloqueio.local || p.bloqueio.resp || p.bloqueio.dataHora || p.bloqueio.obs || p.bloqueio.descricao)) ? `
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff5f5;">
          <div style="font-weight:900;color:#dc2626;">ğŸ”’ Bloqueio â€” Checklist</div>
          <div style="font-size:12px;color:#334;">
            ${ p.bloqueio.local ? `<div><b>Local/Equip.:</b> ${p.bloqueio.local}</div>` : `` }
            ${ p.bloqueio.resp ? `<div><b>ResponsÃ¡vel:</b> ${p.bloqueio.resp}</div>` : `` }
            ${ p.bloqueio.dataHora ? `<div><b>Data/Hora:</b> ${p.bloqueio.dataHora}</div>` : `` }
            ${ p.bloqueio.obs ? `<div><b>Obs.:</b> ${p.bloqueio.obs}</div>` : `` }
            <div style="margin-top:8px;">
              <b>Itens:</b>
              <div style="margin-top:6px;margin-left:8px;">
                ${ (typeof BLOQ_CHECKLIST!=="undefined" && Array.isArray(BLOQ_CHECKLIST) && BLOQ_CHECKLIST.length) ?
                  BLOQ_CHECKLIST.map((t,i)=>{
                    const k = 'c'+(i+1);
                    const ck = !!(p.bloqueio.checks||{})[k];
                    return `<div>${ck?'â˜’':'â˜'} ${t}</div>`;
                  }).join('')
                  : Object.keys(p.bloqueio.checks||{}).map(k=>`<div>${(p.bloqueio.checks||{})[k]?'â˜’':'â˜'} ${k}</div>`).join('')
                }
              </div>
            </div>
            ${ p.bloqueio.descricao ? `<div style="margin-top:8px;"><b>DescriÃ§Ã£o:</b> ${p.bloqueio.descricao}</div>` : `` }
          </div>
        </div>
      ` : `` }

      

      ${ (p.epi_saude && (p.epi_saude.epis || p.epi_saude.saude)) ? `
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f0fdf4;">
          <div style="font-weight:900;color:#166534;">ğŸ§¤ EPIs & SaÃºde Ocupacional</div>
          <div style="font-size:12px;color:#334;">
            ${ (p.epi_saude.epis && Array.isArray(p.epi_saude.epis.itens) && p.epi_saude.epis.itens.length) ? `
              <div style="margin-top:6px;"><b>EPIs necessÃ¡rios (â˜’):</b> ${p.epi_saude.epis.itens.join(' Â· ')}</div>
            ` : `` }
            ${ (p.epi_saude.epis && p.epi_saude.epis.justificativa) ? `<div style="margin-top:6px;"><b>Justificativa:</b> ${p.epi_saude.epis.justificativa}</div>` : `` }

            ${ (p.epi_saude.saude && p.epi_saude.saude.agentes) ? `
              <div style="margin-top:10px;"><b>ğŸ§ª Agentes Ambientais</b></div>
              ${ (p.epi_saude.saude.agentes.riscos && p.epi_saude.saude.agentes.riscos.length) ? `<div style="margin-left:8px;margin-top:4px;"><b>Riscos (â˜’):</b> ${p.epi_saude.saude.agentes.riscos.join(' Â· ')}</div>` : `` }
              ${ (p.epi_saude.saude.agentes.controles && p.epi_saude.saude.agentes.controles.length) ? `<div style="margin-left:8px;margin-top:4px;"><b>Controles (â˜’):</b> ${p.epi_saude.saude.agentes.controles.join(' Â· ')}</div>` : `` }
              ${ p.epi_saude.saude.agentes.outrosRiscos ? `<div style="margin-left:8px;margin-top:4px;"><b>Outros riscos:</b> ${p.epi_saude.saude.agentes.outrosRiscos}</div>` : `` }
              ${ p.epi_saude.saude.agentes.outrosControles ? `<div style="margin-left:8px;margin-top:4px;"><b>Outros controles:</b> ${p.epi_saude.saude.agentes.outrosControles}</div>` : `` }
            ` : `` }

            ${ (p.epi_saude.saude && p.epi_saude.saude.esforco) ? `
              <div style="margin-top:10px;"><b>ğŸ’ª EsforÃ§o FÃ­sico</b></div>
              ${ (p.epi_saude.saude.esforco.riscos && p.epi_saude.saude.esforco.riscos.length) ? `<div style="margin-left:8px;margin-top:4px;"><b>Riscos (â˜’):</b> ${p.epi_saude.saude.esforco.riscos.join(' Â· ')}</div>` : `` }
              ${ (p.epi_saude.saude.esforco.controles && p.epi_saude.saude.esforco.controles.length) ? `<div style="margin-left:8px;margin-top:4px;"><b>Controles (â˜’):</b> ${p.epi_saude.saude.esforco.controles.join(' Â· ')}</div>` : `` }
              ${ p.epi_saude.saude.esforco.outrosRiscos ? `<div style="margin-left:8px;margin-top:4px;"><b>Outros riscos:</b> ${p.epi_saude.saude.esforco.outrosRiscos}</div>` : `` }
              ${ p.epi_saude.saude.esforco.outrosControles ? `<div style="margin-left:8px;margin-top:4px;"><b>Outros controles:</b> ${p.epi_saude.saude.esforco.outrosControles}</div>` : `` }
            ` : `` }
          </div>
        </div>
      ` : `` }

      ${ (p.executantes && p.executantes.length) ? `
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f8fafc;">
          <div style="font-weight:900;color:#003b5c;">ğŸ§‘â€ğŸ”§ Executantes</div>
          <div style="font-size:12px;color:#334;">
            ${ p.executantes.map((ex,i)=>`
              <div style="margin-top:8px;padding-top:8px;border-top:1px dashed #d1d5db;">
                <div><b>${ex.nome||'â€”'}</b> Â· <b>Chapa:</b> ${ex.chapa||'â€”'}</div>
                ${ ex.assinaturaDataUrl ? `<div style="margin-top:6px;"><img src="${ex.assinaturaDataUrl}" style="width:220px;max-width:100%;border:1px solid #e5e7eb;border-radius:10px;background:#fff;"></div>` : `<div style="margin-top:4px;color:#6b7280;font-size:11px;">Assinatura nÃ£o registrada.</div>` }
              </div>
            `).join('') }
          </div>
        </div>
      ` : `` }
<div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">Perigos / ConsequÃªncias / Controles</div>
        <div style="font-size:12px;color:#334;white-space:pre-wrap;">${p.texto||"â€”"}</div>
      </div>
      ${fotosHtml(p.fotos, "Fotos")}
    `;
  }

  return `${head}<div style="font-size:12px;">Registro nÃ£o suportado.</div>`;
}

window.selectForReport = (id)=>{
  const o = db.find(x=>x.id===id);
  if(!o){ alert("Registro nÃ£o encontrado."); return; }
  relAtual = o;
  $("#previewRel").innerHTML = buildReportHTML(o);
  setSection("sec-relatorios");
};

async function gerarPDF(){
  if(!relAtual){ alert("Selecione um registro no Banco de Dados (botÃ£o PDF)."); return; }
  const el = document.createElement("div");
  el.style.width="800px";
  el.style.background="#fff";
  el.style.padding="14px";
  el.innerHTML = buildReportHTML(relAtual);
  document.body.appendChild(el);

  const canvas = await html2canvas(el, {scale:2, useCORS:true});
  const imgData = canvas.toDataURL("image/png");
  document.body.removeChild(el);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const margin = 20;
  const imgW = pageW - margin*2;
  const imgH = canvas.height * imgW / canvas.width;

  let y = margin;
  if(imgH <= pageH - margin*2){
    pdf.addImage(imgData,'PNG',margin,margin,imgW,imgH);
  }else{
    // PaginaÃ§Ã£o simples: recorta por pÃ¡ginas
    let remaining = imgH;
    let position = 0;
    while(remaining > 0){
      pdf.addImage(imgData,'PNG',margin,margin - position,imgW,imgH);
      remaining -= (pageH - margin*2);
      position += (pageH - margin*2);
      if(remaining>0) pdf.addPage();
    }
  }

  const isLesao = relAtual.tipo==="acidente" && relAtual.payload?.tipo==="com_lesao";
  const nome = isLesao ? "Relatorio_Acidente_Com_Lesao_CONTERPLAN.pdf" : `Relatorio_${relAtual.tipo.toUpperCase()}_CONTERPLAN.pdf`;
  pdf.save(nome);
}

$("#btnGerarPDF").addEventListener("click", gerarPDF);

$("#btnCopiarTexto").addEventListener("click", async ()=>{
  if(!relAtual){ alert("Selecione um registro no Banco de Dados (botÃ£o PDF)."); return; }
  const tmp = document.createElement("textarea");
  tmp.value = $("#previewRel").innerText;
  document.body.appendChild(tmp);
  tmp.select();
  document.execCommand("copy");
  document.body.removeChild(tmp);
  alert("Texto copiado. Cole no WhatsApp/E-mail.");
});

$("#btnWhats").addEventListener("click", ()=>{
  if(!relAtual){ alert("Selecione um registro no Banco de Dados (botÃ£o PDF)."); return; }
  const txt = encodeURIComponent($("#previewRel").innerText.slice(0,3500));
  window.open("https://wa.me/?text="+txt, "_blank");
});

$("#btnEmail").addEventListener("click", ()=>{
  if(!relAtual){ alert("Selecione um registro no Banco de Dados (botÃ£o PDF)."); return; }
  const subject = encodeURIComponent("RelatÃ³rio SGI / APR â€“ CONTERPLAN ("+relAtual.tipo.toUpperCase()+")");
  const body = encodeURIComponent($("#previewRel").innerText);
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
});

/* =========================
   Export / Import JSON
   ========================= */
$("#btnExportJson").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "CONTERPLAN_sgi_apr_backup.json";
  a.click();
});

$("#importJson").addEventListener("change", (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const arr = JSON.parse(r.result);
      if(Array.isArray(arr)){
        // merge por id
        const map = new Map(db.map(x=>[x.id,x]));
        arr.forEach(x=>{
          if(x && x.id && !map.has(x.id)) map.set(x.id, x);
        });
        db = Array.from(map.values()).sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||""));
        saveDB();
        renderAll(); atualizarDashboard();
        alert("Importado com sucesso.");
      }else{
        alert("Arquivo invÃ¡lido.");
      }
    }catch(err){
      console.error(err);
      alert("NÃ£o foi possÃ­vel importar.");
    }
  };
  r.readAsText(file);
});

/* =========================
   Filters
   ========================= */
$("#btnFiltrar").addEventListener("click", renderBanco);
$("#btnLimparFiltro").addEventListener("click", ()=>{
  clearInputs(["fIni","fFim","fTexto"]);
  $("#fTipo").value=""; $("#fRisco").value="";
  renderBanco();
});

/* =========================
   Config & Supabase Sync
   ========================= */
function updateSyncUI(state, text){
  const dot = $("#dotSync");
  const txt = $("#txtSync");
  txt.textContent = text || "Offline";
  dot.classList.remove("off","err");
  if(state==="ok"){ dot.classList.add("dot"); dot.classList.remove("off"); }
  if(state==="off"){ dot.classList.add("off"); }
  if(state==="err"){ dot.classList.add("err"); }
}
function initSupabase(){
  if(!cfg.supUrl || !cfg.supKey) { supa=null; updateSyncUI("off","Offline"); return; }
  try{
    supa = window.supabase.createClient(cfg.supUrl, cfg.supKey);
    updateSyncUI("ok","Nuvem pronta");
  }catch(e){
    console.error(e);
    supa=null;
    updateSyncUI("err","Erro Supabase");
  }
}
$("#btnSalvarCfg").addEventListener("click", ()=>{
  cfg.hh = Number($("#cfgHH").value||0);
  cfg.diasMes = Number($("#cfgDiasMes").value||0);
  cfg.supUrl = safeText($("#cfgSupURL").value);
  cfg.supKey = safeText($("#cfgSupKey").value);
  cfg.supTable = safeText($("#cfgSupTable").value) || "sgiCONTERPLAN_registros";
  saveCFG();
  initSupabase();
  atualizarDashboard();
  alert("ConfiguraÃ§Ãµes salvas.");
});

$("#btnSync").addEventListener("click", async ()=>{
  if(!supa){ alert("Configure Supabase URL/Key primeiro."); return; }
  try{
    updateSyncUI("ok","Sincronizandoâ€¦");
    const table = cfg.supTable || "sgiCONTERPLAN_registros";
    const payload = db.map(o=>({
      id:o.id,
      tipo:o.tipo,
      data:o.payload?.data || null,
      setor:o.setor || null,
      risco:o.risco || null,
      payload:o // jsonb
    }));
    const { error } = await supa.from(table).upsert(payload, { onConflict:"id" });
    if(error) throw error;
    updateSyncUI("ok","Sincronizado");
    alert("Registros enviados para a nuvem.");
  }catch(e){
    console.error(e);
    updateSyncUI("err","Erro na sync");
    alert("Erro ao sincronizar. Veja o console.");
  }
});

$("#btnLimparTudo").addEventListener("click", ()=>{
  if(confirm("Apagar TODOS os dados deste dispositivo? Isso nÃ£o apaga o Supabase.")){
    localStorage.removeItem(LS_KEY);
    db=[];
    renderAll(); atualizarDashboard();
    alert("Dados locais apagados.");
  }
});

/* =========================
   Dashboard Charts
   ========================= */
const charts = { tipos:null, setores:null, perda:null, apr:null, ncStatus:null, ncPareto:null };

function getMonthRange(){
  const now = new Date();
  const y=now.getFullYear(), m=now.getMonth();
  return {y,m};
}
function filtrarMesAtual(){
  const {y,m} = getMonthRange();
  return db.filter(o=>o.dataISO && isSameMonth(o.dataISO,y,m));
}
function calcTF(acidentesComPerda, hh){
  if(!hh) return null;
  return (acidentesComPerda * 1000000 / hh);
}
function calcTG(diasPerdidos, hh){
  if(!hh) return null;
  return (diasPerdidos * 1000000 / hh);
}

function atualizarDashboard(){
  const now = new Date();
  $("#hoje").textContent = now.toLocaleString("pt-BR", {dateStyle:"short", timeStyle:"short"});

  const mes = filtrarMesAtual();
  $("#badgeMesAtual").textContent = now.toLocaleDateString("pt-BR",{month:"long", year:"numeric"});

  $("#kpiTotalMes").textContent = mes.length;
  const tiposCount = {acidente:0,nc:0,ambiental:0,evidencia:0,apr:0};
  mes.forEach(o=> tiposCount[o.tipo] = (tiposCount[o.tipo]||0)+1);
  $("#kpiTotalMesSub").textContent = `Acid ${tiposCount.acidente} Â· NC ${tiposCount.nc} Â· Amb ${tiposCount.ambiental} Â· Evid ${tiposCount.evidencia} Â· APR ${tiposCount.apr}`;

  const acidentes = mes.filter(o=>o.tipo==="acidente");
  const comLesao = acidentes.filter(o=>o.payload?.tipo==="com_lesao").length;
  const semPerda = acidentes.filter(o=>o.payload?.tipo==="sem_lesao").length;
  $("#kpiAcidentesMes").textContent = acidentes.length;
  $("#kpiAcidentesMesSub").textContent = `${comLesao} com lesÃ£o Â· ${semPerda} sem perda`;

  const hh = Number(cfg.hh||0);
  const diasFix = Number(cfg.diasMes||0);
  const diasSomados = acidentes.reduce((s,o)=> s + Number(o.payload?.dias||0), 0);
  const dias = diasFix>0 ? diasFix : diasSomados;
  const tf = calcTF(comLesao, hh);
  const tg = calcTG(dias, hh);
  $("#kpiTF").textContent = (tf==null) ? "â€”" : tf.toFixed(2);
  $("#kpiTG").textContent = (tg==null) ? "Configure HH em Config" : `TG: ${tg.toFixed(2)} (dias=${dias})`;

  // Charts
  const ctxTipos = $("#chartTipos").getContext("2d");
  if(charts.tipos) charts.tipos.destroy();
  charts.tipos = new Chart(ctxTipos, {
    type:"doughnut",
    data:{ labels:["Acidente","NC","Ambiental","EvidÃªncia","APR"], datasets:[{ data:[tiposCount.acidente,tiposCount.nc,tiposCount.ambiental,tiposCount.evidencia,tiposCount.apr] }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}} }
  });

  // Ranking setores (acidente + nc)
  const mapSet = {};
  mes.filter(o=>o.tipo==="acidente" || o.tipo==="nc").forEach(o=>{
    const p=o.payload||{};
    const s = safeText(p.setor || p.local || p.area || o.setor || "Sem setor");
    mapSet[s]=(mapSet[s]||0)+1;
  });
  const top = Object.entries(mapSet).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const labels = top.map(x=>x[0]);
  const values = top.map(x=>x[1]);
  const ctxSet = $("#chartSetores").getContext("2d");
  if(charts.setores) charts.setores.destroy();
  charts.setores = new Chart(ctxSet, {
    type:"bar",
    data:{ labels, datasets:[{ data:values }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{font:{size:10}}}} }
  });

  // Perda x sem perda (acidentes)
  const ctxPerda = $("#chartPerda").getContext("2d");
  if(charts.perda) charts.perda.destroy();
  charts.perda = new Chart(ctxPerda, {
    type:"bar",
    data:{ labels:["Com lesÃ£o","Sem perda","Quase"], datasets:[{ data:[
      comLesao,
      semPerda,
      acidentes.filter(o=>o.payload?.tipo==="quase").length
    ]}]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });

  // APR por macro
  const mapApr = {};
  mes.filter(o=>o.tipo==="apr").forEach(o=>{
    const macro = safeText(o.payload?.macro||"Sem macro");
    mapApr[macro]=(mapApr[macro]||0)+1;
  });
  const labApr = Object.keys(mapApr);
  const datApr = Object.values(mapApr);
  const ctxApr = $("#chartAprMacro").getContext("2d");
  if(charts.apr) charts.apr.destroy();
  charts.apr = new Chart(ctxApr, {
    type:"bar",
    data:{ labels:labApr, datasets:[{ data:datApr }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{font:{size:10}}}} }
  });

  // Evita â€œbarra andando sozinhaâ€: estabiliza tamanho dos charts
  resizeCharts();


  // === BI: NÃƒO CONFORMIDADES (estilo Minitab) ===
  const ncs = mes.filter(r => r.tipo === 'nc');
  const ncOpen = ncs.filter(r => (r.payload?.status || '') !== 'ConcluÃ­do').length;
  const ncAtend = ncs.filter(r => (r.payload?.status || '') === 'ConcluÃ­do').length;

  const elNC = document.getElementById('chartNCStatus');
  if(elNC){
    const ctx = elNC.getContext('2d');
    if(charts.ncStatus){ try{ charts.ncStatus.destroy(); }catch(e){} charts.ncStatus=null; }
    charts.ncStatus = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Em aberto', 'Atendidas'],
        datasets: [{ data: [ncOpen, ncAtend] }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { callbacks: { label: (c)=> `${c.label}: ${c.parsed}` } }
        }
      }
    });
  }

  // Pareto por tipo (Minitab-like)
  const elPareto = document.getElementById('chartNCPareto');
  if(elPareto){
    const map = {};
    for(const r of ncs){
      const k = (r.payload?.tipo || 'Sem tipo').trim() || 'Sem tipo';
      map[k] = (map[k]||0) + 1;
    }
    const items = Object.entries(map).sort((a,b)=>b[1]-a[1]);
    const labels = items.map(x=>x[0]);
    const values = items.map(x=>x[1]);
    const total = values.reduce((a,b)=>a+b,0) || 1;
    let acc = 0;
    const cum = values.map(v => { acc += v; return Math.round((acc/total)*100); });

    const ctx = elPareto.getContext('2d');
    if(charts.ncPareto){ try{ charts.ncPareto.destroy(); }catch(e){} charts.ncPareto=null; }
    charts.ncPareto = new Chart(ctx, {
      data: {
        labels,
        datasets: [
          { type:'bar', label:'OcorrÃªncias', data: values, yAxisID:'y' },
          { type:'line', label:'% acumulado', data: cum, yAxisID:'y1', tension:0.2 }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        scales:{
          y:{ beginAtZero:true, title:{ display:true, text:'OcorrÃªncias' } },
          y1:{ beginAtZero:true, max:100, position:'right', grid:{ drawOnChartArea:false }, title:{ display:true, text:'% acumulado' } }
        }
      }
    });
  }

}
function resizeCharts(){
  Object.values(charts).forEach(ch=>{
    try{ ch && ch.resize(); }catch(e){}
  });
}

/* =========================
   Init
   ========================= */
(function init(){
  
/* =========================
   Limpar banco de dados (TOTAL) â€“ igual Ã  v3_8
   ========================= */
function limparBancoTotal(){
  if(!confirm("âš ï¸ ATENÃ‡ÃƒO: Esta aÃ§Ã£o apagarÃ¡ TODOS os registros salvos neste dispositivo.\n\nEsta aÃ§Ã£o Ã© IRREVERSÃVEL. Deseja continuar?")) return;

  // Zera memÃ³ria do app
  db = [];
  try{ saveDB(); }catch(e){}

  // Remove do localStorage (por garantia)
  try{ localStorage.removeItem(LS_KEY); }catch(e){}

  // Remove do IndexedDB (por garantia)
  if(window.indexedDB){
    idbOpen().then(dbi=>{
      try{
        const tx = dbi.transaction(IDB_STORE, "readwrite");
        tx.objectStore(IDB_STORE).delete(LS_KEY);
        tx.oncomplete = ()=>{ try{ dbi.close(); }catch(e){} };
        tx.onerror = ()=>{ try{ dbi.close(); }catch(e){} };
      }catch(e){
        try{ dbi.close(); }catch(_){}
      }
    }).catch(()=>{});
  }

  // Re-render para sumir imediatamente (sem precisar â€œatualizarâ€ manualmente)
  try{ renderAll(); }catch(e){}
  try{ atualizarDashboard(); }catch(e){}
  toast("âœ… Banco de dados limpo (TOTAL).");
}

// Bind seguro (inclusive se o botÃ£o estiver fora do fluxo normal do DOM no mobile)
function bindLimparBancoTotal(){
  const btn = document.getElementById("btnLimparBancoTotal") || document.getElementById("btnLimparBanco");
  if(!btn) return;
  btn.addEventListener("click", limparBancoTotal, {passive:true});
}

// --- FIX: botÃ£o "Checklist Talude â€” PrioritÃ¡rio" nÃ£o pode sumir ao alternar opÃ§Ãµes/abas ---
function ensureTaludeButtonVisible(){
  const chips = document.getElementById("chipsMina");
  if(!chips) return;

  // tenta achar botÃ£o existente
  let btn = document.getElementById("btnTaludeMina");

  // se algum re-render removeu o botÃ£o, recria
  if(!btn){
    const parent = chips.parentElement || chips;
    // cria uma linha para o botÃ£o (sem mexer no restante)
    const row = document.createElement("div");
    row.className = "row";
    row.style.cssText = "display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;";
    btn = document.createElement("button");
    btn.className = "btn btn-attn btn-sm";
    btn.type = "button";
    btn.id = "btnTaludeMina";
    btn.textContent = "â›°ï¸ Checklist Talude â€” PrioritÃ¡rio";
    row.appendChild(btn);
    parent.insertBefore(row, chips);
  }

  // re-bind seguro (uma vez)
  if(!btn.dataset.bound){
    btn.addEventListener("click", (e)=>{
      e.preventDefault();
      try { applyTaludePresetMina(); } catch(err){ console.warn(err); }
    }, {passive:false});
    btn.dataset.bound = "1";
  }

  // garante visÃ­vel quando voltar
  btn.style.display = "";
}

// garante binding apÃ³s DOM e tambÃ©m apÃ³s mudanÃ§as de aba/layout
window.addEventListener("DOMContentLoaded", ()=> setTimeout(bindLimparBancoTotal, 50));
setTimeout(bindLimparBancoTotal, 300);

loadCFG();
  loadDB();

  $("#cfgHH").value = cfg.hh || 0;
  $("#cfgDiasMes").value = cfg.diasMes || 0;
  $("#cfgSupURL").value = cfg.supUrl || "";
  $("#cfgSupKey").value = cfg.supKey || "";
  $("#cfgSupTable").value = cfg.supTable || "sgiCONTERPLAN_registros";

  initSupabase();
  renderAll();
  atualizarDashboard();

  // corrigir â€œrolagem andandoâ€: nÃ£o manter foco em canvas
  document.addEventListener("wheel", (e)=>{
    const t = e.target;
    if(t && t.tagName==="CANVAS") t.blur?.();
  }, {passive:true});
})();



</script>
<script>
/* =========================
   CONTROLES ESPECÃFICOS (v6.1) â€” FIX REAL
   - Estoque / Treinamentos / SaÃºde / ASO / Engenharia-RDO
   - PersistÃªncia prÃ³pria (separada do banco principal)
   - MantÃ©m tudo que jÃ¡ funciona na v3 intacto
   ========================= */

(function(){
  'use strict';

  // Helpers
  const el = (id)=>document.getElementById(id);
  const toast = window.toast || ((m)=>alert(m));
  const safeText = (v)=> (v??'').toString().trim();
  const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
  const nowISO = ()=> new Date().toISOString();

  // Storage helpers (localStorage + IndexedDB do SGI se existir)
  const LS = {
    ESTOQUE: 'CONTERPLAN_CONTROLES_ESTOQUE',
    TREIN:   'CONTERPLAN_CONTROLES_TREINAMENTOS',
    SAUDE:   'CONTERPLAN_CONTROLES_SAUDE',
    ASO:     'CONTERPLAN_CONTROLES_ASO',
    RDO:     'CONTERPLAN_CONTROLES_RDO',
    RESIDUOS: 'CONTERPLAN_CONTROLES_RESIDUOS'
  };

  async function idbSetMaybe(key, val){
    try{ if(typeof window.idbSet==='function') await window.idbSet(key, val); }catch(e){}
  }
  async function idbGetMaybe(key){
    try{ if(typeof window.idbGet==='function') return await window.idbGet(key); }catch(e){}
    return null;
  }
  async function saveK(key, obj){
    const payload = JSON.stringify(obj);
    try{ localStorage.setItem(key, payload); }catch(e){}
    await idbSetMaybe(key, payload);
  }
  async function loadK(key, fallback){
    try{ const raw = localStorage.getItem(key); if(raw) return JSON.parse(raw); }catch(e){}
    const raw2 = await idbGetMaybe(key);
    if(raw2){ try{ return JSON.parse(raw2); }catch(e){} }
    return fallback;
  }


  // =========================
  // PDF helper (HTML -> PDF com paginaÃ§Ã£o automÃ¡tica)
  // =========================
  async function exportHTMLToPDF(htmlStr, filename){
    if(!(window.jspdf && window.jspdf.jsPDF) || typeof html2canvas!=='function'){
      alert('Bibliotecas de PDF indisponÃ­veis.');
      return;
    }
    const host = document.createElement('div');
    host.style.position='fixed';
    host.style.left='-10000px';
    host.style.top='0';
    host.style.width='800px';
    host.style.background='#fff';
    host.style.padding='14px';
    host.innerHTML = htmlStr;
    document.body.appendChild(host);

    const canvas = await html2canvas(host, {scale:2, useCORS:true});
    const imgData = canvas.toDataURL('image/png');
    document.body.removeChild(host);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'pt', format:'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    // fit image to page width with margins
    const margin = 24;
    const imgW = pageW - margin*2;
    const imgH = canvas.height * (imgW / canvas.width);

    let y = margin;
    let remaining = imgH;
    let sourceY = 0;
    // draw page by slicing big image vertically
    const pageCanvas = document.createElement('canvas');
    const ctx = pageCanvas.getContext('2d');
    const pagePxH = Math.floor(canvas.width * ((pageH - margin*2) / imgW));
    pageCanvas.width = canvas.width;
    pageCanvas.height = pagePxH;

    let page = 0;
    while(remaining > 0){
      if(page>0) pdf.addPage();
      ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
      ctx.drawImage(canvas, 0, sourceY, canvas.width, pagePxH, 0, 0, canvas.width, pagePxH);
      const pageImg = pageCanvas.toDataURL('image/png');
      const drawH = (pageH - margin*2);
      pdf.addImage(pageImg, 'PNG', margin, margin, imgW, drawH);
      remaining -= drawH;
      sourceY += pagePxH;
      page += 1;
    }

    pdf.save(filename || 'relatorio.pdf');
  }


  // =========================
  // ESTOQUE
  // =========================
  const EPIS_BASE = [
    ['tyvek','Tyvek'],['luva_anti_corte','Luva Anti Corte'],['luva_ag_mecanicos','Luva Ag. MecÃ¢nicos'],
    ['oculos_protecao_uv','Ã“culos ProteÃ§Ã£o UV'],['oculos_incolor','Ã“culos Incolor'],['perneira','Perneira'],
    ['protetor_auricular','Protetor Auricular'],['cinto_trab_altura','Cinto p/ Trab. Altura'],
    ['botina_operacional','Botina Operacional'],['protetor_solar','Protetor Solar'],['repelente','Repelente'],
    ['balaclava','Balaclava'],['chapeu_arabe','ChapÃ©u Ãrabe'],['botina_pvc_cano_curto','Botina PVC Cano Curto'],
    ['botina_pvc_canolongo','Botina PVC Cano Longo (7Leguas)'],['protetor_tipo_concha','Protetor Tipo Concha'],
    ['camisa_operacional','Camisa Operacional'],['calca_operacional','CalÃ§a Operacional'],['macacao_mecanico','MacacÃ£o para MecÃ¢nico']
  ];

  let estoqueDB = []; // [{epiId, epiNome, entradas, saidas, saldo, minimo, valorUnitario, historico:[] }]
  let assinatura = { dataURL:'', modo:'nenhum' };
  let chartEstoque = null;
  let chartDashControles = null;

  function seedEstoqueSeVazio(){
    if(!Array.isArray(estoqueDB) || estoqueDB.length===0){
      estoqueDB = EPIS_BASE.map(([id,nome])=>({
        epiId:id, epiNome:nome,
        entradas:0, saidas:0, saldo:0,
        minimo:1, valorUnitario:0,
        historico:[]
      }));
    }
  }

  function setupAssinatura(){
    const box = el('assinaturaCanvas');
    if(!box) return;
    box.innerHTML = '<canvas id="assinaturaCanvasEl" style="width:100%;height:150px;touch-action:none;"></canvas>';
    const c = el('assinaturaCanvasEl');
    if(!c) return;
    const ctx = c.getContext('2d');

    function resize(){
      const r = box.getBoundingClientRect();
      c.width = Math.max(300, Math.floor(r.width||300));
      c.height = 150;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#111';
      ctx.clearRect(0,0,c.width,c.height);
      if(assinatura.dataURL){
        const img = new Image();
        img.onload = ()=>{ ctx.drawImage(img, 0,0, c.width, c.height); };
        img.src = assinatura.dataURL;
      }
    }

    let drawing = false;
    function pos(e){
      const rect = c.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (c.width / rect.width);
      const y = (e.clientY - rect.top) * (c.height / rect.height);
      return {x,y};
    }

    c.addEventListener('pointerdown', (e)=>{ e.preventDefault(); drawing = true; assinatura.modo='manual'; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
    c.addEventListener('pointermove', (e)=>{ if(!drawing) return; e.preventDefault(); const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); assinatura.dataURL=c.toDataURL('image/png'); });
    window.addEventListener('pointerup', ()=>{ drawing=false; });

    window.addEventListener('resize', ()=>setTimeout(resize, 50));
    setTimeout(resize, 50);

    const btnLimpar = el('btnLimparAssinatura');
    if(btnLimpar) btnLimpar.addEventListener('click', ()=>{ assinatura={dataURL:'', modo:'nenhum'}; ctx.clearRect(0,0,c.width,c.height); });
    const btnPadrao = el('btnAssinaturaPadrao');
    if(btnPadrao) btnPadrao.addEventListener('click', ()=>{
      ctx.clearRect(0,0,c.width,c.height);
      ctx.font = '22px Arial';
      ctx.fillText('ASSINADO', 20, 80);
      assinatura = {dataURL: c.toDataURL('image/png'), modo:'padrao'};
    });
  }

  function renderEstoque(){
    // KPIs
    const total = estoqueDB.reduce((a,e)=>a+(Number(e.saldo)||0),0);
    const criticos = estoqueDB.filter(e=>(Number(e.saldo)||0) <= (Number(e.minimo)||0)).length;
    const valorTotal = estoqueDB.reduce((a,e)=>a+((Number(e.saldo)||0)*(Number(e.valorUnitario)||0)),0);

    if(el('kpiEstoqueTotal')) el('kpiEstoqueTotal').textContent = String(total);
    if(el('kpiEstoqueCriticoDet')) el('kpiEstoqueCriticoDet').textContent = String(criticos);
    if(el('kpiValorTotal')) el('kpiValorTotal').textContent = 'R$ ' + valorTotal.toFixed(2);

    // tabela resumo
    const tb = el('tbEstoque');
    if(tb){
      tb.innerHTML = estoqueDB.map(epi=>{
        const saldo = Number(epi.saldo)||0;
        const minimo = Number(epi.minimo)||0;
        const status = saldo <= 0 ? 'ESGOTADO' : (saldo<=minimo ? 'CRÃTICO' : 'OK');
        const tag = status==='OK' ? '<span class="tag t-treinamento">OK</span>' : '<span class="tag t-aso">'+status+'</span>';
        const valorU = Number(epi.valorUnitario)||0;
        const vTotal = saldo*valorU;
        return `<tr>
          <td>${epi.epiNome}</td>
          <td>${Number(epi.entradas)||0}</td>
          <td>${Number(epi.saidas)||0}</td>
          <td><b>${saldo}</b></td>
          <td>${minimo}</td>
          <td>${tag}</td>
          <td>R$ ${valorU.toFixed(2)}</td>
          <td>R$ ${vTotal.toFixed(2)}</td>
          <td><button class="btn btn-sm btn-outline" data-act="min" data-id="${epi.epiId}">MÃ­n</button></td>
        </tr>`;
      }).join('');

      tb.querySelectorAll('button[data-act="min"]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const id=b.getAttribute('data-id');
          const epi=estoqueDB.find(x=>x.epiId===id);
          if(!epi) return;
          const n=prompt('Definir estoque mÃ­nimo para '+epi.epiNome+':', String(epi.minimo??1));
          if(n===null) return;
          const v=Number(n);
          if(!Number.isFinite(v) || v<0) return toast('Valor invÃ¡lido');
          epi.minimo=v;
          await saveK(LS.ESTOQUE, estoqueDB);
          renderEstoque();
          renderBancoControles();
    renderDashControles();
        });
      });
    }

    // histÃ³rico
    const th = el('tbHistoricoEstoque');
    if(th){
      const hist = estoqueDB.flatMap(e=>(e.historico||[]).map(h=>({epiNome:e.epiNome, ...h})))
        .sort((a,b)=> String(b.dataISO||'').localeCompare(String(a.dataISO||'')));
      th.innerHTML = hist.slice(0,200).map(m=>`<tr>
        <td>${(m.dataISO||'').slice(0,16).replace('T',' ')}</td>
        <td>${m.tipo||''}</td>
        <td>${m.epiNome||''}</td>
        <td>${m.qtd||''}</td>
        <td>${m.colaborador||''}</td>
        <td>${m.setor||''}</td>
        <td>${m.responsavel||''}</td>
        <td></td>
      </tr>`).join('');
    }

    // chart
    try{
      const c = el('chartEstoque');
      if(c && window.Chart){
        const labels = estoqueDB.map(e=>e.epiNome);
        const entradas = estoqueDB.map(e=>Number(e.entradas)||0);
        const saidas = estoqueDB.map(e=>Number(e.saidas)||0);
        if(chartEstoque) chartEstoque.destroy();
        chartEstoque = new Chart(c, {
          type:'bar',
          data:{labels, datasets:[{label:'Entradas', data:entradas},{label:'SaÃ­das', data:saidas}]},
          options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{x:{ticks:{autoSkip:true, maxRotation:60, minRotation:0}}}}
        });
      }
    }catch(e){}

    // KPIs de saÃ­das mÃªs (simples)
    try{
      const mes = new Date().toISOString().slice(0,7);
      const hist = estoqueDB.flatMap(e=>e.historico||[]);
      const saidasMes = hist.filter(h=>h.tipo==='saida' && (h.dataISO||'').slice(0,7)===mes).reduce((a,h)=>a+(Number(h.qtd)||0),0);
      if(el('kpiSaidasMes')) el('kpiSaidasMes').textContent = String(saidasMes);
    }catch(e){}
  }

  function renderDashControles(){
    try{
      // KPIs
      if(el('kpiDashEstoque')) el('kpiDashEstoque').textContent = String((estoqueDB||[]).length);
      if(el('kpiDashTrein'))   el('kpiDashTrein').textContent   = String((treinDB||[]).length);
      if(el('kpiDashSaude'))   el('kpiDashSaude').textContent   = String((saudeDB||[]).length);
      if(el('kpiDashASO'))     el('kpiDashASO').textContent     = String((asoDB||[]).length);
      if(el('kpiDashRDO'))     el('kpiDashRDO').textContent     = String((rdoDB||[]).length);

      // Chart
      const c = el('chartDashControles');
      if(c && window.Chart){
        const labels = ['Estoque','Treinamentos','SaÃºde','ASO','RDO'];
        const data = [
          (estoqueDB||[]).length,
          (treinDB||[]).length,
          (saudeDB||[]).length,
          (asoDB||[]).length,
          (rdoDB||[]).length
        ];
        if(chartDashControles) chartDashControles.destroy();
        chartDashControles = new Chart(c, {
          type:'bar',
          data:{labels, datasets:[{label:'Registros', data}]},
          options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
        });
      }
    }catch(e){}
  }

  function limparFormEstoque(){
    ['estoqueTipo','estoqueEPI','estoqueQuantidade','estoqueValor','estoqueColaborador','estoqueCPF','estoqueFuncao','estoqueSetor','estoqueObs'].forEach(id=>{ if(el(id)) el(id).value=''; });
    if(el('estoqueQuantidade')) el('estoqueQuantidade').value = 1;
  }

  async function salvarMovEstoque(){
    const tipo = el('estoqueTipo')?.value || '';
    const epiId = el('estoqueEPI')?.value || '';
    const qtd = Number(el('estoqueQuantidade')?.value || 0);
    const valor = Number(el('estoqueValor')?.value || 0);
    const colaborador = safeText(el('estoqueColaborador')?.value);
    const cpf = safeText(el('estoqueCPF')?.value);
    const funcao = safeText(el('estoqueFuncao')?.value);
    const setor = el('estoqueSetor')?.value || '';
    const obs = safeText(el('estoqueObs')?.value);

    if(!tipo || !epiId || !qtd || qtd<=0 || !setor) return toast('Preencha: Tipo, EPI, Quantidade e Setor.');
    if(tipo==='saida' && !assinatura.dataURL) return toast('Assinatura obrigatÃ³ria para SAÃDA.');

    const epi = estoqueDB.find(e=>e.epiId===epiId);
    if(!epi) return toast('EPI nÃ£o encontrado.');

    const mov = {
      id: uid(),
      dataISO: nowISO(),
      tipo, qtd, valor,
      colaborador, cpf, funcao,
      setor,
      obs,
      assinatura: assinatura.dataURL || ''
    };

    epi.historico = epi.historico || [];
    epi.historico.unshift({...mov, epiId, epiNome: epi.epiNome});

    if(tipo==='entrada' || tipo==='devolucao' || tipo==='ajuste'){
      epi.entradas = (Number(epi.entradas)||0) + qtd;
      epi.saldo = (Number(epi.saldo)||0) + qtd;
      if(valor>0) epi.valorUnitario = valor;
    } else if(tipo==='saida'){
      epi.saidas = (Number(epi.saidas)||0) + qtd;
      epi.saldo = (Number(epi.saldo)||0) - qtd;
    }

    await saveK(LS.ESTOQUE, estoqueDB);
    renderEstoque();
    renderBancoControles();

    // integra no banco principal sem quebrar o existente (opcional)
    try{
      if(Array.isArray(window.db)){
        window.db.unshift({id:uid(), tipo:'estoque', dataISO:mov.dataISO, setor, risco:(Number(epi.saldo)||0)<=(Number(epi.minimo)||0)?'CrÃ­tico':'Rotina', createdAt:mov.dataISO, payload:{epi:epi.epiNome, mov}});
        if(typeof window.saveDB==='function') window.saveDB();
        if(typeof window.renderBanco==='function') window.renderBanco();
        if(typeof window.atualizarDashboard==='function') window.atualizarDashboard();
      }
    }catch(e){}

    toast('MovimentaÃ§Ã£o salva.');
  }

  function relatorioEstoque(){
    const linhas = estoqueDB.map(e=>`${e.epiNome}: saldo ${e.saldo} (mÃ­n ${e.minimo})`).join('\n');
    alert('RelatÃ³rio (resumo)\n\n'+linhas);
  }
  function alertasEstoque(){
    const crit = estoqueDB.filter(e=>(Number(e.saldo)||0) <= (Number(e.minimo)||0));
    if(!crit.length) return toast('Sem alertas.');
    alert('ALERTAS (abaixo do mÃ­nimo)\n\n'+crit.map(e=>`${e.epiNome}: saldo ${e.saldo} (mÃ­n ${e.minimo})`).join('\n'));
  }

  // =========================
  // TREINAMENTOS
  // =========================
  let treinDB = []; // [{id,nr,nome,data,duracao,instrutor,local,participantes:[{nome,cpf,funcao}],conteudo, anexos:[] }]

  function parseParticipantes(txt){
    return (txt||'').split('\n').map(l=>l.trim()).filter(Boolean).map(l=>{
      const parts = l.split(';');
      return {nome:safeText(parts[0]||''), cpf:safeText(parts[1]||''), funcao:safeText(parts[2]||'')};
    }).filter(p=>p.nome);
  }

  async function filesToDataURLs(input){
    const files = Array.from(input?.files||[]);
    const out=[];
    for(const f of files){
      out.push(await new Promise((resolve)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve({name:f.name, type:f.type, data:String(fr.result||'')});
        fr.onerror=()=>resolve({name:f.name, type:f.type, data:''});
        fr.readAsDataURL(f);
      }));
    }
    return out;
  }

  function renderTreinamentos(){
    const tb = el('tbTreinamentos');
    if(tb){
      tb.innerHTML = treinDB.map(t=>{
        const nPart=(t.participantes||[]).length;
        return `<tr>
          <td>${(t.data||'').slice(0,10)}</td>
          <td>${t.nome||''}</td>
          <td>${t.duracao||''}</td>
          <td>${nPart}</td>
          <td>${t.instrutor||''}</td>
          <td>${t.validadeTexto||''}</td>
          <td><button class="btn btn-sm btn-outline" data-act="ver" data-id="${t.id}">ğŸ‘ï¸</button>
              <button class="btn btn-sm btn-outline" data-act="del" data-id="${t.id}">ğŸ—‘ï¸</button></td>
        </tr>`;
      }).join('');

      tb.querySelectorAll('button[data-act="del"]').forEach(b=>b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-id');
        treinDB = treinDB.filter(x=>x.id!==id);
        await saveK(LS.TREIN, treinDB);
        renderTreinamentos();
        renderBancoControles();
      }));

      tb.querySelectorAll('button[data-act="ver"]').forEach(b=>b.addEventListener('click', ()=>{
        const id=b.getAttribute('data-id');
        const t=treinDB.find(x=>x.id===id);
        if(!t) return;
        alert(`Treinamento: ${t.nome}\nData: ${t.data}\nInstrutor: ${t.instrutor}\nLocal: ${t.local}\nDuraÃ§Ã£o: ${t.duracao}h\n\nParticipantes:\n` + (t.participantes||[]).map(p=>`${p.nome} - ${p.cpf} - ${p.funcao}`).join('\n'));
      }));
    }

    if(el('kpiTotalTreinamentos')) el('kpiTotalTreinamentos').textContent = String(treinDB.length);
    const hh = treinDB.reduce((a,t)=>a + (Number(t.duracao)||0) * ((t.participantes||[]).length||0), 0);
    if(el('kpiHHTreinamentos')) el('kpiHHTreinamentos').textContent = 'HH: ' + hh;
  
    renderDashControles();
}

  async function salvarTreinamento(){
    const nr = el('treinamentoNR')?.value || '';
    const outro = safeText(el('treinamentoOutro')?.value);
    const nome = nr==='outro' ? outro : (el('treinamentoNR')?.selectedOptions?.[0]?.textContent || '').split(' - ')[0];
    const data = el('treinamentoData')?.value || '';
    const duracao = Number(el('treinamentoDuracao')?.value || 0);
    const instrutor = safeText(el('treinamentoInstrutor')?.value);
    const local = safeText(el('treinamentoLocal')?.value);
    const participantesTxt = el('treinamentoParticipantes')?.value || '';
    const conteudo = safeText(el('treinamentoConteudo')?.value);

    if(!nome || !data || !duracao || !instrutor || !local || !participantesTxt) return toast('Preencha os campos obrigatÃ³rios.');
    const participantes = parseParticipantes(participantesTxt);
    if(!participantes.length) return toast('Lista de participantes vazia.');

    const anexos = await filesToDataURLs(el('treinamentoAnexos'));

    const t = {id:uid(), nr, nome, data, duracao, instrutor, local, participantes, conteudo, anexos, criadoEm:nowISO()};
    treinDB.unshift(t);
    await saveK(LS.TREIN, treinDB);
    renderTreinamentos();
    renderBancoControles();

    try{
      if(Array.isArray(window.db)){
        window.db.unshift({id:uid(), tipo:'treinamentos', dataISO:new Date(data+'T00:00:00').toISOString(), setor:'Treinamentos', risco:'Rotina', createdAt:nowISO(), payload:t});
        if(typeof window.saveDB==='function') window.saveDB();
        if(typeof window.renderBanco==='function') window.renderBanco();
        if(typeof window.atualizarDashboard==='function') window.atualizarDashboard();
      }
    }catch(e){}

    toast('Treinamento salvo.');
  }

  function limparTreinamento(){
    ['treinamentoNR','treinamentoOutro','treinamentoData','treinamentoDuracao','treinamentoInstrutor','treinamentoLocal','treinamentoParticipantes','treinamentoConteudo'].forEach(id=>{ if(el(id)) el(id).value=''; });
    const div = el('divOutroTreinamento');
    if(div) div.style.display = 'none';
    if(el('treinamentoAnexos')) el('treinamentoAnexos').value='';
  }

  function importarTreinamento(){
    const txt = prompt('Cole a lista de participantes (um por linha: Nome;CPF;FunÃ§Ã£o):');
    if(txt===null) return;
    if(el('treinamentoParticipantes')) el('treinamentoParticipantes').value = txt;
  }

  function gerarCertificados(){
    if(!treinDB.length) return toast('Nenhum treinamento cadastrado.');
    const t = treinDB[0];
    if(window.jspdf && window.jspdf.jsPDF){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'landscape'});
      t.participantes.forEach((p, idx)=>{
        if(idx>0) doc.addPage();
        doc.setFontSize(22);
        doc.text('CERTIFICADO', 148, 30, {align:'center'});
        doc.setFontSize(12);
        doc.text(`Certificamos que ${p.nome} (CPF: ${p.cpf||'-'}) participou do treinamento ${t.nome}.`, 148, 55, {align:'center'});
        doc.text(`Data: ${t.data}  |  Carga horÃ¡ria: ${t.duracao} horas`, 148, 70, {align:'center'});
        doc.text(`Instrutor: ${t.instrutor}  |  Local: ${t.local}`, 148, 85, {align:'center'});
        doc.setFontSize(10);
        doc.text('CONTERPLAN', 148, 120, {align:'center'});
      });
      doc.save('certificados_'+(t.data||'')+'.pdf');
      return;
    }
    alert('Certificados: jsPDF nÃ£o disponÃ­vel.');
  }

  // =========================
  // SAÃšDE OCUPACIONAL
  // =========================
  let saudeDB = []; // [{id,nome,cpf,funcao,setor,tipoExame,dataExame,validadeISO,resultado,obs, anexos:{aso,ficha,laudos[]}}]

  function calcValidadeISO(dataExame, validadeSel, validadeOutroMeses){
    if(!dataExame) return '';
    const d = new Date(dataExame+'T00:00:00');
    let meses = 0;
    if(validadeSel==='outro') meses = Number(validadeOutroMeses||0);
    else meses = Number(validadeSel||0);
    if(!meses) return '';
    const v = new Date(d);
    v.setMonth(v.getMonth()+meses);
    return v.toISOString();
  }

  function diasRestantes(validadeISO){
    if(!validadeISO) return '';
    const hoje = new Date();
    const v = new Date(validadeISO);
    return Math.floor((v-hoje)/(1000*60*60*24));
  }

  function renderSaude(){
    const tb = el('tbSaude');
    if(tb){
      tb.innerHTML = saudeDB.map(r=>{
        const dr = diasRestantes(r.validadeISO);
        return `<tr>
          <td>${r.nome||''}</td>
          <td>${r.cpf||''}</td>
          <td>${r.funcao||''}</td>
          <td>${r.setor||''}</td>
          <td>${(r.dataExame||'').slice(0,10)}</td>
          <td>${(r.validadeISO||'').slice(0,10)}</td>
          <td>${r.resultado||''}</td>
          <td><button class="btn btn-sm btn-outline" data-del="${r.id}">ğŸ—‘ï¸</button></td>
        </tr>`;
      }).join('');

      tb.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-del');
        saudeDB = saudeDB.filter(x=>x.id!==id);
        await saveK(LS.SAUDE, saudeDB);
        renderSaude();
        renderBancoControles();
      }));
    }
  
    renderDashControles();
}

  async function salvarSaude(){
    const nome = safeText(el('saudeNome')?.value);
    const cpf = safeText(el('saudeCPF')?.value);
    const funcao = safeText(el('saudeFuncao')?.value);
    const setor = el('saudeSetor')?.value || '';
    const tipoExame = el('saudeTipoExame')?.value || '';
    const dataExame = el('saudeDataExame')?.value || '';
    const validadeSel = el('saudeValidade')?.value || '';
    const validadeOutro = Number(el('saudeValidadeOutro')?.value || 0);
    const resultado = el('saudeResultado')?.value || '';
    const obs = safeText(el('saudeObservacoes')?.value);

    if(!nome || !cpf || !funcao || !setor || !tipoExame || !dataExame || !validadeSel || !resultado){
      return toast('Preencha todos os campos obrigatÃ³rios (incluindo data e validade).');
    }

    const validadeISO = calcValidadeISO(dataExame, validadeSel, validadeOutro);
    if(!validadeISO) return toast('Validade invÃ¡lida.');

    const anexos = {
      aso: (await filesToDataURLs(el('saudeAnexoASO')))[0] || null,
      ficha: (await filesToDataURLs(el('saudeAnexoFicha')))[0] || null,
      laudos: await filesToDataURLs(el('saudeAnexoLaudos'))
    };

    const r = {id:uid(), nome, cpf, funcao, setor, tipoExame, dataExame, validadeISO, resultado, obs, anexos, criadoEm:nowISO()};
    saudeDB.unshift(r);
    await saveK(LS.SAUDE, saudeDB);
    renderSaude();
    renderBancoControles();

    try{
      if(Array.isArray(window.db)){
        window.db.unshift({id:uid(), tipo:'saude', dataISO:new Date(dataExame+'T00:00:00').toISOString(), setor:'SaÃºde Ocupacional', risco: diasRestantes(validadeISO)<0?'CrÃ­tico':'Rotina', createdAt:nowISO(), payload:r});
        if(typeof window.saveDB==='function') window.saveDB();
        if(typeof window.renderBanco==='function') window.renderBanco();
        if(typeof window.atualizarDashboard==='function') window.atualizarDashboard();
      }
    }catch(e){}

    toast('Registro de SaÃºde salvo.');
  }

  function limparSaude(){
    ['saudeNome','saudeCPF','saudeFuncao','saudeSetor','saudeTipoExame','saudeDataExame','saudeValidade','saudeValidadeOutro','saudeResultado','saudeObservacoes'].forEach(id=>{ if(el(id)) el(id).value=''; });
    if(el('saudeAnexoASO')) el('saudeAnexoASO').value='';
    if(el('saudeAnexoFicha')) el('saudeAnexoFicha').value='';
    if(el('saudeAnexoLaudos')) el('saudeAnexoLaudos').value='';
  }

  // =========================
  // ASO (CONTROLE)
  // =========================
  let asoDB = []; // [{id,nome,cpf,funcao,setor,empresa,empresaOutra,admissao,status,ultimoISO,validadeISO,obs}]

  function statusASO(validadeISO){
    if(!validadeISO) return 'pendente';
    const hoje = new Date();
    const v = new Date(validadeISO);
    const diff = Math.floor((v-hoje)/(1000*60*60*24));
    if(diff < 0) return 'vencido';
    if(diff <= 30) return 'avencer';
    return 'emdia';
  }

  function renderASO(){
    const tb = el('tbControleASO');
    if(tb){
      tb.innerHTML = asoDB.map(a=>{
        const st = statusASO(a.validadeISO);
        const dias = diasRestantes(a.validadeISO);
        const badge = st==='vencido' ? '<span class="status-badge status-vencido">Vencido</span>' : (st==='avencer' ? '<span class="status-badge status-alerta">A vencer</span>' : '<span class="status-badge status-ativo">Em dia</span>');
        const emp = a.empresa==='outra' ? (a.empresaOutra||'Outra') : (a.empresa||'');
        return `<tr>
          <td>${badge}</td>
          <td>${a.nome||''}</td>
          <td>${a.funcao||''}</td>
          <td>${a.setor||''}</td>
          <td>${emp}</td>
          <td>${(a.ultimoISO||'').slice(0,10)}</td>
          <td>${(a.validadeISO||'').slice(0,10)}</td>
          <td>${(dias!==''?dias:'')}</td>
          <td><button class="btn btn-sm btn-outline" data-del="${a.id}">ğŸ—‘ï¸</button></td>
        </tr>`;
      }).join('');

      tb.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-del');
        asoDB = asoDB.filter(x=>x.id!==id);
        await saveK(LS.ASO, asoDB);
        renderASO();
        renderBancoControles();
      }));
    }

    const efetivo = asoDB.length;
    const ativos = asoDB.filter(a=>(a.status||'')==='ativo').length;
    const emdia = asoDB.filter(a=>statusASO(a.validadeISO)==='emdia').length;
    const av = asoDB.filter(a=>statusASO(a.validadeISO)==='avencer').length;
    const venc = asoDB.filter(a=>statusASO(a.validadeISO)==='vencido').length;

    if(el('kpiEfetivoTotal')) el('kpiEfetivoTotal').textContent = String(efetivo);
    if(el('kpiEfetivoAtivoASO')) el('kpiEfetivoAtivoASO').textContent = 'Ativos: '+ativos;
    if(el('kpiASOsEmDia')) el('kpiASOsEmDia').textContent = String(emdia);
    if(el('kpiASOsAVencer')) el('kpiASOsAVencer').textContent = String(av);
    if(el('kpiASOsVencidosControle')) el('kpiASOsVencidosControle').textContent = String(venc);
    if(el('kpiPercentualDia')) el('kpiPercentualDia').textContent = (efetivo?Math.round((emdia/efetivo)*100):0)+'%';
  
    renderDashControles();
}

  async function salvarASO(){
    const nome = safeText(el('asoNome')?.value);
    const cpf = safeText(el('asoCPF')?.value);
    const funcao = safeText(el('asoFuncao')?.value);
    const setor = el('asoSetor')?.value || '';
    const empresa = el('asoEmpresa')?.value || 'CONTERPLAN';
    const empresaOutra = safeText(el('asoEmpresaOutra')?.value);
    const admissao = el('asoAdmissao')?.value || '';
    const status = el('asoStatus')?.value || 'ativo';
    const ultimo = el('asoUltimo')?.value || '';
    const validade = el('asoValidade')?.value || '';
    const obs = safeText(el('asoObservacoes')?.value);

    if(!nome || !cpf || !funcao || !setor || !admissao || !ultimo || !validade){
      return toast('Preencha todos os campos obrigatÃ³rios do ASO.');
    }

    const a = {id:uid(), nome, cpf, funcao, setor, empresa, empresaOutra, admissao, status,
      ultimoISO:new Date(ultimo+'T00:00:00').toISOString(),
      validadeISO:new Date(validade+'T00:00:00').toISOString(),
      obs, criadoEm:nowISO()};

    asoDB.unshift(a);
    await saveK(LS.ASO, asoDB);
    renderASO();
    renderBancoControles();

    try{
      if(Array.isArray(window.db)){
        window.db.unshift({id:uid(), tipo:'aso', dataISO:a.validadeISO, setor:'ASO', risco: statusASO(a.validadeISO)==='vencido'?'CrÃ­tico':'Rotina', createdAt:nowISO(), payload:a});
        if(typeof window.saveDB==='function') window.saveDB();
        if(typeof window.renderBanco==='function') window.renderBanco();
        if(typeof window.atualizarDashboard==='function') window.atualizarDashboard();
      }
    }catch(e){}

    toast('Cadastro ASO salvo.');
  }

  function limparASO(){
    ['asoNome','asoCPF','asoFuncao','asoSetor','asoEmpresa','asoEmpresaOutra','asoAdmissao','asoStatus','asoUltimo','asoValidade','asoObservacoes'].forEach(id=>{ if(el(id)) el(id).value=''; });
  }

  function alertasASO(){
    const venc = asoDB.filter(a=>statusASO(a.validadeISO)==='vencido');
    const av = asoDB.filter(a=>statusASO(a.validadeISO)==='avencer');
    if(!venc.length && !av.length) return toast('Sem alertas.');
    alert('ASO - ALERTAS\n\nVencidos:\n'+venc.map(a=>`${a.nome} (${a.cpf})`).join('\n')+'\n\nA vencer:\n'+av.map(a=>`${a.nome} (${(a.validadeISO||'').slice(0,10)})`).join('\n'));
  }

  function toggleOutraEmpresa(){
    const v = el('asoEmpresa')?.value;
    const div = el('divOutraEmpresa');
    if(div) div.style.display = (v==='outra') ? 'block' : 'none';
  }

  async function atualizarASO(){
    const cpf = prompt('CPF do colaborador para atualizar o ASO:');
    if(!cpf) return;
    const rec = asoDB.find(x=>x.cpf===cpf.trim());
    if(!rec) return toast('CPF nÃ£o encontrado no controle de ASO.');
    const novoUltimo = prompt('Nova data de Ãšltimo ASO (AAAA-MM-DD):', (rec.ultimoISO||'').slice(0,10));
    if(novoUltimo===null) return;
    const novaVal = prompt('Nova Validade (AAAA-MM-DD):', (rec.validadeISO||'').slice(0,10));
    if(novaVal===null) return;
    rec.ultimoISO = new Date(novoUltimo+'T00:00:00').toISOString();
    rec.validadeISO = new Date(novaVal+'T00:00:00').toISOString();
    await saveK(LS.ASO, asoDB);
    renderASO();
    renderBancoControles();
    toast('ASO atualizado.');
  }

  // =========================
  // RDO (ENGENHARIA)
  // =========================
  let rdoDB = []; // [{id,data,turno,responsavel,macroarea,areaEspecifica,atividade,descricao,ocorrencias,avanco,clima,choveu,fotos[] , criadoEm}]
  let residuosDB = []; // [{id, tipo, classificacao, quantidade, volume, local, responsavel, descricao, destinacao, transportadora, placa, dataColeta, mtr, anexos:{mtr,cdf,fotos:[]}, status, criadoEm}]

  async function salvarRDO(){
    const data = el('rdoData')?.value || '';
    const turno = el('rdoTurno')?.value || '';
    const responsavel = safeText(el('rdoResponsavel')?.value);
    const macroarea = el('rdoMacroarea')?.value || '';
    const areaEspecifica = safeText(el('rdoAreaEspecifica')?.value);
    const efetivo = Number(el('rdoEfetivoTotal')?.value || 0);

    // atividade pode vir de chips (botÃµes) ou de textarea
    let atividade = '';
    const chipAtivo = document.querySelector('#sec-engenharia .chip.sel');
    if(chipAtivo) atividade = safeText(chipAtivo.textContent);
    if(!atividade) atividade = safeText(el('rdoAtividadeLivre')?.value);

    const descricao = safeText(el('rdoDescricao')?.value);
    const ocorrencias = safeText(el('rdoOcorrencias')?.value);
    const avanco = Number(el('rdoAvancoSlider')?.value || 0);
    const clima = el('rdoClima')?.value || '';
    const choveu = (el('rdoChoveu')?.value || '');

    const fotos = await filesToDataURLs(el('rdoFotos'));

    if(!data || !turno || !responsavel || !macroarea || !areaEspecifica || !atividade){
      return toast('Preencha: Data, Turno, ResponsÃ¡vel, MacroÃ¡rea, Ãrea EspecÃ­fica e Atividade.');
    }

    const r = {id:uid(), data, turno, responsavel, macroarea, areaEspecifica, atividade, descricao, ocorrencias, efetivo, avanco, clima, choveu, fotos, criadoEm:nowISO()};
    rdoDB.unshift(r);
    await saveK(LS.RDO, rdoDB);
    await saveK(LS.RESIDUOS, residuosDB);
    renderRDO();
    renderResiduos();
    renderBancoControles();

    try{
      if(Array.isArray(window.db)){
        window.db.unshift({id:uid(), tipo:'rdo', dataISO:new Date(data+'T00:00:00').toISOString(), setor:'Engenharia/RDO', risco:'Rotina', createdAt:nowISO(), payload:r});
        if(typeof window.saveDB==='function') window.saveDB();
        if(typeof window.renderBanco==='function') window.renderBanco();
        if(typeof window.atualizarDashboard==='function') window.atualizarDashboard();
      }
    }catch(e){}

    toast('RDO salvo.');
  }

  function renderRDO(){
    const tb = el('tbRDO');
    // na sua tela a tabela tem id tbRDO? Se nÃ£o existir, tenta achar a tabela da engenharia
    const tb2 = tb || document.querySelector('#sec-engenharia tbody');
    if(tb2){
      tb2.innerHTML = rdoDB.map(r=>`<tr>
        <td>${(r.data||'').slice(0,10)}</td>
        <td>${r.macroarea||''}</td>
        <td>${r.areaEspecifica||''}</td>
        <td>${r.atividade||''}</td>
        <td>${r.efetivo||''}</td>
        <td>${r.clima||''}</td>
        <td>${r.avanco||0}%</td>
        <td><button class="btn btn-sm btn-outline" data-open="${r.id}">ğŸ‘ï¸ Abrir</button> <button class="btn btn-sm btn-outline" data-pdf="${r.id}">ğŸ“„ PDF</button> <button class="btn btn-sm btn-outline" data-del="${r.id}">ğŸ—‘ï¸</button></td>
      </tr>`).join('');

      tb2.querySelectorAll('button[data-open]').forEach(b=>b.addEventListener('click', ()=>{
        const id=b.getAttribute('data-open');
        openRDO(id);
      }));

      tb2.querySelectorAll('button[data-pdf]').forEach(b=>b.addEventListener('click', ()=>{
        const id=b.getAttribute('data-pdf');
        gerarPDFRDO(id);
      }));

      tb2.querySelectorAll('button[data-del]').forEach(b=>b.addEventListener('click', async ()=>{
        const id=b.getAttribute('data-del');
        rdoDB = rdoDB.filter(x=>x.id!==id);
        await saveK(LS.RDO, rdoDB);
        await saveK(LS.RESIDUOS, residuosDB);
        renderRDO();
        renderResiduos();
        renderBancoControles();
      }));
    }

    // KPIs simples
    try{
      const hoje = new Date().toISOString().slice(0,10);
      const mes = new Date().toISOString().slice(0,7);
      const hojeCount = rdoDB.filter(r=>(r.data||'').slice(0,10)===hoje).length;
      const mesCount = rdoDB.filter(r=>(r.data||'').slice(0,7)===mes).length;
      if(el('kpiRDOsHoje')) el('kpiRDOsHoje').textContent = String(hojeCount);
      if(el('kpiRDOsMes')) el('kpiRDOsMes').textContent = 'Este mÃªs: '+mesCount;
    }catch(e){}
  
    renderDashControles();
}

  function limparRDO(){
    ['rdoData','rdoTurno','rdoResponsavel','rdoMacroarea','rdoAreaEspecifica','rdoEfetivoTotal','rdoDescricao','rdoOcorrencias'].forEach(id=>{ if(el(id)) el(id).value=''; });
    if(el('rdoClima')) el('rdoClima').value='Bom';
    if(el('rdoChoveu')) el('rdoChoveu').value='nao';
    if(el('rdoAvancoSlider')) el('rdoAvancoSlider').value='0';
    if(el('rdoAvancoValor')) el('rdoAvancoValor').textContent='0%';
    if(el('rdoAvancoPct')) el('rdoAvancoPct').textContent='0%';
    if(el('rdoAvancoBar')) el('rdoAvancoBar').style.width='0%';
    if(el('rdoFotos')) el('rdoFotos').value='';
    // desmarca atividade
    $$('#sec-engenharia .chip.sel').forEach(c=>c.classList.remove('sel'));
  }

  function bindChipsAtividade(){
    const chips = Array.from(document.querySelectorAll('#sec-engenharia .chip'));
    chips.forEach(ch=>{
      ch.addEventListener('click', ()=>{
        chips.forEach(x=>x.classList.remove('sel'));
        ch.classList.add('sel');
      });
    });
  }

  function buildRDOReportHTML(r){
    const head = `
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <div style="width:54px;height:54px;border-radius:999px;background:#fff;border:2px solid #0f172a;display:flex;align-items:center;justify-content:center;overflow:hidden;">
          <span style="font-size:26px;">ğŸ› ï¸</span>
        </div>
        <div style="min-width:0;">
          <div style="font-size:16px;font-weight:900;color:#003b5c;">CONTERPLAN â€“ SGI / APR</div>
          <div style="font-size:11px;color:#334;">RelatÃ³rio detalhado â€¢ RDO (Engenharia) â€¢ ID ${r.id}</div>
        </div>
        <div style="margin-left:auto;text-align:right;font-size:11px;color:#334;">
          <div><b>Data:</b> ${(r.data||'').slice(0,10)}</div>
          <div><b>Turno:</b> ${r.turno||'â€”'}</div>
        </div>
      </div>
      <hr>
    `;

    const fotos = (r.fotos||[]).length ? `
      <div style="margin-top:10px;">
        <div style="font-weight:900;color:#003b5c;">Fotos</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
          ${(r.fotos||[]).slice(0,12).map(u=>`<img src="${u}" style="width:180px;height:120px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb;"/>`).join('')}
        </div>
      </div>` : '';

    return head + `
      <div style="font-size:12px;color:#111;">
        <div><b>ResponsÃ¡vel:</b> ${r.responsavel||'â€”'}</div>
        <div><b>MacroÃ¡rea:</b> ${r.macroarea||'â€”'}</div>
        <div><b>Ãrea especÃ­fica:</b> ${r.areaEspecifica||'â€”'}</div>
        <div><b>Atividade:</b> ${r.atividade||'â€”'}</div>
        <div><b>Efetivo:</b> ${r.efetivo||0}</div>
        <div><b>Clima:</b> ${r.clima||'â€”'} â€¢ <b>Choveu:</b> ${r.choveu||'â€”'}</div>
        <div><b>AvanÃ§o:</b> ${r.avanco||0}%</div>
        <div style="margin-top:8px;"><b>DescriÃ§Ã£o:</b><div style="white-space:pre-wrap;">${r.descricao||'â€”'}</div></div>
        <div style="margin-top:8px;"><b>OcorrÃªncias:</b><div style="white-space:pre-wrap;">${r.ocorrencias||'â€”'}</div></div>
      </div>` + fotos;
  }

  function openRDO(id){
    window.__rdoCurrentId = id;
    const r = rdoDB.find(x=>x.id===id);
    if(!r) return toast('RDO nÃ£o encontrado.');
    showModal(`
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:900;color:var(--sam-blue);">RDO (Engenharia) â€” ${ (r.data||'').slice(0,10) } â€¢ Turno ${r.turno||''}</div>
        <div class="badge">${r.id}</div>
      </div>
      <div style="margin-top:8px;font-size:12px;color:#334;">
        <div><b>ResponsÃ¡vel:</b> ${r.responsavel||'â€”'}</div>
        <div><b>MacroÃ¡rea:</b> ${r.macroarea||'â€”'} â€¢ <b>Ãrea:</b> ${r.areaEspecifica||'â€”'}</div>
        <div><b>Atividade:</b> ${r.atividade||'â€”'} â€¢ <b>Efetivo:</b> ${r.efetivo||0} â€¢ <b>AvanÃ§o:</b> ${r.avanco||0}%</div>
        <div style="margin-top:8px;"><b>DescriÃ§Ã£o:</b><div style="white-space:pre-wrap;">${r.descricao||'â€”'}</div></div>
        <div style="margin-top:8px;"><b>OcorrÃªncias:</b><div style="white-space:pre-wrap;">${r.ocorrencias||'â€”'}</div></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="gerarPDFRDO('${r.id}')">ğŸ“„ Gerar PDF deste RDO</button>
      </div>
    `);
  }

  async function gerarPDFRDO(id){
    const r = rdoDB.find(x=>x.id===id);
    if(!r) return toast('RDO nÃ£o encontrado.');
    const wrap = document.createElement('div');
    wrap.style.width='800px';
    wrap.style.background='#fff';
    wrap.style.padding='14px';
    wrap.innerHTML = buildRDOReportHTML(r);
    document.body.appendChild(wrap);

    const canvas = await html2canvas(wrap, {scale:2, useCORS:true});
    const imgData = canvas.toDataURL('image/png');
    document.body.removeChild(wrap);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','pt','a4');
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const margin = 20;
    const imgW = pageW - margin*2;
    const imgH = canvas.height * imgW / canvas.width;

    if(imgH <= pageH - margin*2){
      pdf.addImage(imgData,'PNG',margin,margin,imgW,imgH);
    }else{
      let remaining = imgH;
      let position = 0;
      while(remaining > 0){
        pdf.addImage(imgData,'PNG',margin,margin - position,imgW,imgH);
        remaining -= (pageH - margin*2);
        position += (pageH - margin*2);
        if(remaining>0) pdf.addPage();
      }
    }

    const nome = `RDO_Engenharia_${(r.data||'').slice(0,10)}_${r.turno||''}_CONTERPLAN.pdf`;
    pdf.save(nome);
  }



  // =========================
  // RESÃDUOS
  // =========================
  function limparResiduo(){
    ['residuoTipo','residuoClassificacao','residuoQuantidade','residuoVolume','residuoLocal','residuoResponsavel','residuoDescricao','residuoDestinacao','residuoTransportadora','residuoPlaca','residuoDataColeta','residuoMTR'].forEach(id=>{ const x=el(id); if(x) x.value=''; });
    if(el('residuoAnexoMTR')) el('residuoAnexoMTR').value='';
    if(el('residuoAnexoCDF')) el('residuoAnexoCDF').value='';
    if(el('residuoAnexoFotos')) el('residuoAnexoFotos').value='';
  }

  async function salvarResiduo(){
    const tipo = el('residuoTipo')?.value || '';
    const classificacao = el('residuoClassificacao')?.value || '';
    const quantidade = Number(el('residuoQuantidade')?.value || 0);
    const volume = Number(el('residuoVolume')?.value || 0);
    const local = el('residuoLocal')?.value || '';
    const responsavel = safeText(el('residuoResponsavel')?.value);
    const descricao = safeText(el('residuoDescricao')?.value);
    const destinacao = el('residuoDestinacao')?.value || '';
    const transportadora = safeText(el('residuoTransportadora')?.value);
    const placa = safeText(el('residuoPlaca')?.value);
    const dataColeta = el('residuoDataColeta')?.value || '';
    const mtr = safeText(el('residuoMTR')?.value);

    if(!tipo || !classificacao || !quantidade || !local || !responsavel || !descricao || !destinacao){
      return toast('Preencha os campos obrigatÃ³rios (*).');
    }

    const anexos = {
      mtr: (await filesToDataURLs(el('residuoAnexoMTR')))[0] || null,
      cdf: (await filesToDataURLs(el('residuoAnexoCDF')))[0] || null,
      fotos: await filesToDataURLs(el('residuoAnexoFotos'))
    };

    const residuo = {
      id: uid(),
      tipo, classificacao, quantidade, volume, local, responsavel, descricao,
      destinacao, transportadora, placa, dataColeta, mtr,
      anexos,
      status: dataColeta ? 'Coletado' : 'Pendente',
      criadoEm: nowISO()
    };

    residuosDB.unshift(residuo);
    await saveK(LS.RESIDUOS, residuosDB);
    renderResiduos();
    renderBancoControles();
    limparResiduo();
    toast('ResÃ­duo registrado com sucesso!');
  }

  function agendarColeta(){
    const data = prompt('Data para agendamento da coleta (AAAA-MM-DD):', el('residuoDataColeta')?.value || '');
    if(!data) return;
    if(el('residuoDataColeta')) el('residuoDataColeta').value = data;
    toast(`Coleta agendada para ${data}.`);
  }

  function delResiduo(id){
    if(!confirm('Excluir este registro de resÃ­duo?')) return;
    residuosDB = (residuosDB||[]).filter(r=>r.id!==id);
    saveK(LS.RESIDUOS, residuosDB).then(()=>{ renderResiduos(); renderBancoControles(); toast('Registro excluÃ­do.'); });
  }

  function renderResiduos(){
    const tb = el('tbResiduos');
    const mes = new Date().toISOString().slice(0,7);
    const doMes = (residuosDB||[]).filter(r=>String(r.criadoEm||'').slice(0,7)===mes);
    const peso = doMes.reduce((a,r)=>a + (Number(r.quantidade)||0), 0);
    const pend = doMes.filter(r=>(r.status||'')!=='Coletado').length;
    if(el('kpiResiduosMes')) el('kpiResiduosMes').textContent = String(doMes.length);
    if(el('kpiPesoTotal')) el('kpiPesoTotal').textContent = `Peso: ${peso.toFixed(1)} kg`;
    if(el('kpiResiduosPendentes')) el('kpiResiduosPendentes').textContent = String(pend);

    if(!tb) return;
    const rows = (residuosDB||[]).slice(0,250).map(r=>{
      const dt = (r.criadoEm||'').slice(0,10);
      const tipo = r.tipo||'';
      const cl = r.classificacao||'';
      const qtd = (r.quantidade!=null)? String(r.quantidade):'';
      const loc = r.local||'';
      const dest = r.destinacao||'';
      const st = r.status||'';
      return `<tr>
        <td>${dt}</td>
        <td>${tipo}</td>
        <td>${cl}</td>
        <td>${qtd} kg</td>
        <td>${loc}</td>
        <td>${dest}</td>
        <td>${st}</td>
        <td>${btnRow(`
          <button class="btn btn-outline btn-sm" onclick="window.__pdfResiduo && window.__pdfResiduo('${r.id}')">PDF</button>
          <button class="btn btn-danger btn-sm" onclick="window.__delResiduo && window.__delResiduo('${r.id}')">Del</button>
        `)}</td>
      </tr>`;
    }).join('');
    tb.innerHTML = rows || `<tr><td colspan="8" style="color:#6b7280;">Nenhum resÃ­duo registrado.</td></tr>`;
  }

  function gerarMTR(){
    const alvo = residuosDB?.[0];
    if(!alvo){ toast('Nenhum resÃ­duo salvo para gerar MTR.'); return; }
    if(!(window.jspdf && window.jspdf.jsPDF)) { alert('jsPDF indisponÃ­vel.'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a4'});
    doc.setFontSize(14);
    doc.text('MANIFESTO DE TRANSPORTE DE RESÃDUOS (MTR) â€” CONTERPLAN', 14, 16);
    doc.setFontSize(10);
    let y=28;
    const line=(label,val)=>{ doc.text(`${label}: ${val||'â€”'}`, 14, y); y+=6; };
    line('Data', (alvo.criadoEm||'').slice(0,10));
    line('Tipo', alvo.tipo);
    line('ClassificaÃ§Ã£o', alvo.classificacao);
    line('Quantidade', `${alvo.quantidade||0} kg`);
    line('Volume', alvo.volume? `${alvo.volume} L` : 'â€”');
    line('Local', alvo.local);
    line('ResponsÃ¡vel', alvo.responsavel);
    line('DestinaÃ§Ã£o', alvo.destinacao);
    line('Transportadora', alvo.transportadora);
    line('Placa', alvo.placa);
    line('Data Coleta', alvo.dataColeta);
    line('NÂº MTR', alvo.mtr);
    y+=4;
    doc.text('DescriÃ§Ã£o:', 14, y); y+=6;
    const desc = doc.splitTextToSize(String(alvo.descricao||'â€”'), 180);
    doc.text(desc, 14, y);
    doc.save('MTR_CONTERPLAN_'+(alvo.criadoEm||'').slice(0,10)+'.pdf');
  }

  function gerarPDFResiduos(){
    const html = `
      <div style="font-family:Arial;">
        <div style="display:flex;justify-content:space-between;align-items:flex-end;">
          <div>
            <div style="font-size:16px;font-weight:900;color:#003b5c;">ğŸ—‘ï¸ RelatÃ³rio â€” DestinaÃ§Ã£o de ResÃ­duos</div>
            <div style="font-size:12px;color:#334;">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
          </div>
        </div>
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;">
          <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
              <tr>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Data</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Tipo</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">ClassificaÃ§Ã£o</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Qtd (kg)</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Local</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">DestinaÃ§Ã£o</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Status</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">DescriÃ§Ã£o</th>
              </tr>
            </thead>
            <tbody>
              ${(residuosDB||[]).map(r=>`
                <tr>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(r.criadoEm||'').slice(0,10)}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${r.tipo||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${r.classificacao||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${r.quantidade||0}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${r.local||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${r.destinacao||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${r.status||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;white-space:pre-wrap;">${(r.descricao||'').replace(/</g,'&lt;')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    exportHTMLToPDF(html, 'relatorio_residuos.pdf');
  }

  function gerarPDFResiduo(id){
    const r = (residuosDB||[]).find(x=>x.id===id);
    if(!r){ toast('Registro nÃ£o encontrado.'); return; }
    const html = `
      <div style="font-family:Arial;">
        <div style="font-size:16px;font-weight:900;color:#003b5c;">ğŸ—‘ï¸ Registro de ResÃ­duo</div>
        <div style="font-size:12px;color:#334;">${new Date().toLocaleString('pt-BR')}</div>
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;font-size:12px;">
          <div><b>Data:</b> ${(r.criadoEm||'').slice(0,10)} Â· <b>Status:</b> ${r.status||''}</div>
          <div style="margin-top:6px;"><b>Tipo:</b> ${r.tipo||''} Â· <b>ClassificaÃ§Ã£o:</b> ${r.classificacao||''}</div>
          <div style="margin-top:6px;"><b>Quantidade:</b> ${r.quantidade||0} kg Â· <b>Volume:</b> ${(r.volume||'â€”')}</div>
          <div style="margin-top:6px;"><b>Local:</b> ${r.local||''} Â· <b>ResponsÃ¡vel:</b> ${r.responsavel||''}</div>
          <div style="margin-top:6px;"><b>DestinaÃ§Ã£o:</b> ${r.destinacao||''}</div>
          <div style="margin-top:6px;"><b>Transportadora:</b> ${r.transportadora||''} Â· <b>Placa:</b> ${r.placa||''}</div>
          <div style="margin-top:6px;"><b>Data Coleta:</b> ${r.dataColeta||''} Â· <b>NÂº MTR:</b> ${r.mtr||''}</div>
          <div style="margin-top:10px;"><b>DescriÃ§Ã£o:</b></div>
          <div style="white-space:pre-wrap;">${(r.descricao||'').replace(/</g,'&lt;')}</div>
        </div>
      </div>
    `;
    exportHTMLToPDF(html, 'residuo_'+(r.criadoEm||'').slice(0,10)+'.pdf');
  }

  // UI do slider de avanÃ§o
  function bindRDOAvanco(){
    const sl = el('rdoAvancoSlider');
    const val = el('rdoAvancoValor');
    const bar = el('rdoAvancoBar');
    const pct = el('rdoAvancoPct');
    if(!sl) return;
    const apply = ()=>{
      const v = Number(sl.value||0);
      if(val) val.textContent = v+'%';
      if(bar) bar.style.width = v+'%';
      if(pct) pct.textContent = v+'%';
    };
    sl.addEventListener('input', apply);
    apply();
  }

  // =========================
  // BANCO CONTROLES ESPECÃFICOS
  // =========================
  function resumoLinhaControles(){
    const itens=[];
    // estoque: total de movimentos
    const hist = estoqueDB.flatMap(e=>e.historico||[]);
    if(hist.length) itens.push(...hist.map(h=>({tipo:'Estoque', data:(h.dataISO||''), resumo:`${h.tipo} â€¢ ${h.epiNome||''} â€¢ qtd ${h.qtd||''} â€¢ ${h.setor||''}`})));

    // treinamentos
    if(treinDB.length) itens.push(...treinDB.map(t=>({tipo:'Treinamentos', data:t.data, resumo:`${t.nome} â€¢ ${t.instrutor} â€¢ ${t.local} â€¢ ${t.participantes?.length||0} part.`})));

    // saude
    if(saudeDB.length) itens.push(...saudeDB.map(s=>({tipo:'SaÃºde', data:s.dataExame, resumo:`${s.nome} â€¢ ${s.tipoExame} â€¢ validade ${(s.validadeISO||'').slice(0,10)}`})));

    // aso
    if(asoDB.length) itens.push(...asoDB.map(a=>({tipo:'ASO', data:(a.validadeISO||'').slice(0,10), resumo:`${a.nome} â€¢ ${(a.validadeISO||'').slice(0,10)} â€¢ ${statusASO(a.validadeISO)}`})));

    // rdo
    if(rdoDB.length) itens.push(...rdoDB.map(r=>({tipo:'RDO', data:r.data, resumo:`${r.macroarea} â€¢ ${r.areaEspecifica} â€¢ ${r.atividade}`})));

    return itens.sort((a,b)=>String(b.data||'').localeCompare(String(a.data||'')));
  }

  function renderBancoControles(){
    if(el('kpiBC_Estoque')) el('kpiBC_Estoque').textContent = String((estoqueDB||[]).length);
    if(el('kpiBC_Trein')) el('kpiBC_Trein').textContent = String((treinDB||[]).length);
    if(el('kpiBC_Saude')) el('kpiBC_Saude').textContent = String((saudeDB||[]).length);
    if(el('kpiBC_ASO')) el('kpiBC_ASO').textContent = String((asoDB||[]).length);
    if(el('kpiBC_RDO')) el('kpiBC_RDO').textContent = String((rdoDB||[]).length);

    const tb = el('tbBancoControles');
    if(tb){
      const linhas = resumoLinhaControles().slice(0,250);
      tb.innerHTML = linhas.map((x,idx)=>`<tr>
        <td>${x.tipo}</td>
        <td>${(x.data||'').toString().slice(0,16).replace('T',' ')}</td>
        <td>${x.resumo||''}</td>
        <td></td>
      </tr>`).join('');
    }
  }

  async function exportControles(){
    const payload = {
      version:'v6.1',
      exportedAt: nowISO(),
      estoque: estoqueDB,
      treinamentos: treinDB,
      saude: saudeDB,
      aso: asoDB,
      rdo: rdoDB,
      residuos: residuosDB
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'banco_controles_CONTERPLAN.json';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }

  async function importControles(){
    const input = document.createElement('input');
    input.type='file';
    input.accept='.json,application/json';
    input.onchange = async ()=>{
      const f = input.files?.[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const data = JSON.parse(txt);
        if(data.estoque) estoqueDB = data.estoque;
        if(data.treinamentos) treinDB = data.treinamentos;
        if(data.saude) saudeDB = data.saude;
        if(data.aso) asoDB = data.aso;
        if(data.rdo) rdoDB = data.rdo;
        if(data.residuos) residuosDB = data.residuos;

        await saveK(LS.ESTOQUE, estoqueDB);
        await saveK(LS.TREIN, treinDB);
        await saveK(LS.SAUDE, saudeDB);
        await saveK(LS.ASO, asoDB);
        await saveK(LS.RDO, rdoDB);

        renderEstoque();
        renderTreinamentos();
        renderSaude();
        renderASO();
        renderRDO();
        renderBancoControles();
        toast('ImportaÃ§Ã£o concluÃ­da.');
      }catch(e){
        toast('Arquivo invÃ¡lido.');
      }
    };
    input.click();
  }

  async function limparControles(){
    if(!confirm('Limpar banco de dados dos Controles EspecÃ­ficos?')) return;
    estoqueDB=[]; treinDB=[]; saudeDB=[]; asoDB=[]; rdoDB=[]; residuosDB=[];
    seedEstoqueSeVazio();
    await saveK(LS.ESTOQUE, estoqueDB);
    await saveK(LS.TREIN, treinDB);
    await saveK(LS.SAUDE, saudeDB);
    await saveK(LS.ASO, asoDB);
    await saveK(LS.RDO, rdoDB);
    renderEstoque(); renderTreinamentos(); renderSaude(); renderASO(); renderRDO(); renderResiduos(); renderBancoControles();
    toast('Banco de Controles limpo.');
  }



  // =========================
  // PDFs dos Controles
  // =========================
  function gerarPDFTreinamentos(){
    const html = `
      <div style="font-family:Arial;">
        <div style="font-size:16px;font-weight:900;color:#003b5c;">ğŸ“ RelatÃ³rio â€” Treinamentos</div>
        <div style="font-size:12px;color:#334;">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;">
          <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
              <tr>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Data</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">NR</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Treinamento</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">DuraÃ§Ã£o</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Instrutor</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Participantes</th>
              </tr>
            </thead>
            <tbody>
              ${(treinDB||[]).map(t=>`
                <tr>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${t.data||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${t.nr||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(t.nome||'').replace(/</g,'&lt;')}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${t.duracao||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(t.instrutor||'').replace(/</g,'&lt;')}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(t.participantes||[]).length}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    exportHTMLToPDF(html, 'relatorio_treinamentos.pdf');
  }

  function gerarPDFSaude(){
    const html = `
      <div style="font-family:Arial;">
        <div style="font-size:16px;font-weight:900;color:#003b5c;">ğŸ¥ RelatÃ³rio â€” SaÃºde Ocupacional</div>
        <div style="font-size:12px;color:#334;">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;">
          <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
              <tr>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Colaborador</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">CPF</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">FunÃ§Ã£o</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Setor</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Exame</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Validade</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Resultado</th>
              </tr>
            </thead>
            <tbody>
              ${(saudeDB||[]).map(s=>`
                <tr>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(s.nome||'').replace(/</g,'&lt;')}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${s.cpf||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(s.funcao||'').replace(/</g,'&lt;')}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${s.setor||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${s.tipoExame||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(s.validadeISO||'').slice(0,10)}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${s.resultado||''}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    exportHTMLToPDF(html, 'relatorio_saude.pdf');
  }

  function gerarPDFEstoque(){
    const html = `
      <div style="font-family:Arial;">
        <div style="font-size:16px;font-weight:900;color:#003b5c;">ğŸ“¦ RelatÃ³rio â€” Controle de Estoque</div>
        <div style="font-size:12px;color:#334;">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;">
          <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
              <tr>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">EPI</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Saldo</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">MÃ­nimo</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Entradas</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">SaÃ­das</th>
              </tr>
            </thead>
            <tbody>
              ${(estoqueDB||[]).map(e=>`
                <tr>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(e.epiNome||'').replace(/</g,'&lt;')}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${e.saldo||0}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${e.minimo||0}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${e.entradas||0}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${e.saidas||0}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    exportHTMLToPDF(html, 'relatorio_estoque.pdf');
  }

  function gerarPDFASO(){
    const html = `
      <div style="font-family:Arial;">
        <div style="font-size:16px;font-weight:900;color:#003b5c;">ğŸ©º RelatÃ³rio â€” Controle de ASO</div>
        <div style="font-size:12px;color:#334;">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:12px;padding:10px;">
          <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
              <tr>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Colaborador</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">CPF</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Empresa</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Ãšltimo ASO</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Validade</th>
                <th style="border-bottom:1px solid #e5e7eb;text-align:left;padding:6px;">Status</th>
              </tr>
            </thead>
            <tbody>
              ${(asoDB||[]).map(a=>`
                <tr>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(a.nome||'').replace(/</g,'&lt;')}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${a.cpf||''}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(a.empresa||'').replace(/</g,'&lt;')}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(a.ultimoISO||'').slice(0,10)}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${(a.validadeISO||'').slice(0,10)}</td>
                  <td style="border-bottom:1px solid #f1f5f9;padding:6px;">${statusASO(a.validadeISO)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
    exportHTMLToPDF(html, 'relatorio_aso.pdf');
  }

  // =========================
  // BINDINGS
  // =========================
  function bindAll(){
    // Estoque
    el('btnSalvarEstoque')?.addEventListener('click', salvarMovEstoque);
    el('btnLimparEstoque')?.addEventListener('click', ()=>{ limparFormEstoque(); toast('FormulÃ¡rio limpo.'); });
    el('btnRelatorioEstoque')?.addEventListener('click', gerarPDFEstoque);
    el('btnAlertasEstoque')?.addEventListener('click', alertasEstoque);

    // Treinamentos
    el('treinamentoNR')?.addEventListener('change', ()=>{
      const v = el('treinamentoNR')?.value;
      const div = el('divOutroTreinamento');
      if(div) div.style.display = (v==='outro')?'block':'none';
    });
    el('btnSalvarTreinamento')?.addEventListener('click', salvarTreinamento);
    el('btnLimparTreinamento')?.addEventListener('click', ()=>{ limparTreinamento(); toast('Limpo.'); });
    el('btnGerarCertificados')?.addEventListener('click', gerarCertificados);
    el('btnImportarTreinamento')?.addEventListener('click', importarTreinamento);
    el('btnPDFTreinamentos')?.addEventListener('click', gerarPDFTreinamentos);

    // ResÃ­duos
    el('btnSalvarResiduo')?.addEventListener('click', salvarResiduo);
    el('btnLimparResiduo')?.addEventListener('click', ()=>{ limparResiduo(); toast('Limpo.'); });
    el('btnAgendarColeta')?.addEventListener('click', agendarColeta);
    el('btnGerarMTR')?.addEventListener('click', gerarMTR);
    el('btnPDFResiduos')?.addEventListener('click', gerarPDFResiduos);

    // SaÃºde
    el('btnSalvarSaude')?.addEventListener('click', salvarSaude);
    el('btnLimparSaude')?.addEventListener('click', ()=>{ limparSaude(); toast('Limpo.'); });
    el('btnRelatorioSaude')?.addEventListener('click', gerarPDFSaude);
    el('saudeValidade')?.addEventListener('change', ()=>{
      const v = el('saudeValidade')?.value;
      const other = el('saudeValidadeOutro');
      if(other) other.style.display = (v==='outro')?'block':'none';
    });

    // ASO
    el('asoEmpresa')?.addEventListener('change', toggleOutraEmpresa);
    toggleOutraEmpresa();
    el('btnSalvarASO')?.addEventListener('click', salvarASO);
    el('btnLimparASO')?.addEventListener('click', ()=>{ limparASO(); toast('Limpo.'); });
    el('btnAlertasVencimento')?.addEventListener('click', alertasASO);
    el('btnRelatorioASO')?.addEventListener('click', gerarPDFASO);
    el('btnAtualizarASO')?.addEventListener('click', atualizarASO);

    // RDO
    el('btnSalvarRDO')?.addEventListener('click', salvarRDO);
    el('btnLimparRDO')?.addEventListener('click', ()=>{ limparRDO(); toast('Limpo.'); });
    el('btnCopiarRDOAnterior')?.addEventListener('click', ()=>{
      if(!rdoDB.length) return toast('NÃ£o hÃ¡ RDO anterior.');
      const r=rdoDB[0];
      if(el('rdoDescricao')) el('rdoDescricao').value = r.descricao||'';
      if(el('rdoOcorrencias')) el('rdoOcorrencias').value = r.ocorrencias||'';
      if(el('rdoClima')) el('rdoClima').value = r.clima||'';
      if(el('rdoChoveu')) el('rdoChoveu').value = r.choveu||'';
      if(el('rdoAvancoSlider')) el('rdoAvancoSlider').value = String(r.avanco||0);
      bindRDOAvanco();
      toast('Dados do RDO anterior copiados (ajuste data/atividade conforme necessÃ¡rio).');
    });


    // AvanÃ§o: mostra percentual tambÃ©m na barra
    const updAvanco = ()=>{
      const v = Number(el('rdoAvancoSlider')?.value||0);
      if(el('rdoAvancoValor')) el('rdoAvancoValor').textContent = v + '%';
      if(el('rdoAvancoPct')) el('rdoAvancoPct').textContent = v + '%';
      if(el('rdoAvancoBar')) el('rdoAvancoBar').style.width = Math.max(0,Math.min(100,v)) + '%';
    };
    if(el('rdoAvancoSlider')){
      el('rdoAvancoSlider').addEventListener('input', updAvanco);
      updAvanco();
    }

    // BotÃ£o "Gerar RelatÃ³rio" da Engenharia: gera PDF do Ãºltimo RDO aberto (ou do Ãºltimo salvo)
    if(el('btnGerarRelatorioRDO')){
      el('btnGerarRelatorioRDO').addEventListener('click', ()=>{
        const alvo = window.__rdoCurrentId || (rdoDB[0] && rdoDB[0].id);
        if(alvo) return gerarPDFRDO(alvo);
        toast('Nenhum RDO encontrado para gerar PDF.');
      });
    }

    bindChipsAtividade();
    bindRDOAvanco();

    // Banco Controles
    el('btnExportControles')?.addEventListener('click', exportControles);
    el('btnImportControles')?.addEventListener('click', importControles);
    el('btnLimparControles')?.addEventListener('click', limparControles);
  }

  async function init(){
    estoqueDB = await loadK(LS.ESTOQUE, []);
    seedEstoqueSeVazio();
    await saveK(LS.ESTOQUE, estoqueDB); // garante saldo 0 inicial

    treinDB = await loadK(LS.TREIN, []);
    saudeDB = await loadK(LS.SAUDE, []);
    asoDB = await loadK(LS.ASO, []);
    rdoDB = await loadK(LS.RDO, []);
    residuosDB = await loadK(LS.RESIDUOS, []);

    setupAssinatura();
    bindAll();

    renderEstoque();
    renderTreinamentos();
    renderSaude();
    renderASO();
    renderRDO();
    renderBancoControles();
  }

  // roda mesmo se a inicializaÃ§Ã£o antiga falhar
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>setTimeout(init, 60));
  } else {
    setTimeout(init, 60);
  }

})();


/* ===== APR â€¢ PCRC / BLOQUEIO / EPIs & SAÃšDE / EXECUTANTES (v7.2) ===== */
const PCRC_CATALOG = [
  {id:"PCRC01", emoji:"ğŸšš", nome:"VeÃ­culos RodoviÃ¡rios", riscos:[
    "Atropelamento",
    "Baixa visibilidade por condiÃ§Ãµes climÃ¡ticas",
    "Capotamento / Tombamento",
    "ColisÃ£o de bÃ¡scula em estrutura",
    "ColisÃ£o",
    "Esmagamento da cabine por queda de material",
    "Estouro de pneus",
    "Falha mecÃ¢nica",
    "Queda de carga da carroceria",
    "InteraÃ§Ã£o entre veÃ­culos",
    "InteraÃ§Ã£o entre veÃ­culos e pessoas",
    "InteraÃ§Ã£o entre veÃ­culos e equipamentos",
    "IncÃªndio",
    "Acesso inadequado"
  ], controles:[
    "Check-list prÃ© operacional",
    "Respeitar sinalizaÃ§Ã£o da via",
    "Acesso adequado para carroceria",
    "Gaiola para calibraÃ§Ã£o de pneus",
    "InclinÃ´metro para caminhÃµes bÃ¡scula",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "RÃ¡dio TX/RX (comunicaÃ§Ã£o positiva)",
    "Credencial veÃ­culo / InspeÃ§Ã£o de rampa",
    "Cinto de seguranÃ§a retrÃ¡til",
    "TacÃ³grafo homologado",
    "CondiÃ§Ãµes dos pneus (TWI - Tyre Work Indication)",
    "AutorizaÃ§Ã£o (HH) / Treinamento (habilitaÃ§Ã£o interna)"
  ]},
  {id:"PCRC02", emoji:"ğŸšœ", nome:"Equipamentos MÃ³veis de SuperfÃ­cie", riscos:[
    "Acesso inadequado",
    "Rompimento de esteira de trator",
    "Batida contra",
    "ColisÃ£o",
    "Capotamento / Tombamento",
    "ColisÃ£o em estrutura (bÃ¡scula alta)",
    "Esmagamento da cabine por queda de material",
    "Estouro de pneus",
    "Falha mecÃ¢nica",
    "Queda de carga da carroceria do equipamento",
    "InteraÃ§Ã£o entre veÃ­culos e equipamentos",
    "InteraÃ§Ã£o entre equipamentos e pessoas",
    "IncÃªndio",
    "IncÃªndio / ExplosÃ£o"
  ], controles:[
    "Check-list prÃ© operacional",
    "Gaiola para calibraÃ§Ã£o de pneus",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "Respeitar sinalizaÃ§Ã£o da via",
    "Colete refletivo",
    "Cinto de seguranÃ§a retrÃ¡til",
    "AutorizaÃ§Ã£o (HH) / Treinamento (habilitaÃ§Ã£o interna)",
    "RÃ¡dio TX/RX (comunicaÃ§Ã£o positiva)",
    "SegregaÃ§Ã£o homem x mÃ¡quina (quando aplicÃ¡vel)",
    "Tecnologia anti-colisÃ£o (quando aplicÃ¡vel)"
  ]},
  {id:"PCRC03", emoji:"ğŸ’¥", nome:"Explosivos e Blaster", riscos:[
    "InteraÃ§Ã£o entre equipamentos e pessoas",
    "IncÃªndio",
    "IncÃªndio / ExplosÃ£o"
  ], controles:[
    "RÃ¡dio TX/RX (comunicaÃ§Ã£o positiva)",
    "SegregaÃ§Ã£o homem x mÃ¡quina",
    "HabilitaÃ§Ã£o interna / Treinamento",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "Plano de fogo",
    "ElaboraÃ§Ã£o e cumprimento do plano de seguranÃ§a",
    "VeÃ­culo equipado com sirene",
    "Vias de acesso fechadas",
    "Material intrinsecamente seguro",
    "SPDA â€“ Sistema de proteÃ§Ã£o contra descargas atmosfÃ©ricas (raios corretamente aterrado)",
    "SeguranÃ§a patrimonial para vigiar acessÃ³rios e explosivos",
    "Profissionais habilitados (CREA e Blaster) / HabilitaÃ§Ã£o interna"
  ]},
  {id:"PCRC04", emoji:"ğŸšœ", nome:"Controle de Terreno", riscos:[
    "Acesso inadequado",
    "Desmoronamento de taludes",
    "Instabilidade de taludes e pilhas",
    "Soterramento",
    "InterferÃªncias"
  ], controles:[
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "ETP â€“ PermissÃ£o para trabalho de escavaÃ§Ã£o",
    "GPRS â€“ GPRP/inspeÃ§Ã£o radar (quando aplicÃ¡vel)",
    "LiberaÃ§Ã£o de frente de lavra",
    "Escoramento prolongado acima da borda (quando aplicÃ¡vel)",
    "Monitoramento de crista / marcas / condiÃ§Ãµes do talude",
    "SinalizaÃ§Ã£o e isolamento do talude (disco de estabilidade)"
  ]},
  {id:"PCRC05", emoji:"â˜£ï¸", nome:"Materiais Perigosos", riscos:[
    "Contato com produtos quÃ­micos",
    "Contato com solventes, tintas e vernizes",
    "ExposiÃ§Ã£o a gases",
    "ExposiÃ§Ã£o a vapores quÃ­micos",
    "ExposiÃ§Ã£o a poeiras / particulados",
    "ExposiÃ§Ã£o a fumos metÃ¡licos",
    "IncÃªndio / ExplosÃ£o",
    "ExposiÃ§Ã£o a fontes radioativas"
  ], controles:[
    "FISPQ",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "EPI conforme FISPQ",
    "SegregaÃ§Ã£o de materiais perigosos incompatÃ­veis",
    "AutorizaÃ§Ã£o / Treinamento (habilitaÃ§Ã£o)",
    "DetecÃ§Ã£o de vazamentos / sensores (quando aplicÃ¡vel)",
    "Produto quÃ­mico homologado / liberado"
  ]},
  {id:"PCRC06", emoji:"ğŸ› ï¸", nome:"Ferramentas e Instrumentos", riscos:[
    "Manuseio de instrumentos cortantes ou perfurantes",
    "Queimadura",
    "Contato com parte rotativa",
    "ProjeÃ§Ã£o de objetos / fagulhas",
    "Choque elÃ©trico",
    "Prensamento",
    "ServiÃ§os a quente",
    "Ferramentas improvisadas / defeituosas",
    "RuÃ­do"
  ], controles:[
    "ProteÃ§Ã£o das mÃ£os",
    "Ferramentas do GRPM",
    "InspeÃ§Ã£o de ferramentas",
    "LiberaÃ§Ã£o de ferramentas",
    "Isolamento de atividades",
    "LiberaÃ§Ã£o de trabalho a quente",
    "Ferramentas com dispositivo homem morto (quando aplicÃ¡vel)",
    "EPI adequado"
  ]},
  {id:"PCRC07", emoji:"âš™ï¸", nome:"ProteÃ§Ã£o de Partes MÃ³veis", riscos:[
    "Contato com partes mÃ³veis",
    "Esmagamento",
    "Prensamento"
  ], controles:[
    "Aplicar proteÃ§Ã£o das partes rotativas/esteiras/roletes",
    "Dispositivo de parada de emergÃªncia",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "AutorizaÃ§Ã£o / Treinamento (habilitaÃ§Ã£o)"
  ]},
  {id:"PCRC08", emoji:"ğŸ”Œ", nome:"Isolamento e Bloqueio de Energias", riscos:[
    "Arco elÃ©trico",
    "Choque elÃ©trico",
    "ProjeÃ§Ã£o de lÃ­quido pressurizado",
    "Ar pressurizado",
    "Energia elÃ©trica residual (capacitores)",
    "Energia mecÃ¢nica residual (contra-pesos, cabos tensionados)",
    "MovimentaÃ§Ã£o inesperada de equipamento"
  ], controles:[
    "Bloqueio elÃ©trico",
    "Bloqueio mecÃ¢nico",
    "Bloqueio pneumÃ¡tico",
    "Bloqueio lÃ³gico",
    "Aterramento",
    "NeutralizaÃ§Ã£o de energia residual",
    "Manuseio de bloqueio",
    "PermissÃ£o / autorizaÃ§Ã£o (ETP/PTP)",
    "EPI (arco elÃ©trico)"
  ]},
  {id:"PCRC09", emoji:"ğŸªœ", nome:"Trabalho em Altura", riscos:[
    "Queda de diferenÃ§a de nÃ­vel (â‰¥2m)",
    "Mal sÃºbito",
    "Trabalhos sobrepostos",
    "Tombamento de PTA"
  ], controles:[
    "Cinto de seguranÃ§a",
    "Linha de vida",
    "RÃ¡dio de comunicaÃ§Ã£o (PTA)",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "MediÃ§Ã£o de velocidade do vento (quando aplicÃ¡vel)",
    "AutorizaÃ§Ãµes / Treinamento (NR)"
  ]},
  {id:"PCRC10", emoji:"ğŸ—ï¸", nome:"IÃ§amento", riscos:[
    "Queda de carga suspensa",
    "Tombamento de guindaste / guincho",
    "Empilhadeira (quando aplicÃ¡vel)",
    "Rompimento de acessÃ³rios de iÃ§ar",
    "ExposiÃ§Ã£o ao raio de aÃ§Ã£o da carga"
  ], controles:[
    "Plano de rigging",
    "InspeÃ§Ã£o de equipamentos e acessÃ³rios",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "AmarraÃ§Ã£o da carga",
    "Cinta/corda guia",
    "Check-list prÃ©-uso"
  ]},
  {id:"PCRC11", emoji:"ğŸ“¦", nome:"Queda de Objetos", riscos:[
    "Armazenamento inadequado",
    "Objetos com potencial para queda",
    "Queda de material, ferramentas e equipamentos",
    "Trabalhos sobrepostos"
  ], controles:[
    "Ferramentas amarradas / protegidas",
    "Material fora de risco de queda",
    "OrganizaÃ§Ã£o e limpeza",
    "Isolamento e sinalizaÃ§Ã£o de Ã¡rea (IT 16.2)",
    "ProibiÃ§Ã£o de trabalho sobreposto (quando aplicÃ¡vel)"
  ]},
  {id:"PCRC12", emoji:"ğŸšï¸", nome:"Colapso de Estruturas", riscos:[
    "Colapso de estruturas"
  ], controles:[
    "Isolamento fÃ­sico rÃ­gido",
    "InspeÃ§Ã£o da estrutura",
    "ProteÃ§Ã£o contra sobrecarga",
    "AutorizaÃ§Ã£o / acompanhamento tÃ©cnico"
  ]},
  {id:"PCRC13", emoji:"ğŸ«", nome:"EspaÃ§o Confinado", riscos:[
    "DeficiÃªncia de oxigÃªnio",
    "ExposiÃ§Ã£o a gases",
    "Mal sÃºbito"
  ], controles:[
    "PET (permissÃ£o de entrada/trabalho)",
    "Vigia",
    "ComunicaÃ§Ã£o",
    "MediÃ§Ã£o de gases",
    "Exaustor (quando necessÃ¡rio)",
    "SinalizaÃ§Ã£o de local caracterizado"
  ]},
  {id:"PCRC14", emoji:"ğŸ§¯", nome:"ProjeÃ§Ã£o de Materiais", riscos:[
    "ProjeÃ§Ã£o de materiais",
    "TubulaÃ§Ã£o / mangueira pressurizada"
  ], controles:[
    "InspeÃ§Ã£o de pressÃ£o / mangueira",
    "Isolamento e sinalizaÃ§Ã£o",
    "Uso de lacre",
    "EPI (Ã³culos/face shield)"
  ]},
  {id:"PCRC15", emoji:"ğŸŒŠ", nome:"Afogamento", riscos:[
    "Afogamento",
    "Engolfamento"
  ], controles:[
    "SinalizaÃ§Ã£o de local",
    "Boias com retrÃ¡til (quando aplicÃ¡vel)",
    "Colete salva-vidas",
    "AutorizaÃ§Ã£o para atividade",
    "Trabalho em duplas"
  ]},
  {id:"PCRC16", emoji:"ğŸ’¥", nome:"ExplosÃ£o de Equip./Sist. MecÃ¢nicos", riscos:[
    "ProjeÃ§Ã£o de fragmentos / peÃ§as",
    "Vasos de pressÃ£o",
    "ExplosÃ£o de equipamento / componentes",
    "ExplosÃ£o de conjunto redutor"
  ], controles:[
    "ManutenÃ§Ã£o adequada",
    "ManÃ´metro",
    "VÃ¡lvula corta-chama (quando aplicÃ¡vel)",
    "Extintor de incÃªndio",
    "EPI",
    "Isolamento"
  ]},
  {id:"PCRC17", emoji:"âš¡", nome:"ExplosÃ£o de Equip./Sist. ElÃ©tricos", riscos:[
    "Choque elÃ©trico",
    "Contato com partes elÃ©tricas energizadas",
    "ExposiÃ§Ã£o a calor radiante",
    "IncÃªndio ou explosÃ£o",
    "ProjeÃ§Ã£o de materiais"
  ], controles:[
    "Desligamento da rede",
    "Uniforme/roupa anti-chama (quando aplicÃ¡vel)",
    "EPI arco elÃ©trico",
    "Bloqueio de energia",
    "InspeÃ§Ã£o"
  ]},
  {id:"PCRC18", emoji:"ğŸ”Œ", nome:"Contato com Rede ElÃ©trica (aÃ©rea/subterrÃ¢nea)", riscos:[
    "Choque elÃ©trico",
    "Contato com partes energizadas",
    "ExposiÃ§Ã£o a arco elÃ©trico",
    "IncÃªndio / explosÃ£o"
  ], controles:[
    "SinalizaÃ§Ã£o",
    "DistÃ¢ncia de seguranÃ§a",
    "Desligamento / isolamento",
    "GPRS (quando aplicÃ¡vel)",
    "PTP/ETP (quando aplicÃ¡vel)"
  ]}
];

const BLOQ_CHECKLIST = [
  "Fonte de energia com cadeado trancado junto da solicitaÃ§Ã£o de bloqueio?",
  "Chave do cadeado e comprovante de bloqueio dentro da caixa de bloqueio?",
  "Cadeados de TODOS os participantes inseridos na caixa de bloqueio?",
  "Equipamento sem bloqueio local â€“ teste de partida local/sala de controle confirmou bloqueio lÃ³gico?",
  "Equipamento com bloqueio local â€“ teste de partida local realizado?",
  "Segunda verificaÃ§Ã£o por outra equipe (quando aplicÃ¡vel) â€“ teste remoto e/ou local realizado?",
  "Equipamento com botoeira local â€“ foi feita indicaÃ§Ã£o/registro por equipe executante?",
  "VÃ¡lvulas â€“ tentativa de acionar e ela permaneceu na mesma posiÃ§Ã£o?",
  "Energia residual â€“ energia potencial ou residual eliminada e bloqueada?"
];

const EPI_CATALOG = [
  "Capacete de seguranÃ§a",
  "Ã“culos de seguranÃ§a",
  "Protetor auditivo",
  "Botina de seguranÃ§a",
  "Protetor facial",
  "Avental de raspa",
  "MÃ¡scara de soldador com lente filtrante acoplada ao capacete",
  "MÃ¡scara respirador facial",
  "Perneira de raspa",
  "Manga ou blusÃ£o de raspa ou coriu",
  "Capuz de brim (sem elÃ¡stico)",
  "Ã“culos de maÃ§ariqueiro",
  "MacacÃ£o de proteÃ§Ã£o contra produto quÃ­mico",
  "CalÃ§a e blusÃ£o impermeÃ¡veis",
  "Kit eletricista classe 4 (calÃ§a, jaleco e capuz)",
  "EPIs para motosserrista",
  "Cinto de seguranÃ§a especÃ­fico para trabalhos a quente em altura",
  "Colete salva-vidas classe IV (aprovado pelo DPC)",
  "Uniforme classe 2 (calÃ§a + camisa) â€“ elÃ©trica",
  "Balaclava",
  "Luva de eletricista nÃ­vel 2",
  "Luva de seguranÃ§a anti-impacto",
  "Luva isolante (alta / manobra)",
  "Luva vaqueta",
  "Luva pigmentada"
];

const SAUDE_AGENTES_RISCOS = ["RuÃ­do", "Calor", "VibraÃ§Ã£o", "Poeiras"]; 
const SAUDE_AGENTES_CONTROLES = [
  "Equipamentos de proteÃ§Ã£o adequados",
  "VentilaÃ§Ã£o adequada",
  "Barreiras acÃºsticas",
  "Desligar os equipamentos",
  "RodÃ­zio de atividades",
  "LimitaÃ§Ã£o do tempo de exposiÃ§Ã£o"
];

const SAUDE_ESFORCO_RISCOS = ["EsforÃ§o fÃ­sico"]; 
const SAUDE_ESFORCO_CONTROLES = [
  "LimitaÃ§Ã£o do tempo de execuÃ§Ã£o da atividade",
  "RodÃ­zio de atividades",
  "UtilizaÃ§Ã£o de equipamentos de iÃ§amento",
  "UtilizaÃ§Ã£o de equipamentos para transporte",
  "LimitaÃ§Ã£o do tempo de exposiÃ§Ã£o"
];

let aprPcrcEditor = { pcrcId:"", riscos:[], controles:[], obs:"", outrosRiscos:"", outrosControles:"" };
let aprPcrcMulti = []; // [{pcrcId, riscos, controles, obs, outrosRiscos, outrosControles}]
let aprBloqState = { checks:{}, local:"", resp:"", dataHora:"", obs:"", descricao:"" };
let aprEpiState = { itens:[], justificativa:"" };
let aprSaudeState = {
  agentes:{ etapas:"", riscos:[], controles:[], outrosRiscos:"", outrosControles:"" },
  esforco:{ etapas:"", riscos:[], controles:[], outrosRiscos:"", outrosControles:"" }
};
let aprExecutantesState = []; // [{nome, chapa, assinaturaDataUrl}]


function syncAprToolStates(){
  // espelha estados no window para o salvamento e para nÃ£o perder ao navegar
  try{
    window.aprPcrcMultiState = JSON.parse(JSON.stringify(aprPcrcMulti||[]));
    window.aprPcrcState = JSON.parse(JSON.stringify(aprPcrcEditor||{pcrcId:'',riscos:[],controles:[]}));
    window.aprBloqState = JSON.parse(JSON.stringify(aprBloqState||{}));
    window.aprEpiState = JSON.parse(JSON.stringify(aprEpiState||{}));
    window.aprSaudeState = JSON.parse(JSON.stringify(aprSaudeState||{}));
    window.aprExecutantesState = JSON.parse(JSON.stringify(aprExecutantesState||[]));
  }catch(e){
    console.warn('syncAprToolStates failed', e);
  }
}

function renderPcrcOptions(){
  const sel = document.getElementById('pcrcSelect');
  if(!sel) return;
  sel.innerHTML = '<option value="">Selecione...</option>' + PCRC_CATALOG.map(p=>`<option value="${p.id}">${p.emoji} ${p.id} â€” ${p.nome}</option>`).join('');
}

function renderPcrcEditor(){
  const pcrc = PCRC_CATALOG.find(x=>x.id===aprPcrcEditor.pcrcId);
  const rWrap = document.getElementById('pcrcRiscos');
  const cWrap = document.getElementById('pcrcControles');
  if(!rWrap || !cWrap) return;
  if(!pcrc){
    rWrap.innerHTML = '<div class="small">Selecione uma PCRC e clique em <b>Adicionar PCRC</b>.</div>';
    cWrap.innerHTML = '<div class="small">Selecione uma PCRC e clique em <b>Adicionar PCRC</b>.</div>';
    return;
  }
  const mk = (kind, txt, checked) => `
    <label class="pcrc-item">
      <input type="checkbox" data-kind="${kind}" data-txt="${encodeURIComponent(txt)}" ${checked?'checked':''}/>
      <div>${txt}</div>
    </label>`;

  rWrap.innerHTML = pcrc.riscos.map(t=>mk('risco', t, aprPcrcEditor.riscos.includes(t))).join('');
  cWrap.innerHTML = pcrc.controles.map(t=>mk('controle', t, aprPcrcEditor.controles.includes(t))).join('');

  rWrap.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const t = decodeURIComponent(cb.dataset.txt||'');
      aprPcrcEditor.riscos = cb.checked ? Array.from(new Set([...aprPcrcEditor.riscos, t])) : aprPcrcEditor.riscos.filter(x=>x!==t); syncAprToolStates();
    });
  });
  cWrap.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const t = decodeURIComponent(cb.dataset.txt||'');
      aprPcrcEditor.controles = cb.checked ? Array.from(new Set([...aprPcrcEditor.controles, t])) : aprPcrcEditor.controles.filter(x=>x!==t); syncAprToolStates();
    });
  });

  document.getElementById('pcrcObs').value = aprPcrcEditor.obs || '';
  document.getElementById('pcrcRiscosOutros').value = aprPcrcEditor.outrosRiscos || '';
  document.getElementById('pcrcControlesOutros').value = aprPcrcEditor.outrosControles || '';
}

function mkCheckItem(label, checked, onChange){
  const el = document.createElement('label');
  el.className = 'pcrc-item';
  el.innerHTML = `<input type="checkbox" ${checked?'checked':''}/><div>${label}</div>`;
  el.querySelector('input').addEventListener('change', (e)=>onChange(!!e.target.checked));
  return el;
}

function renderPcrcMulti(){
  const wrap = document.getElementById('pcrcMultiContainer');
  if(!wrap) return;
  if(!aprPcrcMulti.length){
    wrap.innerHTML = '<div class="small">Nenhuma PCRC adicionada ainda.</div>';
    return;
  }

  wrap.innerHTML = '';
  aprPcrcMulti.forEach((it, idx)=>{
    const p = PCRC_CATALOG.find(x=>x.id===it.pcrcId);
    const title = `${p?.emoji||'ğŸ§©'} ${it.pcrcId} â€” ${p?.nome||''}`;

    const card = document.createElement('div');
    card.style.border = '1px solid #e3eef7';
    card.style.borderRadius = '16px';
    card.style.padding = '12px';
    card.style.background = '#fff';

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:900;color:#003b5c;">${title}</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-outline btn-sm" type="button" data-act="remove">ğŸ—‘ï¸ Remover</button>
        </div>
      </div>
      <div class="form-grid" style="margin-top:8px;">
        <div>
          <label>ObservaÃ§Ã£o</label>
          <input class="input" data-fld="obs" placeholder="Opcional"/>
        </div>
      </div>
      <div class="pcrc-grid" style="margin-top:10px;">
        <div class="pcrc-col">
          <div class="pcrc-col-title">âš ï¸ Riscos</div>
          <div class="pcrc-list" data-wrap="riscos"></div>
          <label style="margin-top:10px;">Outros riscos</label>
          <textarea class="input" data-fld="outrosRiscos" style="min-height:60px;" placeholder="Digite aqui..."></textarea>
        </div>
        <div class="pcrc-col">
          <div class="pcrc-col-title">ğŸ›¡ï¸ Medidas de controle</div>
          <div class="pcrc-list" data-wrap="controles"></div>
          <label style="margin-top:10px;">Outras medidas</label>
          <textarea class="input" data-fld="outrosControles" style="min-height:60px;" placeholder="Digite aqui..."></textarea>
        </div>
      </div>
    `;

    // remove
    card.querySelector('[data-act="remove"]').addEventListener('click', ()=>{
      aprPcrcMulti.splice(idx,1);
      renderPcrcMulti();
      syncAprToolStates();
    });

    // fields
    const obsInp = card.querySelector('[data-fld="obs"]');
    obsInp.value = it.obs || '';
    obsInp.addEventListener('input', ()=>{ it.obs = obsInp.value; syncAprToolStates(); });

    const outrosR = card.querySelector('[data-fld="outrosRiscos"]');
    outrosR.value = it.outrosRiscos || '';
    outrosR.addEventListener('input', ()=>{ it.outrosRiscos = outrosR.value; syncAprToolStates(); });

    const outrosC = card.querySelector('[data-fld="outrosControles"]');
    outrosC.value = it.outrosControles || '';
    outrosC.addEventListener('input', ()=>{ it.outrosControles = outrosC.value; syncAprToolStates(); });

    // checklists
    const rWrap = card.querySelector('[data-wrap="riscos"]');
    const cWrap = card.querySelector('[data-wrap="controles"]');

    (p?.riscos||[]).forEach(t=>{
      rWrap.appendChild(mkCheckItem(t, (it.riscos||[]).includes(t), (ck)=>{
        it.riscos = ck ? Array.from(new Set([...(it.riscos||[]), t])) : (it.riscos||[]).filter(x=>x!==t);
        syncAprToolStates();
      }));
    });
    (p?.controles||[]).forEach(t=>{
      cWrap.appendChild(mkCheckItem(t, (it.controles||[]).includes(t), (ck)=>{
        it.controles = ck ? Array.from(new Set([...(it.controles||[]), t])) : (it.controles||[]).filter(x=>x!==t);
        syncAprToolStates();
      }));
    });

    wrap.appendChild(card);
  });
}

function addCurrentPcrcToMulti(){
  if(!aprPcrcEditor.pcrcId){ alert('Selecione uma PCRC.'); return; }
  // if already added, do not duplicate
  const exists = aprPcrcMulti.some(x=>x.pcrcId===aprPcrcEditor.pcrcId);
  if(exists){
    // allow duplicates? user said may need more than one, but same PCRC repeated usually not needed.
    // We'll keep single per id.
    alert('Essa PCRC jÃ¡ foi adicionada. VocÃª pode marcar/desmarcar nela abaixo.');
    return;
  }
  aprPcrcMulti.push({
    pcrcId: aprPcrcEditor.pcrcId,
    riscos: [...(aprPcrcEditor.riscos||[])],
    controles: [...(aprPcrcEditor.controles||[])],
    obs: document.getElementById('pcrcObs')?.value||'',
    outrosRiscos: document.getElementById('pcrcRiscosOutros')?.value||'',
    outrosControles: document.getElementById('pcrcControlesOutros')?.value||''
  });

  // reset editor
  aprPcrcEditor = { pcrcId:"", riscos:[], controles:[], obs:"", outrosRiscos:"", outrosControles:"" };
  const sel = document.getElementById('pcrcSelect');
  if(sel) sel.value = '';
  document.getElementById('pcrcObs').value='';
  document.getElementById('pcrcRiscosOutros').value='';
  document.getElementById('pcrcControlesOutros').value='';
  renderPcrcEditor();
  renderPcrcMulti();
  syncAprToolStates();
}

function renderBloqChecklist(){
  const wrap = document.getElementById('bloqChecklist');
  if(!wrap) return;
  wrap.innerHTML = BLOQ_CHECKLIST.map((t,i)=>{
    const key = 'c'+(i+1);
    const checked = !!aprBloqState.checks[key];
    return `
      <label class="pcrc-item">
        <input type="checkbox" data-key="${key}" ${checked?'checked':''}/>
        <div>${t}</div>
      </label>`;
  }).join('');
  wrap.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', ()=>{ aprBloqState.checks[cb.dataset.key] = cb.checked; syncAprToolStates(); });
  });
}

function renderEpiChecklist(){
  const wrap = document.getElementById('epiChecklist');
  if(!wrap) return;
  wrap.innerHTML = '';
  EPI_CATALOG.forEach(item=>{
    wrap.appendChild(mkCheckItem(item, aprEpiState.itens.includes(item), (ck)=>{
      aprEpiState.itens = ck ? Array.from(new Set([...aprEpiState.itens, item])) : aprEpiState.itens.filter(x=>x!==item); syncAprToolStates();
    }));
  });
  const just = document.getElementById('epiJust');
  if(just){
    just.value = aprEpiState.justificativa || '';
    just.addEventListener('input', ()=>{ aprEpiState.justificativa = just.value; syncAprToolStates(); });
  }
}

function renderSaudeBlocks(){
  // agentes
  const rA = document.getElementById('saudeAgentesRiscos');
  const cA = document.getElementById('saudeAgentesControles');
  if(rA && cA){
    rA.innerHTML=''; cA.innerHTML='';
    SAUDE_AGENTES_RISCOS.forEach(t=>rA.appendChild(mkCheckItem(t, aprSaudeState.agentes.riscos.includes(t), (ck)=>{
      aprSaudeState.agentes.riscos = ck ? Array.from(new Set([...aprSaudeState.agentes.riscos, t])) : aprSaudeState.agentes.riscos.filter(x=>x!==t);
    })));
    SAUDE_AGENTES_CONTROLES.forEach(t=>cA.appendChild(mkCheckItem(t, aprSaudeState.agentes.controles.includes(t), (ck)=>{
      aprSaudeState.agentes.controles = ck ? Array.from(new Set([...aprSaudeState.agentes.controles, t])) : aprSaudeState.agentes.controles.filter(x=>x!==t);
    })));
  }
  // esforÃ§o
  const rE = document.getElementById('saudeEsforcoRiscos');
  const cE = document.getElementById('saudeEsforcoControles');
  if(rE && cE){
    rE.innerHTML=''; cE.innerHTML='';
    SAUDE_ESFORCO_RISCOS.forEach(t=>rE.appendChild(mkCheckItem(t, aprSaudeState.esforco.riscos.includes(t), (ck)=>{
      aprSaudeState.esforco.riscos = ck ? Array.from(new Set([...aprSaudeState.esforco.riscos, t])) : aprSaudeState.esforco.riscos.filter(x=>x!==t);
    })));
    SAUDE_ESFORCO_CONTROLES.forEach(t=>cE.appendChild(mkCheckItem(t, aprSaudeState.esforco.controles.includes(t), (ck)=>{
      aprSaudeState.esforco.controles = ck ? Array.from(new Set([...aprSaudeState.esforco.controles, t])) : aprSaudeState.esforco.controles.filter(x=>x!==t);
    })));
  }

  // textareas
  const bindText = (id, setter)=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.value = setter.get();
    el.addEventListener('input', ()=>setter.set(el.value));
  };

  bindText('saudeAgentesEtapas', {get:()=>aprSaudeState.agentes.etapas||'', set:v=>aprSaudeState.agentes.etapas=v});
  bindText('saudeAgentesOutrosRiscos', {get:()=>aprSaudeState.agentes.outrosRiscos||'', set:v=>aprSaudeState.agentes.outrosRiscos=v});
  bindText('saudeAgentesOutrosControles', {get:()=>aprSaudeState.agentes.outrosControles||'', set:v=>aprSaudeState.agentes.outrosControles=v});

  bindText('saudeEsforcoEtapas', {get:()=>aprSaudeState.esforco.etapas||'', set:v=>aprSaudeState.esforco.etapas=v});
  bindText('saudeEsforcoOutrosRiscos', {get:()=>aprSaudeState.esforco.outrosRiscos||'', set:v=>aprSaudeState.esforco.outrosRiscos=v});
  bindText('saudeEsforcoOutrosControles', {get:()=>aprSaudeState.esforco.outrosControles||'', set:v=>aprSaudeState.esforco.outrosControles=v});
}

function renderExecutantes(){
  const wrap = document.getElementById('aprExecutantes');
  if(!wrap) return;
  if(!aprExecutantesState.length){
    wrap.innerHTML = '<div class="small">Nenhum executante adicionado.</div>';
    return;
  }
  wrap.innerHTML='';

  aprExecutantesState.forEach((p, idx)=>{
    const card = document.createElement('div');
    card.style.border='1px solid #e3eef7';
    card.style.borderRadius='16px';
    card.style.padding='10px';
    card.style.background='#fff';

    const canvasId = `execSig_${idx}`;
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
        <div style="font-weight:900;color:#003b5c;">ğŸ‘¤ Executante ${idx+1}</div>
        <button class="btn btn-outline btn-sm" type="button" data-act="rm">ğŸ—‘ï¸ Remover</button>
      </div>
      <div class="form-grid" style="margin-top:8px;">
        <div>
          <label>Nome</label>
          <input class="input" data-fld="nome" placeholder="Nome completo"/>
        </div>
        <div>
          <label>Chapa</label>
          <input class="input" data-fld="chapa" placeholder="NÂº da chapa"/>
        </div>
      </div>
      <div style="margin-top:8px;">
        <label>Assinatura</label>
        <div style="border:1px solid #cfe3f2;border-radius:14px;overflow:hidden;background:#f8fbff;">
          <canvas id="${canvasId}" width="700" height="150" style="width:100%;height:150px;display:block;"></canvas>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button class="btn btn-outline btn-sm" type="button" data-act="clear">ğŸ§½ Limpar assinatura</button>
        </div>
      </div>
    `;

    card.querySelector('[data-act="rm"]').addEventListener('click', ()=>{
      aprExecutantesState.splice(idx,1); syncAprToolStates();
      renderExecutantes();
    });

    const nome = card.querySelector('[data-fld="nome"]');
    const chapa = card.querySelector('[data-fld="chapa"]');
    nome.value = p.nome || '';
    chapa.value = p.chapa || '';
    nome.addEventListener('input', ()=>{ p.nome = nome.value; });
    chapa.addEventListener('input', ()=>{ p.chapa = chapa.value; });

    wrap.appendChild(card);

    // assinatura
    const canvas = document.getElementById(canvasId);
    if(canvas){
      const ctx = canvas.getContext('2d');
      ctx.lineWidth = 2; ctx.lineCap='round';
      let drawing=false;

      const getPos = (e)=>{
        const rect=canvas.getBoundingClientRect();
        const clientX = e.touches?e.touches[0].clientX:e.clientX;
        const clientY = e.touches?e.touches[0].clientY:e.clientY;
        return {x:(clientX-rect.left)*(canvas.width/rect.width), y:(clientY-rect.top)*(canvas.height/rect.height)};
      };
      const start=(e)=>{ drawing=True; const pos=getPos(e); ctx.beginPath(); ctx.moveTo(pos.x,pos.y); e.preventDefault(); };
      const move=(e)=>{ if(!drawing) return; const pos=getPos(e); ctx.lineTo(pos.x,pos.y); ctx.stroke(); p.assinaturaDataUrl = canvas.toDataURL('image/png'); e.preventDefault(); };
      const end=(e)=>{ drawing=False; p.assinaturaDataUrl = canvas.toDataURL('image/png'); e.preventDefault(); };

      // fix python True/False typo, set afterwards below
    }

  });

  // after DOM, attach signature handlers separately (need to avoid reflow issues)
  aprExecutantesState.forEach((p, idx)=>{
    const canvas = document.getElementById(`execSig_${idx}`);
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 2; ctx.lineCap='round';
    if(p.assinaturaDataUrl){
      const img = new Image();
      img.onload=()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); };
      img.src=p.assinaturaDataUrl;
    }
    let drawing=false;
    const getPos=(e)=>{
      const rect=canvas.getBoundingClientRect();
      const clientX = e.touches?e.touches[0].clientX:e.clientX;
      const clientY = e.touches?e.touches[0].clientY:e.clientY;
      return {x:(clientX-rect.left)*(canvas.width/rect.width), y:(clientY-rect.top)*(canvas.height/rect.height)};
    };
    const start=(e)=>{ drawing=true; const pos=getPos(e); ctx.beginPath(); ctx.moveTo(pos.x,pos.y); e.preventDefault(); };
    const move=(e)=>{ if(!drawing) return; const pos=getPos(e); ctx.lineTo(pos.x,pos.y); ctx.stroke(); p.assinaturaDataUrl = canvas.toDataURL('image/png'); e.preventDefault(); };
    const end=(e)=>{ drawing=false; p.assinaturaDataUrl = canvas.toDataURL('image/png'); e.preventDefault(); };

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', end);

    canvas.addEventListener('touchstart', start, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('touchend', end, {passive:false});

    const card = canvas.closest('div[style*="border:1px solid"]');
    const clearBtn = card?.querySelector('[data-act="clear"]');
    clearBtn?.addEventListener('click', ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); p.assinaturaDataUrl=''; });
  });
}

async function exportDomToPDF(domEl, filename){
  if(!domEl){ alert('Nada para exportar.'); return; }
  if(!(window.html2canvas && window.jspdf && window.jspdf.jsPDF)){
    alert('PDF: html2canvas/jsPDF nÃ£o disponÃ­vel.');
    return;
  }
  const tmp = document.createElement('div');
  tmp.style.width = '800px';
  tmp.style.background = '#fff';
  tmp.style.padding = '14px';
  tmp.style.borderRadius = '14px';
  tmp.innerHTML = `
    <div style="font-family:Arial;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;color:#003b5c;">CONTERPLAN â€” APR</div>
        <div style="font-size:12px;color:#334;">${new Date().toLocaleString('pt-BR')}</div>
      </div>
      <div style="margin-top:8px;">${domEl.outerHTML}</div>
    </div>`;
  document.body.appendChild(tmp);
  const canvas = await html2canvas(tmp, {scale:2, useCORS:true});
  const imgData = canvas.toDataURL('image/png');
  document.body.removeChild(tmp);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const margin = 20;
  const imgW = pageW - margin*2;
  const imgH = canvas.height * imgW / canvas.width;

  let remaining = imgH;
  let position = 0;
  while(remaining > 0){
    pdf.addImage(imgData,'PNG',margin,margin - position,imgW,imgH);
    remaining -= (pageH - margin*2);
    position += (pageH - margin*2);
    if(remaining>0) pdf.addPage();
  }

  pdf.save(filename);
}

function initAprTools(){
  // tool tabs
  document.querySelectorAll('.apr-tool-tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.apr-tool-tab').forEach(b=>b.classList.toggle('active', b===btn));
      const tool = btn.dataset.tool;
      document.querySelectorAll('.apr-tool-panel').forEach(p=>p.classList.toggle('active', p.id===('apr-tool-'+tool)));
    });
  });

  renderPcrcOptions();
  renderPcrcEditor();
  renderPcrcMulti();
  syncAprToolStates();
  renderBloqChecklist();
  renderEpiChecklist();
  renderSaudeBlocks();
  renderExecutantes();

  const sel = document.getElementById('pcrcSelect');
  sel?.addEventListener('change', ()=>{
    const id = sel.value;
    if(!id){ return; }
    // Ao selecionar, adiciona e mantÃ©m aberta (mÃºltiplas PCRCs)
    const exists = aprPcrcMulti.some(x=>x.pcrcId===id);
    if(!exists){
      aprPcrcMulti.push({ pcrcId:id, riscos:[], controles:[], obs:'', outrosRiscos:'', outrosControles:'' });
      renderPcrcMulti();
      syncAprToolStates();
    }
    // limpa o seletor para permitir escolher outra imediatamente
    sel.value = '';
    // editor permanece disponÃ­vel, mas nÃ£o Ã© obrigatÃ³rio
    aprPcrcEditor = { pcrcId:'', riscos:[], controles:[], obs:'', outrosRiscos:'', outrosControles:'' };
    renderPcrcEditor();
    // rola atÃ© o card da PCRC selecionada
    const wrap = document.getElementById('pcrcMultiContainer');
    const cards = wrap?.children || [];
    for(const c of cards){
      if((c.textContent||'').includes(id)){
        c.scrollIntoView({behavior:'smooth', block:'start'});
        break;
      }
    }
  });

  ['pcrcObs','pcrcRiscosOutros','pcrcControlesOutros'].forEach(id=>{
    document.getElementById(id)?.addEventListener('input', ()=>{
      aprPcrcEditor.obs = document.getElementById('pcrcObs')?.value || '';
      aprPcrcEditor.outrosRiscos = document.getElementById('pcrcRiscosOutros')?.value || '';
      aprPcrcEditor.outrosControles = document.getElementById('pcrcControlesOutros')?.value || '';
    });
  });

  document.getElementById('btnAddPcrcMulti')?.addEventListener('click', addCurrentPcrcToMulti);
  document.getElementById('btnLimparPcrcMulti')?.addEventListener('click', ()=>{ if(confirm('Limpar todas as PCRCs adicionadas?')){ aprPcrcMulti=[]; renderPcrcMulti(); syncAprToolStates(); } });

  ['bloqLocal','bloqResp','bloqDataHora','bloqObs','bloqDescricao'].forEach(id=>{
    document.getElementById(id)?.addEventListener('input', ()=>{
      aprBloqState.local = document.getElementById('bloqLocal')?.value || '';
      aprBloqState.resp = document.getElementById('bloqResp')?.value || '';
      aprBloqState.dataHora = document.getElementById('bloqDataHora')?.value || '';
      aprBloqState.obs = document.getElementById('bloqObs')?.value || '';
      aprBloqState.descricao = document.getElementById('bloqDescricao')?.value || '';
    });
  });

  document.getElementById('btnPdfPcrc')?.addEventListener('click', ()=>{
    exportDomToPDF(document.getElementById('apr-tool-pcrc'), 'APR_PCRC_CONTERPLAN.pdf');
  });
  document.getElementById('btnPdfBloq')?.addEventListener('click', ()=>{
    exportDomToPDF(document.getElementById('apr-tool-bloqueio'), 'APR_Bloqueio_CONTERPLAN.pdf');
  });

  // executantes
  document.getElementById('btnAddExecutante')?.addEventListener('click', ()=>{
    aprExecutantesState.push({nome:'', chapa:'', assinaturaDataUrl:''});
    renderExecutantes();
  });
  document.getElementById('btnLimparExecutantes')?.addEventListener('click', ()=>{ if(confirm('Limpar executantes?')){ aprExecutantesState=[]; renderExecutantes(); } });
}

// inicializa apÃ³s carregar
window.addEventListener('DOMContentLoaded', ()=>{
  try{ initAprTools(); }catch(e){ console.error('APR tools init error', e); }
});

</script>

<!-- ====== MÃ“DULO ESTOQUE (SRC) - NÃƒO EDITAR AQUI, edite o arquivo Estoque.html e replique ====== -->
<template id="tplEstoqueSamarco">
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"/>
<title>CONTERPLAN â€“ SGI / APR | Controle de Estoque com Reconhecimento Facial</title>

<!-- Bibliotecas (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
:root{
  --sam-blue:#005c8f;
  --sam-blue-2:#003b5c;
  --sam-blue-light:#e6f0f6;
  --sam-green:#3a9d5d;
  --sam-orange:#f7941d;
  --sam-red:#d9534f;
  --sam-gray:#4b4b4b;
  --bg:#f3f6fb;
  --card:#ffffff;
  --border:#d5dde7;
  --shadow:0 10px 30px rgba(15,23,42,0.08);
  --shadow2:0 14px 44px rgba(15,23,42,0.12);
}

*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
body{background:var(--bg);color:var(--sam-gray);min-height:100vh;}

.app-shell{min-height:100vh;display:flex;flex-direction:column;}
.header{
  position:sticky;top:0;z-index:50;
  background:linear-gradient(90deg,var(--sam-blue-2),var(--sam-blue));
  color:#fff;
  padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  box-shadow:0 6px 22px rgba(0,0,0,.22);
}
.header-left{display:flex;align-items:center;gap:10px;min-width:0;}
.logo{
  width:44px;height:44px;border-radius:999px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
}
.logo img{width:100%;height:100%;object-fit:contain;}
.title-wrap{min-width:0;}
.title{font-weight:800;font-size:15px;letter-spacing:.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.subtitle{font-size:11px;opacity:.88;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.header-right{text-align:right;font-size:11px;opacity:.95;}

.main{flex:1;display:flex;min-height:0;}
.sidebar{
  width:248px;flex:0 0 auto;
  background:#fff;border-right:1px solid var(--border);
  padding:10px;
  display:flex;flex-direction:column;gap:6px;
}
.nav-group{margin-top:4px;font-size:10px;text-transform:uppercase;letter-spacing:.14em;color:#6b7280;padding:8px 10px 4px;}
.nav-btn{
  border:none;background:transparent;border-radius:999px;
  padding:10px 12px;
  display:flex;align-items:center;gap:10px;
  cursor:pointer;
  color:#445; font-size:13px;
  transition:.15s;
  white-space:nowrap;
}
.nav-btn .icon{width:18px;text-align:center;font-size:15px;}
.nav-btn:hover{background:#f3f7ff;}
.nav-btn.active{background:rgba(0,92,143,.10);color:var(--sam-blue);font-weight:700;}

.content{
  flex:1;min-width:0;
  padding:14px 14px 18px;
  overflow:auto;
}
.section{display:none;}
.section.active{display:block;}

.card{
  background:var(--card);
  border-radius:18px;
  padding:14px 14px 12px;
  border:1px solid rgba(148,163,184,.35);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;}
.card-title{font-weight:800;color:#243;color:var(--sam-blue);font-size:14px;display:flex;align-items:center;gap:8px;}
.card-sub{font-size:11px;color:#6b7280;margin-top:2px;}
.badge{padding:3px 9px;border-radius:999px;font-size:10px;background:var(--sam-blue-light);color:var(--sam-blue);white-space:nowrap;}

.grid{display:grid;gap:10px;}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr));}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr));}
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr));}
@media (max-width:980px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}}

.kpi{
  border-radius:16px;
  padding:12px 12px 10px;
  background:linear-gradient(145deg,#fff,#eef6ff);
  border:1px solid rgba(148,163,184,.40);
}
.kpi-label{font-size:11px;color:#6b7280;}
.kpi-value{font-size:24px;font-weight:900;color:var(--sam-blue);margin-top:3px;line-height:1;}
.kpi-sub{font-size:11px;color:#6b7280;margin-top:6px;}

.form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:980px){.form-grid{grid-template-columns:1fr;}}
label{font-size:12px;font-weight:700;color:#334;}
.input,select,textarea{
  width:100%;
  border:1px solid var(--border);
  border-radius:10px;
  padding:9px 10px;
  font-size:12px;
  background:#fff;
}
textarea{min-height:84px;resize:vertical;}
.small{font-size:10px;color:#6b7280;margin-top:3px;}

.btn{
  border:none;border-radius:999px;
  padding:9px 12px;
  font-size:12px;
  cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;
  transition:.15s;
}
.btn-primary{background:var(--sam-blue);color:#fff;}
.btn-primary:hover{filter:brightness(.95);}
.btn-outline{background:#fff;border:1px solid var(--sam-blue);color:var(--sam-blue);}
.btn-danger{background:var(--sam-red);color:#fff;}
.btn-sm{padding:6px 10px;font-size:11px;}
.btn-success{background:var(--sam-green);color:#fff;}
.btn-warning{background:var(--sam-orange);color:#fff;}

.table-wrap{border:1px solid var(--border);border-radius:14px;overflow:auto;background:#fff;max-height:320px;}
table{width:100%;border-collapse:collapse;font-size:11px;}
th,td{padding:8px 10px;border-bottom:1px solid #edf0f5;text-align:left;vertical-align:top;}
th{background:#f7f9fd;position:sticky;top:0;z-index:5;font-size:11px;}
tr:nth-child(even){background:#fafbff;}

.tag{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:10px;font-weight:800}
.t-estoque{background:#f0f9ff;color:#0369a1;}
.t-treinamento{background:#f0fdf4;color:#15803d;}
.t-residuo{background:#fefce8;color:#ca8a04;}
.t-saude{background:#fdf2f8;color:#be185d;}
.t-aso{background:#f5f3ff;color:#7c3aed;}
.t-rdo{background:#ecfeff;color:#0e7490;}
.status-badge{padding:3px 8px;border-radius:12px;font-size:10px;font-weight:bold;}
.status-ativo{background:#dcfce7;color:#166534;}
.status-vencido{background:#fee2e2;color:#991b1b;}
.status-alerta{background:#fef3c7;color:#92400e;}
.status-pendente{background:#e0f2fe;color:#0369a1;}
.assinatura-canvas{border:2px dashed #ccc;border-radius:10px;background:#f9f9f9;cursor:crosshair;touch-action:none;}

/* Reconhecimento Facial */
.face-recognition-section{
  border:2px solid var(--sam-blue);
  border-radius:16px;
  padding:12px;
  background:#f0f9ff;
  margin-top:15px;
}
.face-camera-container{
  width:100%;
  max-width:320px;
  margin:10px auto;
  position:relative;
}
.face-video{
  width:100%;
  border-radius:12px;
  border:2px solid var(--sam-blue);
  background:#000;
}
.face-canvas{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
}
.face-result{
  padding:10px;
  background:#fff;
  border-radius:12px;
  border:1px solid var(--border);
  margin-top:10px;
}
.face-match{
  color:var(--sam-green);
  font-weight:bold;
}
.face-no-match{
  color:var(--sam-red);
}

/* Chips para seleÃ§Ã£o */
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
.chip{
  border:1px solid var(--border);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  cursor:pointer;
  background:#fff;
}
.chip.sel{background:var(--sam-blue);border-color:var(--sam-blue);color:#fff;}

/* Responsivo mobile */
@media (max-width:980px){
  .main{flex-direction:column;}
  .sidebar{
    width:100%;
    border-right:none;border-bottom:1px solid var(--border);
    flex-direction:row;
    overflow-x:auto;
    gap:6px;
    padding:10px 10px 8px;
    position:sticky;top:64px;z-index:40;
  }
  .nav-group{display:none;}
}
</style>
</head>

<body>
<div class="app-shell">
<header class="header">
<div class="header-left">
<div class="logo">ğŸ“¦</div>
<div class="title-wrap">
<div class="title">CONTERPLAN â€“ Controle de Estoque</div>
<div class="subtitle">EPIs + Reconhecimento Facial + MovimentaÃ§Ãµes</div>
</div>
</div>
<div class="header-right">
<div id="hoje"></div>
<div class="status-badge status-ativo" id="statusFace">Reconhecimento: Aguardando</div>
</div>
</header>

<div class="main">
<nav class="sidebar">
<button class="nav-btn active" data-sec="sec-estoque-mov"><span class="icon">ğŸ“¦</span>MovimentaÃ§Ãµes</button>
<button class="nav-btn" data-sec="sec-estoque-catalogo"><span class="icon">ğŸ“‹</span>CatÃ¡logo</button>
<button class="nav-btn" data-sec="sec-estoque-solic"><span class="icon">ğŸ§‘â€ğŸ­</span>SolicitaÃ§Ã£o</button>
<button class="nav-btn" data-sec="sec-estoque-relatorios"><span class="icon">ğŸ“Š</span>RelatÃ³rios</button>
<button class="nav-btn" data-sec="sec-estoque-reconhecimento"><span class="icon">ğŸ“·</span>Reconhecimento</button>
</nav>

<main class="content">
<!-- SeÃ§Ã£o MovimentaÃ§Ãµes -->
<section class="section active" id="sec-estoque-mov">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“¦ Controle de Estoque - EPIs</div>
<div class="card-sub">GestÃ£o completa de entrada e saÃ­da com assinatura digital</div>
</div>
<span class="badge">Saldo AutomÃ¡tico</span>
</div>

<div class="grid grid-4">
<div class="kpi">
<div class="kpi-label">Total em Estoque</div>
<div class="kpi-value" id="kpiEstoqueTotal">0</div>
<div class="kpi-sub" id="kpiEstoqueValor">R$ 0,00</div>
</div>
<div class="kpi">
<div class="kpi-label">Itens CrÃ­ticos</div>
<div class="kpi-value" id="kpiEstoqueCriticoDet">0</div>
<div class="kpi-sub">Abaixo do mÃ­nimo</div>
</div>
<div class="kpi">
<div class="kpi-label">SaÃ­das (MÃªs)</div>
<div class="kpi-value" id="kpiSaidasMes">0</div>
<div class="kpi-sub" id="kpiTopEPI">â€“</div>
</div>
<div class="kpi">
<div class="kpi-label">Valor Total</div>
<div class="kpi-value" id="kpiValorTotal">R$ 0</div>
<div class="kpi-sub">Investimento em EPIs</div>
</div>
</div>

<div class="form-grid">
<div>
<label>Tipo de MovimentaÃ§Ã£o *</label>
<select class="input" id="estoqueTipo" required>
<option value="">Selecione...</option>
<option value="entrada">Entrada (Compra/Recebimento)</option>
<option value="saida">SaÃ­da (Retirada por Colaborador)</option>
<option value="ajuste">Ajuste de Estoque</option>
<option value="devolucao">DevoluÃ§Ã£o</option>
</select>
</div>
<div>
<label>EPI *</label>
<select class="input" id="estoqueEPI" required>
<option value="">Selecione...</option>
<!-- EPIs serÃ£o carregados via JavaScript -->
</select>
</div>
<div>
<label>CÃ³digo do EPI</label>
<input class="input" id="estoqueEpiCodigoBusca" list="dlEpiCodigo" placeholder="Ex.: 223244"/>
<datalist id="dlEpiCodigo"></datalist>
</div>
<div>
<label>Quantidade *</label>
<input class="input" id="estoqueQuantidade" min="1" required type="number" value="1">
</div>
</div>

<div class="form-grid">
<div>
<label>Valor UnitÃ¡rio (R$)</label>
<input class="input" id="estoqueValor" min="0" placeholder="0.00" step="0.01" type="number"/>
</div>
<div>
<label>Colaborador (SaÃ­da)</label>
<input class="input" id="estoqueColaborador" list="dlColaboradores" placeholder="Nome completo"/>
<datalist id="dlColaboradores"></datalist>
</div>
<div>
<label>Chapa/MatrÃ­cula</label>
<input class="input" id="estoqueCPF" placeholder="Somente nÃºmeros"/>
</div>
<div>
<label>FunÃ§Ã£o</label>
<input class="input" id="estoqueFuncao" placeholder="FunÃ§Ã£o do colaborador"/>
</div>
</div>

<div class="form-grid">
<div>
<label>Turno</label>
<input class="input" id="estoqueTurno" list="dlTurnos" placeholder="Ex.: A, B, C, D, Infra A..."/>
<datalist id="dlTurnos">
<option value="A"></option><option value="B"></option><option value="C"></option><option value="D"></option>
<option value="Infra A"></option><option value="Infra B"></option>
<option value="Administrativo"></option>
</datalist>
</div>
<div>
<label>Setor *</label>
<select class="input" id="estoqueSetor" required>
<option value="">Selecione...</option>
<option value="campo">Campo / Frentes</option>
<option value="oficina">Oficina</option>
<option value="almoxarifado">Almoxarifado</option>
<option value="logistica">LogÃ­stica</option>
<option value="operacao">OperaÃ§Ã£o</option>
<option value="manutencao">ManutenÃ§Ã£o</option>
<option value="administrativo">Administrativo</option>
</select>
</div>
<div>
<label>Data da MovimentaÃ§Ã£o</label>
<input class="input" id="estoqueData" type="date" value="">
</div>
</div>

<div style="margin-top:10px;">
<label>ObservaÃ§Ãµes</label>
<textarea class="input" id="estoqueObs" placeholder="ObservaÃ§Ãµes sobre a movimentaÃ§Ã£o..."></textarea>
</div>

<div style="margin-top:10px;">
<label>Assinatura Digital *</label>
<div class="assinatura-canvas" id="assinaturaCanvas" style="width:100%;height:150px;"></div>
<div style="margin-top:5px;display:flex;gap:8px;">
<button class="btn btn-sm btn-outline" id="btnLimparAssinatura" type="button">Limpar</button>
<button class="btn btn-sm btn-outline" id="btnAssinaturaPadrao" type="button">Usar Assinatura PadrÃ£o</button>
<button class="btn btn-sm btn-outline" id="btnAssinaturaFace" type="button">Usar Reconhecimento Facial</button>
</div>
</div>

<div style="margin-top:15px;display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-primary" id="btnSalvarEstoque">ğŸ’¾ Salvar MovimentaÃ§Ã£o</button>
<button class="btn btn-outline" id="btnLimparEstoque">Limpar FormulÃ¡rio</button>
<button class="btn btn-success" id="btnRelatorioEstoque">ğŸ“Š RelatÃ³rio de Estoque</button>
<button class="btn btn-warning" id="btnAlertasEstoque">ğŸš¨ Alertas de Estoque</button>
</div>
</div>

<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“Š SituaÃ§Ã£o do Estoque</div>
<div class="card-sub">Saldo atual de todos os EPIs</div>
</div>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>EPI</th>
<th>CÃ³digo</th>
<th>Entradas</th>
<th>SaÃ­das</th>
<th>Saldo</th>
<th>MÃ­nimo</th>
<th>Status</th>
<th>Valor Unit.</th>
<th>Valor Total</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbEstoque">
</tbody>
</table>
</div>
</div>

<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ•’ HistÃ³rico de MovimentaÃ§Ãµes</div>
<div class="card-sub">Ãšltimas movimentaÃ§Ãµes registradas</div>
</div>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>Data</th>
<th>Tipo</th>
<th>EPI</th>
<th>Qtd</th>
<th>Colaborador</th>
<th>Setor</th>
<th>ResponsÃ¡vel</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbHistoricoEstoque">
</tbody>
</table>
</div>
</div>
</section>

<!-- SeÃ§Ã£o CatÃ¡logo -->
<section class="section" id="sec-estoque-catalogo">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“‹ CatÃ¡logo de EPIs</div>
<div class="card-sub">Cadastro e gerenciamento de itens de estoque</div>
</div>
<span class="badge">Base + Personalizados</span>
</div>

<div class="form-grid">
<div>
<label>Nome do EPI *</label>
<input class="input" id="novoEpiNome" placeholder="Ex.: Protetor Facial"/>
</div>
<div>
<label>CÃ³digo *</label>
<input class="input" id="novoEpiCodigo" placeholder="Ex.: 123456"/>
</div>
<div>
<label>Categoria</label>
<select class="input" id="novoEpiCategoria">
<option value="protecao_cabeca">ProteÃ§Ã£o CabeÃ§a</option>
<option value="protecao_auditiva">ProteÃ§Ã£o Auditiva</option>
<option value="protecao_respiratoria">ProteÃ§Ã£o RespiratÃ³ria</option>
<option value="protecao_maos">ProteÃ§Ã£o MÃ£os</option>
<option value="protecao_visual">ProteÃ§Ã£o Visual</option>
<option value="vestimenta">Vestimenta</option>
<option value="outros">Outros</option>
</select>
</div>
<div style="display:flex;align-items:flex-end;gap:8px;">
<button class="btn btn-primary" id="btnAdicionarEpi" type="button">â• Adicionar</button>
<button class="btn btn-outline" id="btnLimparEpiNovo" type="button">Limpar</button>
</div>
</div>

<div style="margin-top:12px;">
<div class="card-sub" style="margin-bottom:8px;">EPIs cadastrados (editÃ¡veis)</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>Nome do EPI</th>
<th>CÃ³digo</th>
<th>Categoria</th>
<th>Status</th>
<th style="width:120px;">AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbEpiCatalogo">
</tbody>
</table>
</div>
</div>
</div>
</section>

<!-- SeÃ§Ã£o SolicitaÃ§Ã£o -->
<section class="section" id="sec-estoque-solic">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ§‘â€ğŸ­ SolicitaÃ§Ã£o de EPIs</div>
<div class="card-sub">SolicitaÃ§Ã£o formal de itens de estoque</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn btn-outline btn-sm" id="gerarSolicitacaoPDF" type="button">ğŸ“„ Gerar PDF</button>
<button class="btn btn-primary btn-sm" id="enviarSolicitacaoBtn" type="button">ğŸ“¤ Enviar SolicitaÃ§Ã£o</button>
</div>
</div>

<div class="form-grid">
<div>
<label>Nome do Solicitante *</label>
<input class="input" id="solicitanteNome" type="text" placeholder="Seu nome completo">
</div>
<div>
<label>Setor / Ãrea *</label>
<select class="input" id="solicitanteSetor" required>
<option value="">Selecione...</option>
<option value="campo">Campo / Frentes</option>
<option value="oficina">Oficina</option>
<option value="almoxarifado">Almoxarifado</option>
<option value="logistica">LogÃ­stica</option>
<option value="operacao">OperaÃ§Ã£o</option>
<option value="manutencao">ManutenÃ§Ã£o</option>
<option value="administrativo">Administrativo</option>
</select>
</div>
<div>
<label>MatrÃ­cula *</label>
<input class="input" id="solicitanteMatricula" type="text" placeholder="NÃºmero da matrÃ­cula">
</div>
<div>
<label>Data da SolicitaÃ§Ã£o *</label>
<input class="input" id="dataSolicitacao" type="date">
</div>
</div>

<div style="margin-top:10px;">
<label>Justificativa da SolicitaÃ§Ã£o *</label>
<textarea class="input" id="solicitacaoJustificativa" placeholder="Descreva a necessidade dos EPIs..." rows="3"></textarea>
</div>

<div style="margin-top:10px;">
<label>EPIs Solicitados *</label>
<div id="episContainer">
<div class="epi-item" style="margin-bottom:10px;">
<div class="form-grid" style="grid-template-columns:2fr 1fr auto;align-items:end;">
<div>
<label style="font-size:11px;color:#6b7280;">EPI</label>
<select class="input episSelect">
<option value="">Selecione um EPI...</option>
</select>
</div>
<div>
<label style="font-size:11px;color:#6b7280;">Quantidade</label>
<input class="input epiQuantidade" type="number" min="1" value="1">
</div>
<div style="padding-bottom:2px;">
<button class="btn btn-outline btn-sm removerEPI" type="button">Remover</button>
</div>
</div>
</div>
</div>
<button class="btn btn-primary btn-sm" id="adicionarEPIBtn" type="button" style="margin-top:6px;">â• Adicionar outro EPI</button>
</div>

<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
<button class="btn btn-outline btn-sm" id="limparSolicitacaoBtn" type="button">Limpar</button>
<button class="btn btn-primary btn-sm" id="salvarSolicitacaoBtn" type="button">ğŸ’¾ Salvar SolicitaÃ§Ã£o</button>
</div>
</div>

<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“‹ SolicitaÃ§Ãµes Salvas</div>
<div class="card-sub">HistÃ³rico de solicitaÃ§Ãµes</div>
</div>
<button class="btn btn-outline btn-sm" id="btnSolicRefresh" type="button">ğŸ”„ Atualizar</button>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th style="width:52px;">Sel.</th>
<th style="width:96px;">Data</th>
<th>Solicitante</th>
<th style="width:160px;">Setor</th>
<th>Itens</th>
<th style="width:160px;">AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbSolicSalvas">
</tbody>
</table>
</div>
</div>
</section>

<!-- SeÃ§Ã£o RelatÃ³rios -->
<section class="section" id="sec-estoque-relatorios">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“Š RelatÃ³rios de Estoque</div>
<div class="card-sub">GrÃ¡ficos e anÃ¡lises do estoque</div>
</div>
</div>
<div class="grid grid-3" style="margin-top:12px;">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“ˆ MovimentaÃ§Ã£o por EPI</div>
<div class="card-sub">Entradas vs SaÃ­das</div>
</div>
</div>
<div style="padding:10px 12px;height:220px;">
<canvas id="chartEstoque"></canvas>
</div>
</div>
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ‘· SaÃ­das por Colaborador</div>
<div class="card-sub">Top 10 deste mÃªs</div>
</div>
</div>
<div style="padding:10px 12px;height:220px;">
<canvas id="chartEstoqueOperador"></canvas>
</div>
</div>
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ•’ SaÃ­das por Turno</div>
<div class="card-sub">DistribuiÃ§Ã£o por turno</div>
</div>
</div>
<div style="padding:10px 12px;height:220px;">
<canvas id="chartEstoqueTurno"></canvas>
</div>
</div>
</div>
</div>
</section>

<!-- SeÃ§Ã£o Reconhecimento Facial -->
<section class="section" id="sec-estoque-reconhecimento">
<div class="card">
<div class="card-header">
<div>
<div class="card-title">ğŸ“· Reconhecimento Facial</div>
<div class="card-sub">IdentificaÃ§Ã£o automÃ¡tica para retirada de EPIs</div>
</div>
<span class="badge">Beta</span>
</div>

<div class="face-recognition-section">
<div style="text-align:center;margin-bottom:15px;">
<h3 style="color:var(--sam-blue);">IdentificaÃ§Ã£o por Reconhecimento Facial</h3>
<p class="small">Posicione seu rosto na cÃ¢mera para identificaÃ§Ã£o automÃ¡tica</p>
</div>

<div class="face-camera-container">
<video id="faceVideo" class="face-video" autoplay playsinline></video>
<canvas id="faceCanvas" class="face-canvas"></canvas>
</div>

<div style="display:flex;gap:10px;justify-content:center;margin-top:15px;">
<button class="btn btn-primary" id="btnIniciarCamera">ğŸ¥ Iniciar CÃ¢mera</button>
<button class="btn btn-success" id="btnCapturarRosto">ğŸ“¸ Capturar Rosto</button>
<button class="btn btn-warning" id="btnPararCamera">â¹ï¸ Parar CÃ¢mera</button>
</div>

<div id="faceResult" class="face-result" style="display:none;">
<h4 style="margin-bottom:10px;">Resultado da IdentificaÃ§Ã£o:</h4>
<div id="faceMatchResult">
<p id="faceMatchText">Aguardando identificaÃ§Ã£o...</p>
<p id="faceConfidence" class="small"></p>
</div>
<div style="margin-top:10px;" id="faceActionButtons">
<button class="btn btn-sm btn-success" id="btnConfirmarIdentificacao" style="display:none;">âœ… Confirmar IdentificaÃ§Ã£o</button>
<button class="btn btn-sm btn-outline" id="btnTentarNovamente">ğŸ”„ Tentar Novamente</button>
</div>
</div>

<div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:12px;">
<h4 style="color:var(--sam-blue);margin-bottom:10px;">ğŸ‘¥ Cadastro de Rostos</h4>
<div class="form-grid">
<div>
<label>Nome do Colaborador</label>
<input class="input" id="faceNome" placeholder="Nome completo">
</div>
<div>
<label>MatrÃ­cula/Chapa</label>
<input class="input" id="faceMatricula" placeholder="NÃºmero de matrÃ­cula">
</div>
</div>
<div style="margin-top:10px;">
<label>DescriÃ§Ã£o (opcional)</label>
<input class="input" id="faceDescricao" placeholder="FunÃ§Ã£o, setor, etc.">
</div>
<div style="display:flex;gap:10px;margin-top:15px;">
<button class="btn btn-primary" id="btnCadastrarRosto">ğŸ“¸ Cadastrar Rosto Atual</button>
<button class="btn btn-outline" id="btnListarRostos">ğŸ‘¥ Listar Rostos Cadastrados</button>
</div>
</div>
</div>

<div class="card" style="margin-top:15px;">
<div class="card-header">
<div>
<div class="card-title">ğŸ“‹ Rostos Cadastrados</div>
<div class="card-sub">Colaboradores registrados no sistema</div>
</div>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>Nome</th>
<th>MatrÃ­cula</th>
<th>DescriÃ§Ã£o</th>
<th>Data Cadastro</th>
<th>AÃ§Ãµes</th>
</tr>
</thead>
<tbody id="tbRostosCadastrados">
</tbody>
</table>
</div>
</div>
</section>

</main>
</div>
</div>

<!-- Modal para visualizaÃ§Ã£o -->
<div class="modal-backdrop" id="modalBackdrop" style="display:none;">
<div class="modal">
<div class="modal-close" id="modalClose">Ã—</div>
<div id="modalBody"></div>
</div>
</div>

<script>
// =========================
// CONFIGURAÃ‡Ã•ES E CONSTANTES
// =========================
const LS_ESTOQUE = 'SAMARCO_ESTOQUE_V2';
const LS_CATALOGO = 'SAMARCO_CATALOGO_EPI_V2';
const LS_SOLICITACOES = 'SAMARCO_SOLICITACOES_V2';
const LS_ROSTOS = 'SAMARCO_ROSTOS_FACIAIS_V1';

// CatÃ¡logo base de EPIs (pode ser extendido pelo usuÃ¡rio)
const EPI_CATALOGO_BASE = [
  { id: 'luva_vaqueta', nome: 'Luva Vaqueta', codigo: '302598', categoria: 'protecao_maos' },
  { id: 'luva_vaqueta_alt', nome: 'Luva Vaqueta (variaÃ§Ã£o)', codigo: '302528 / 396278', categoria: 'protecao_maos' },
  { id: 'capacete', nome: 'Capacete', codigo: '223244', categoria: 'protecao_cabeca' },
  { id: 'mascara', nome: 'MÃ¡scara', codigo: '326581', categoria: 'protecao_respiratoria' },
  { id: 'fita', nome: 'Fita', codigo: '326328', categoria: 'outros' },
  { id: 'protetor_solar_f60', nome: 'Protetor Solar F60', codigo: '360126', categoria: 'outros' },
  { id: 'protetor_solar_f30', nome: 'Protetor Solar F30', codigo: '300955', categoria: 'outros' },
  { id: 'cantil', nome: 'Cantil', codigo: '357298', categoria: 'outros' },
  { id: 'lanterna', nome: 'Lanterna', codigo: '326346', categoria: 'outros' },
  { id: 'luva_ultrame', nome: 'Luva Ultrame', codigo: '211499', categoria: 'protecao_maos' },
  { id: 'protetor_concha', nome: 'Protetor Concha', codigo: '329131', categoria: 'protecao_auditiva' },
  { id: 'protetor_espuma', nome: 'Protetor Espuma', codigo: '302595', categoria: 'protecao_auditiva' },
  { id: 'protetor_plug', nome: 'Protetor Plug', codigo: '302594', categoria: 'protecao_auditiva' },
  { id: 'protetor_acoplado', nome: 'Protetor Acoplado', codigo: '364889', categoria: 'protecao_auditiva' },
  { id: 'oculos_incolor', nome: 'Ã“culos Incolor', codigo: '210498', categoria: 'protecao_visual' },
  { id: 'oculos_escuro', nome: 'Ã“culos Escuro', codigo: '210502', categoria: 'protecao_visual' },
  { id: 'pilha_aa', nome: 'Pilha AA', codigo: '394064', categoria: 'outros' },
  { id: 'pilha_aaa', nome: 'Pilha AAA', codigo: '326569', categoria: 'outros' },
  { id: 'oculos_sahypon', nome: 'Ã“culos Sahypon', codigo: '327878', categoria: 'protecao_visual' },
  { id: 'cadeado_tag', nome: 'Cadeado TAG', codigo: '327148', categoria: 'outros' },
  { id: 'cadeado_20mm', nome: 'Cadeado 20mm', codigo: '326305', categoria: 'outros' },
  { id: 'repelente', nome: 'Repelente', codigo: '356534', categoria: 'outros' },
  { id: 'capa_chuva', nome: 'Capa de Chuva', codigo: '326348', categoria: 'vestimenta' },
  { id: 'colete_m', nome: 'Colete M', codigo: '385046', categoria: 'vestimenta' },
  { id: 'colete_g', nome: 'Colete G', codigo: '385200', categoria: 'vestimenta' },
  { id: 'bone', nome: 'BonÃ©', codigo: '237853', categoria: 'protecao_cabeca' },
  { id: 'cinta', nome: 'Cinta', codigo: '302349', categoria: 'outros' },
  { id: 'clip_luva', nome: 'Clip de Luva', codigo: '391594', categoria: 'outros' },
  { id: 'carneira', nome: 'Carneira', codigo: '223245', categoria: 'vestimenta' },
  { id: 'luva_antiimpacto_8', nome: 'Luva Anti Impacto NÂº 8', codigo: '395976', categoria: 'protecao_maos' },
  { id: 'luva_antiimpacto_9', nome: 'Luva Anti Impacto NÂº 9', codigo: '395977', categoria: 'protecao_maos' },
  { id: 'luva_antiimpacto_10', nome: 'Luva Anti Impacto NÂº 10', codigo: '395978', categoria: 'protecao_maos' }
];

// =========================
// VARIÃVEIS GLOBAIS
// =========================
let estoqueDB = [];
let catalogoEPI = [];
let solicitacoesDB = [];
let rostosDB = [];
let faceDetector = null;
let videoStream = null;
let currentFaceDescriptor = null;
let currentFaceMatch = null;
let charts = {};

// =========================
// FUNÃ‡Ã•ES UTILITÃRIAS
// =========================
function $(id) { return document.getElementById(id); }
function $$(selector) { return Array.from(document.querySelectorAll(selector)); }
function formatDate(date = new Date()) {
  return date.toISOString().slice(0, 10);
}
function formatDateTime(date = new Date()) {
  return date.toLocaleString('pt-BR');
}
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// =========================
// STORAGE - Gerenciamento de dados
// =========================
function saveToStorage(key, data) {
  try {
    localStorage.setItem(key, JSON.stringify(data));
    return true;
  } catch (e) {
    console.error('Erro ao salvar no localStorage:', e);
    return false;
  }
}

function loadFromStorage(key, defaultValue = []) {
  try {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : defaultValue;
  } catch (e) {
    console.error('Erro ao carregar do localStorage:', e);
    return defaultValue;
  }
}

// =========================
// INICIALIZAÃ‡ÃƒO
// =========================
function initApp() {
  // Carregar dados
  estoqueDB = loadFromStorage(LS_ESTOQUE, []);
  catalogoEPI = loadFromStorage(LS_CATALOGO, EPI_CATALOGO_BASE);
  solicitacoesDB = loadFromStorage(LS_SOLICITACOES, []);
  rostosDB = loadFromStorage(LS_ROSTOS, []);
  
  // Configurar data atual
  const today = formatDate();
  $('estoqueData').value = today;
  $('dataSolicitacao').value = today;
  $('hoje').textContent = formatDateTime();
  
  // Inicializar componentes
  initCatalogoEPI();
  initAssinatura();
  initNavigation();
  initEventListeners();
  initFaceAPI();
  
  // Renderizar dados
  renderEstoque();
  renderCatalogo();
  renderSolicitacoes();
  renderRostos();
  updateCharts();
  
  console.log('Sistema de Estoque inicializado com sucesso!');
}

// =========================
// NAVEGAÃ‡ÃƒO
// =========================
function initNavigation() {
  $$('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const sectionId = btn.dataset.sec;
      $$('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      $$('.section').forEach(s => s.classList.remove('active'));
      $(sectionId).classList.add('active');
      
      // Parar cÃ¢mera se nÃ£o estiver na seÃ§Ã£o de reconhecimento
      if (sectionId !== 'sec-estoque-reconhecimento') {
        stopCamera();
      }
    });
  });
}

// =========================
// CATÃLOGO DE EPIs
// =========================
function initCatalogoEPI() {
  const selectEPI = $('estoqueEPI');
  const datalist = $('dlEpiCodigo');
  
  // Limpar opÃ§Ãµes existentes
  selectEPI.innerHTML = '<option value="">Selecione...</option>';
  datalist.innerHTML = '';
  
  // Adicionar EPIs ao select e datalist
  catalogoEPI.forEach(epi => {
    const option = document.createElement('option');
    option.value = epi.id;
    option.textContent = `${epi.nome} (${epi.codigo})`;
    option.dataset.codigo = epi.codigo;
    selectEPI.appendChild(option);
    
    const datalistOption = document.createElement('option');
    datalistOption.value = epi.codigo;
    datalistOption.label = `${epi.nome} - ${epi.codigo}`;
    datalist.appendChild(datalistOption);
  });
  
  // Evento para buscar EPI por cÃ³digo
  $('estoqueEpiCodigoBusca').addEventListener('input', function() {
    const codigo = this.value.trim();
    if (!codigo) return;
    
    const epi = catalogoEPI.find(e => e.codigo.includes(codigo));
    if (epi) {
      $('estoqueEPI').value = epi.id;
    }
  });
  
  // Preencher selects de solicitaÃ§Ã£o
  $$('.episSelect').forEach(select => {
    fillEPISelect(select);
  });
}

function fillEPISelect(selectElement) {
  selectElement.innerHTML = '<option value="">Selecione um EPI...</option>';
  catalogoEPI.forEach(epi => {
    const option = document.createElement('option');
    option.value = epi.id;
    option.textContent = `${epi.nome} (${epi.codigo})`;
    selectElement.appendChild(option);
  });
}

function renderCatalogo() {
  const tbody = $('tbEpiCatalogo');
  tbody.innerHTML = catalogoEPI.map(epi => `
    <tr>
      <td>${escapeHtml(epi.nome)}</td>
      <td>${escapeHtml(epi.codigo)}</td>
      <td>${getCategoriaNome(epi.categoria)}</td>
      <td><span class="status-badge status-ativo">Ativo</span></td>
      <td>
        <button class="btn btn-sm btn-outline" onclick="editarEPI('${epi.id}')">âœï¸</button>
        <button class="btn btn-sm btn-danger" onclick="removerEPI('${epi.id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>
  `).join('');
}

function getCategoriaNome(categoria) {
  const categorias = {
    'protecao_cabeca': 'ProteÃ§Ã£o CabeÃ§a',
    'protecao_auditiva': 'ProteÃ§Ã£o Auditiva',
    'protecao_respiratoria': 'ProteÃ§Ã£o RespiratÃ³ria',
    'protecao_maos': 'ProteÃ§Ã£o MÃ£os',
    'protecao_visual': 'ProteÃ§Ã£o Visual',
    'vestimenta': 'Vestimenta',
    'outros': 'Outros'
  };
  return categorias[categoria] || categoria;
}

// =========================
// MOVIMENTAÃ‡Ã•ES DE ESTOQUE
// =========================
function initAssinatura() {
  const canvas = document.createElement('canvas');
  canvas.width = 300;
  canvas.height = 150;
  canvas.style.width = '100%';
  canvas.style.height = '150px';
  canvas.style.borderRadius = '10px';
  canvas.style.background = '#fff';
  
  const container = $('assinaturaCanvas');
  container.innerHTML = '';
  container.appendChild(canvas);
  
  const ctx = canvas.getContext('2d');
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.strokeStyle = '#111';
  
  let drawing = false;
  let lastX = 0;
  let lastY = 0;
  
  function draw(e) {
    if (!drawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (canvas.width / rect.width);
    const y = (e.clientY - rect.top) * (canvas.height / rect.height);
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    lastX = x;
    lastY = y;
  }
  
  canvas.addEventListener('mousedown', (e) => {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = (e.clientX - rect.left) * (canvas.width / rect.width);
    lastY = (e.clientY - rect.top) * (canvas.height / rect.height);
  });
  
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', () => drawing = false);
  canvas.addEventListener('mouseout', () => drawing = false);
  
  // Touch support for mobile
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    lastX = (touch.clientX - rect.left) * (canvas.width / rect.width);
    lastY = (touch.clientY - rect.top) * (canvas.height / rect.height);
  });
  
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!drawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
    const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
    
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    
    lastX = x;
    lastY = y;
  });
  
  canvas.addEventListener('touchend', () => drawing = false);
  
  // BotÃµes de controle
  $('btnLimparAssinatura').addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });
  
  $('btnAssinaturaPadrao').addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '20px Arial';
    ctx.fillStyle = '#111';
    ctx.fillText('ASSINADO', 50, 75);
  });
  
  $('btnAssinaturaFace').addEventListener('click', () => {
    alert('Use a seÃ§Ã£o de Reconhecimento Facial para identificar-se.');
    setSection('sec-estoque-reconhecimento');
  });
}

function renderEstoque() {
  // Calcular KPIs
  let totalSaldo = 0;
  let totalValor = 0;
  let criticos = 0;
  
  estoqueDB.forEach(item => {
    totalSaldo += item.saldo || 0;
    totalValor += (item.saldo || 0) * (item.valorUnitario || 0);
    if ((item.saldo || 0) <= (item.minimo || 0)) {
      criticos++;
    }
  });
  
  // Atualizar KPIs
  $('kpiEstoqueTotal').textContent = totalSaldo.toLocaleString('pt-BR');
  $('kpiEstoqueCriticoDet').textContent = criticos.toString();
  $('kpiValorTotal').textContent = `R$ ${totalValor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  $('kpiEstoqueValor').textContent = `R$ ${totalValor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  
  // Calcular saÃ­das do mÃªs
  const hoje = new Date();
  const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
  
  let saidasMes = 0;
  let topEPI = '';
  let maxSaidas = 0;
  
  estoqueDB.forEach(item => {
    const saidasItem = item.historico
      ?.filter(h => h.tipo === 'saida' && h.dataISO?.startsWith(mesAtual))
      ?.reduce((sum, h) => sum + (h.quantidade || 0), 0) || 0;
    
    saidasMes += saidasItem;
    
    if (saidasItem > maxSaidas) {
      maxSaidas = saidasItem;
      topEPI = item.epiNome;
    }
  });
  
  $('kpiSaidasMes').textContent = saidasMes.toString();
  $('kpiTopEPI').textContent = topEPI || 'â€”';
  
  // Renderizar tabela de estoque
  const tbody = $('tbEstoque');
  tbody.innerHTML = estoqueDB.map(item => {
    const saldo = item.saldo || 0;
    const minimo = item.minimo || 0;
    const valorUnit = item.valorUnitario || 0;
    const valorTotal = saldo * valorUnit;
    
    let status = 'OK';
    let statusClass = 'status-ativo';
    
    if (saldo <= 0) {
      status = 'ESGOTADO';
      statusClass = 'status-vencido';
    } else if (saldo <= minimo) {
      status = 'CRÃTICO';
      statusClass = 'status-alerta';
    }
    
    const epiInfo = catalogoEPI.find(e => e.id === item.epiId) || { nome: 'Desconhecido', codigo: 'â€”' };
    
    return `
      <tr>
        <td>${escapeHtml(epiInfo.nome)}</td>
        <td>${escapeHtml(epiInfo.codigo)}</td>
        <td>${item.entradas || 0}</td>
        <td>${item.saidas || 0}</td>
        <td><strong>${saldo}</strong></td>
        <td>${minimo}</td>
        <td><span class="status-badge ${statusClass}">${status}</span></td>
        <td>R$ ${valorUnit.toFixed(2)}</td>
        <td>R$ ${valorTotal.toFixed(2)}</td>
        <td>
          <button class="btn btn-sm btn-outline" onclick="ajustarEstoque('${item.epiId}')">Ajustar</button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Renderizar histÃ³rico
  renderHistorico();
}

function renderHistorico() {
  const tbody = $('tbHistoricoEstoque');
  
  // Coletar todos os histÃ³ricos
  const todosHistoricos = [];
  estoqueDB.forEach(item => {
    const epiInfo = catalogoEPI.find(e => e.id === item.epiId) || { nome: 'Desconhecido' };
    
    if (item.historico && Array.isArray(item.historico)) {
      item.historico.forEach(h => {
        todosHistoricos.push({
          ...h,
          epiNome: epiInfo.nome,
          epiId: item.epiId
        });
      });
    }
  });
  
  // Ordenar por data (mais recente primeiro)
  todosHistoricos.sort((a, b) => {
    return new Date(b.dataISO || 0) - new Date(a.dataISO || 0);
  });
  
  // Renderizar
  tbody.innerHTML = todosHistoricos.slice(0, 50).map(h => {
    const data = h.dataISO ? new Date(h.dataISO).toLocaleString('pt-BR') : 'â€”';
    
    return `
      <tr>
        <td>${data}</td>
        <td>${h.tipo === 'entrada' ? 'ğŸ“¥ Entrada' : h.tipo === 'saida' ? 'ğŸ“¤ SaÃ­da' : h.tipo}</td>
        <td>${escapeHtml(h.epiNome)}</td>
        <td>${h.quantidade || 0}</td>
        <td>${escapeHtml(h.colaborador || 'â€”')}</td>
        <td>${escapeHtml(h.setor || 'â€”')}</td>
        <td>${escapeHtml(h.responsavel || 'â€”')}</td>
        <td>
          <button class="btn btn-sm btn-outline" onclick="verDetalhesMovimentacao('${h.epiId}', '${h.id}')">Ver</button>
        </td>
      </tr>
    `;
  }).join('');
}

// =========================
// EVENT LISTENERS
// =========================
function initEventListeners() {
  // BotÃ£o salvar movimentaÃ§Ã£o
  $('btnSalvarEstoque').addEventListener('click', salvarMovimentacao);
  
  // BotÃ£o limpar formulÃ¡rio
  $('btnLimparEstoque').addEventListener('click', () => {
    $('estoqueForm').reset();
    const canvas = $('assinaturaCanvas').querySelector('canvas');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  });
  
  // BotÃ£o relatÃ³rio
  $('btnRelatorioEstoque').addEventListener('click', gerarRelatorioEstoque);
  
  // BotÃ£o alertas
  $('btnAlertasEstoque').addEventListener('click', mostrarAlertasEstoque);
  
  // CatÃ¡logo - Adicionar EPI
  $('btnAdicionarEpi').addEventListener('click', adicionarEPI);
  $('btnLimparEpiNovo').addEventListener('click', () => {
    $('novoEpiNome').value = '';
    $('novoEpiCodigo').value = '';
  });
  
  // SolicitaÃ§Ãµes - Adicionar linha de EPI
  $('adicionarEPIBtn').addEventListener('click', adicionarLinhaEPI);
  
  // SolicitaÃ§Ãµes - Salvar
  $('salvarSolicitacaoBtn').addEventListener('click', salvarSolicitacao);
  
  // SolicitaÃ§Ãµes - Limpar
  $('limparSolicitacaoBtn').addEventListener('click', limparSolicitacao);
  
  // SolicitaÃ§Ãµes - Atualizar
  $('btnSolicRefresh').addEventListener('click', renderSolicitacoes);
  
  // Gerar PDF
  $('gerarSolicitacaoPDF').addEventListener('click', gerarPDFSolicitacao);
  
  // Enviar solicitaÃ§Ã£o
  $('enviarSolicitacaoBtn').addEventListener('click', enviarSolicitacao);
}

// =========================
// FUNÃ‡Ã•ES DE MOVIMENTAÃ‡ÃƒO
// =========================
function salvarMovimentacao() {
  // Validar campos obrigatÃ³rios
  const tipo = $('estoqueTipo').value;
  const epiId = $('estoqueEPI').value;
  const quantidade = parseInt($('estoqueQuantidade').value) || 0;
  const setor = $('estoqueSetor').value;
  
  if (!tipo || !epiId || !quantidade || quantidade <= 0 || !setor) {
    alert('Preencha todos os campos obrigatÃ³rios (*)');
    return;
  }
  
  // Encontrar ou criar item no estoque
  let itemEstoque = estoqueDB.find(item => item.epiId === epiId);
  const epiInfo = catalogoEPI.find(e => e.id === epiId);
  
  if (!itemEstoque) {
    itemEstoque = {
      epiId,
      epiNome: epiInfo?.nome || 'Desconhecido',
      entradas: 0,
      saidas: 0,
      saldo: 0,
      minimo: 1,
      valorUnitario: parseFloat($('estoqueValor').value) || 0,
      historico: []
    };
    estoqueDB.push(itemEstoque);
  }
  
  // Atualizar valores
  const valorUnitario = parseFloat($('estoqueValor').value) || itemEstoque.valorUnitario;
  const dataMov = $('estoqueData').value || formatDate();
  
  if (tipo === 'entrada') {
    itemEstoque.entradas = (itemEstoque.entradas || 0) + quantidade;
    itemEstoque.saldo = (itemEstoque.saldo || 0) + quantidade;
  } else if (tipo === 'saida') {
    if (quantidade > (itemEstoque.saldo || 0)) {
      alert('Quantidade solicitada maior que o saldo disponÃ­vel!');
      return;
    }
    itemEstoque.saidas = (itemEstoque.saidas || 0) + quantidade;
    itemEstoque.saldo = (itemEstoque.saldo || 0) - quantidade;
  }
  
  // Atualizar valor unitÃ¡rio se fornecido
  if (valorUnitario > 0) {
    itemEstoque.valorUnitario = valorUnitario;
  }
  
  // Registrar no histÃ³rico
  const historicoItem = {
    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
    tipo,
    quantidade,
    dataISO: new Date().toISOString(),
    data: dataMov,
    colaborador: $('estoqueColaborador').value || '',
    cpf: $('estoqueCPF').value || '',
    funcao: $('estoqueFuncao').value || '',
    turno: $('estoqueTurno').value || '',
    setor,
    valorUnitario,
    valorTotal: quantidade * valorUnitario,
    observacoes: $('estoqueObs').value || '',
    responsavel: 'Sistema',
    assinatura: 'digital'
  };
  
  if (!itemEstoque.historico) {
    itemEstoque.historico = [];
  }
  itemEstoque.historico.unshift(historicoItem);
  
  // Salvar no localStorage
  saveToStorage(LS_ESTOQUE, estoqueDB);
  
  // Atualizar interface
  renderEstoque();
  updateCharts();
  atualizarDatalistColaboradores();
  
  // Limpar formulÃ¡rio
  $('estoqueTipo').value = '';
  $('estoqueEPI').value = '';
  $('estoqueQuantidade').value = '1';
  $('estoqueValor').value = '';
  $('estoqueColaborador').value = '';
  $('estoqueCPF').value = '';
  $('estoqueFuncao').value = '';
  $('estoqueTurno').value = '';
  $('estoqueSetor').value = '';
  $('estoqueObs').value = '';
  
  // Limpar assinatura
  const canvas = $('assinaturaCanvas').querySelector('canvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  
  alert('MovimentaÃ§Ã£o registrada com sucesso!');
}

function ajustarEstoque(epiId) {
  const item = estoqueDB.find(i => i.epiId === epiId);
  if (!item) return;
  
  const novoSaldo = prompt(`Ajustar saldo para "${item.epiNome}":`, item.saldo || 0);
  if (novoSaldo === null) return;
  
  const saldoNum = parseInt(novoSaldo);
  if (isNaN(saldoNum) || saldoNum < 0) {
    alert('Valor invÃ¡lido!');
    return;
  }
  
  // Registrar ajuste no histÃ³rico
  const ajusteItem = {
    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
    tipo: 'ajuste',
    quantidade: saldoNum - (item.saldo || 0),
    dataISO: new Date().toISOString(),
    data: formatDate(),
    colaborador: 'Sistema',
    setor: 'Administrativo',
    observacoes: `Ajuste manual: ${item.saldo || 0} â†’ ${saldoNum}`,
    responsavel: 'Administrador'
  };
  
  item.saldo = saldoNum;
  if (!item.historico) item.historico = [];
  item.historico.unshift(ajusteItem);
  
  saveToStorage(LS_ESTOQUE, estoqueDB);
  renderEstoque();
  updateCharts();
  
  alert('Estoque ajustado com sucesso!');
}

function verDetalhesMovimentacao(epiId, historicoId) {
  const item = estoqueDB.find(i => i.epiId === epiId);
  if (!item || !item.historico) return;
  
  const mov = item.historico.find(h => h.id === historicoId);
  if (!mov) return;
  
  const detalhes = `
    <h3>Detalhes da MovimentaÃ§Ã£o</h3>
    <p><strong>EPI:</strong> ${item.epiNome}</p>
    <p><strong>Tipo:</strong> ${mov.tipo === 'entrada' ? 'ğŸ“¥ Entrada' : 'ğŸ“¤ SaÃ­da'}</p>
    <p><strong>Quantidade:</strong> ${mov.quantidade}</p>
    <p><strong>Data:</strong> ${mov.data ? new Date(mov.data).toLocaleString('pt-BR') : 'â€”'}</p>
    <p><strong>Colaborador:</strong> ${mov.colaborador || 'â€”'}</p>
    <p><strong>Setor:</strong> ${mov.setor || 'â€”'}</p>
    <p><strong>ObservaÃ§Ãµes:</strong> ${mov.observacoes || 'â€”'}</p>
    <p><strong>Valor UnitÃ¡rio:</strong> R$ ${(mov.valorUnitario || 0).toFixed(2)}</p>
    <p><strong>Valor Total:</strong> R$ ${(mov.valorTotal || 0).toFixed(2)}</p>
  `;
  
  $('modalBody').innerHTML = detalhes;
  $('modalBackdrop').style.display = 'flex';
}

// =========================
// CATÃLOGO - CRUD
// =========================
function adicionarEPI() {
  const nome = $('novoEpiNome').value.trim();
  const codigo = $('novoEpiCodigo').value.trim();
  const categoria = $('novoEpiCategoria').value;
  
  if (!nome || !codigo) {
    alert('Preencha nome e cÃ³digo do EPI!');
    return;
  }
  
  // Verificar se cÃ³digo jÃ¡ existe
  if (catalogoEPI.some(epi => epi.codigo === codigo)) {
    alert('CÃ³digo jÃ¡ cadastrado!');
    return;
  }
  
  const novoEPI = {
    id: 'epi_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
    nome,
    codigo,
    categoria,
    dataCadastro: new Date().toISOString()
  };
  
  catalogoEPI.push(novoEPI);
  saveToStorage(LS_CATALOGO, catalogoEPI);
  
  // Atualizar interface
  initCatalogoEPI();
  renderCatalogo();
  
  // Limpar formulÃ¡rio
  $('novoEpiNome').value = '';
  $('novoEpiCodigo').value = '';
  
  alert('EPI adicionado ao catÃ¡logo!');
}

function editarEPI(epiId) {
  const epi = catalogoEPI.find(e => e.id === epiId);
  if (!epi) return;
  
  const novoNome = prompt('Novo nome do EPI:', epi.nome);
  if (novoNome === null) return;
  
  const novoCodigo = prompt('Novo cÃ³digo:', epi.codigo);
  if (novoCodigo === null) return;
  
  epi.nome = novoNome.trim();
  epi.codigo = novoCodigo.trim();
  
  saveToStorage(LS_CATALOGO, catalogoEPI);
  initCatalogoEPI();
  renderCatalogo();
  
  alert('EPI atualizado!');
}

function removerEPI(epiId) {
  if (!confirm('Tem certeza que deseja remover este EPI do catÃ¡logo?')) return;
  
  // Verificar se hÃ¡ movimentaÃ§Ãµes para este EPI
  const temMovimentacoes = estoqueDB.some(item => item.epiId === epiId);
  if (temMovimentacoes) {
    alert('NÃ£o Ã© possÃ­vel remover este EPI pois hÃ¡ movimentaÃ§Ãµes registradas!');
    return;
  }
  
  catalogoEPI = catalogoEPI.filter(e => e.id !== epiId);
  saveToStorage(LS_CATALOGO, catalogoEPI);
  
  initCatalogoEPI();
  renderCatalogo();
  
  alert('EPI removido do catÃ¡logo!');
}

// =========================
// SOLICITAÃ‡Ã•ES
// =========================
function adicionarLinhaEPI() {
  const container = $('episContainer');
  const novoItem = document.createElement('div');
  novoItem.className = 'epi-item';
  novoItem.style.marginBottom = '10px';
  
  novoItem.innerHTML = `
    <div class="form-grid" style="grid-template-columns:2fr 1fr auto;align-items:end;">
      <div>
        <label style="font-size:11px;color:#6b7280;">EPI</label>
        <select class="input episSelect">
          <option value="">Selecione um EPI...</option>
        </select>
      </div>
      <div>
        <label style="font-size:11px;color:#6b7280;">Quantidade</label>
        <input class="input epiQuantidade" type="number" min="1" value="1">
      </div>
      <div style="padding-bottom:2px;">
        <button class="btn btn-outline btn-sm removerEPI" type="button">Remover</button>
      </div>
    </div>
  `;
  
  container.appendChild(novoItem);
  
  // Preencher select com EPIs
  const select = novoItem.querySelector('.episSelect');
  fillEPISelect(select);
  
  // Adicionar evento de remoÃ§Ã£o
  novoItem.querySelector('.removerEPI').addEventListener('click', () => {
    container.removeChild(novoItem);
  });
}

function salvarSolicitacao() {
  const solicitante = $('solicitanteNome').value.trim();
  const setor = $('solicitanteSetor').value;
  const matricula = $('solicitanteMatricula').value.trim();
  const dataSolicitacao = $('dataSolicitacao').value;
  const justificativa = $('solicitacaoJustificativa').value.trim();
  
  if (!solicitante || !setor || !matricula || !dataSolicitacao || !justificativa) {
    alert('Preencha todos os campos obrigatÃ³rios!');
    return;
  }
  
  // Coletar EPIs solicitados
  const episItems = $$('.epi-item');
  const episSolicitados = [];
  
  episItems.forEach(item => {
    const select = item.querySelector('.episSelect');
    const quantidade = item.querySelector('.epiQuantidade');
    
    if (select.value && quantidade.value && parseInt(quantidade.value) > 0) {
      const epiInfo = catalogoEPI.find(e => e.id === select.value);
      if (epiInfo) {
        episSolicitados.push({
          epiId: select.value,
          epiNome: epiInfo.nome,
          epiCodigo: epiInfo.codigo,
          quantidade: parseInt(quantidade.value)
        });
      }
    }
  });
  
  if (episSolicitados.length === 0) {
    alert('Adicione pelo menos um EPI Ã  solicitaÃ§Ã£o!');
    return;
  }
  
  const novaSolicitacao = {
    id: 'sol_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
    solicitante,
    setor,
    matricula,
    dataSolicitacao,
    justificativa,
    epis: episSolicitados,
    status: 'pendente',
    dataCriacao: new Date().toISOString(),
    dataAtualizacao: new Date().toISOString()
  };
  
  solicitacoesDB.unshift(novaSolicitacao);
  saveToStorage(LS_SOLICITACOES, solicitacoesDB);
  
  renderSolicitacoes();
  limparSolicitacao();
  
  alert('SolicitaÃ§Ã£o salva com sucesso!');
}

function limparSolicitacao() {
  $('solicitanteNome').value = '';
  $('solicitanteSetor').value = '';
  $('solicitanteMatricula').value = '';
  $('dataSolicitacao').value = formatDate();
  $('solicitacaoJustificativa').value = '';
  
  // Manter apenas uma linha de EPI
  const container = $('episContainer');
  container.innerHTML = `
    <div class="epi-item" style="margin-bottom:10px;">
      <div class="form-grid" style="grid-template-columns:2fr 1fr auto;align-items:end;">
        <div>
          <label style="font-size:11px;color:#6b7280;">EPI</label>
          <select class="input episSelect">
            <option value="">Selecione um EPI...</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px;color:#6b7280;">Quantidade</label>
          <input class="input epiQuantidade" type="number" min="1" value="1">
        </div>
        <div style="padding-bottom:2px;">
          <button class="btn btn-outline btn-sm removerEPI" type="button">Remover</button>
        </div>
      </div>
    </div>
  `;
  
  // Preencher select e adicionar evento
  const select = container.querySelector('.episSelect');
  fillEPISelect(select);
  container.querySelector('.removerEPI').addEventListener('click', (e) => {
    if ($$('.epi-item').length > 1) {
      e.target.closest('.epi-item').remove();
    }
  });
}

function renderSolicitacoes() {
  const tbody = $('tbSolicSalvas');
  tbody.innerHTML = solicitacoesDB.map(sol => {
    const itensStr = sol.epis.map(e => `${e.quantidade}x ${e.epiNome}`).join(', ');
    const data = new Date(sol.dataSolicitacao).toLocaleDateString('pt-BR');
    
    let statusBadge = '';
    switch(sol.status) {
      case 'aprovada': statusBadge = '<span class="status-badge status-ativo">Aprovada</span>'; break;
      case 'rejeitada': statusBadge = '<span class="status-badge status-vencido">Rejeitada</span>'; break;
      case 'atendida': statusBadge = '<span class="status-badge status-ativo">Atendida</span>'; break;
      default: statusBadge = '<span class="status-badge status-pendente">Pendente</span>';
    }
    
    return `
      <tr>
        <td><input type="checkbox" value="${sol.id}"></td>
        <td>${data}</td>
        <td>${escapeHtml(sol.solicitante)}</td>
        <td>${escapeHtml(sol.setor)}</td>
        <td title="${escapeHtml(itensStr)}">${itensStr.length > 50 ? itensStr.substring(0, 50) + '...' : itensStr}</td>
        <td>
          ${statusBadge}
          <button class="btn btn-sm btn-outline" onclick="verSolicitacao('${sol.id}')">Ver</button>
          <button class="btn btn-sm btn-danger" onclick="removerSolicitacao('${sol.id}')">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `;
  }).join('');
}

function verSolicitacao(solId) {
  const sol = solicitacoesDB.find(s => s.id === solId);
  if (!sol) return;
  
  const itensHTML = sol.epis.map(e => `
    <tr>
      <td>${e.epiNome}</td>
      <td>${e.epiCodigo}</td>
      <td>${e.quantidade}</td>
    </tr>
  `).join('');
  
  const detalhes = `
    <h3>SolicitaÃ§Ã£o #${sol.id.substring(0, 8)}</h3>
    <p><strong>Solicitante:</strong> ${sol.solicitante}</p>
    <p><strong>Setor:</strong> ${sol.setor}</p>
    <p><strong>MatrÃ­cula:</strong> ${sol.matricula}</p>
    <p><strong>Data:</strong> ${new Date(sol.dataSolicitacao).toLocaleDateString('pt-BR')}</p>
    <p><strong>Status:</strong> ${sol.status}</p>
    <p><strong>Justificativa:</strong> ${sol.justificativa}</p>
    
    <h4 style="margin-top:20px;">Itens Solicitados</h4>
    <table style="width:100%;border-collapse:collapse;margin-top:10px;">
      <thead>
        <tr>
          <th style="border:1px solid #ddd;padding:8px;">EPI</th>
          <th style="border:1px solid #ddd;padding:8px;">CÃ³digo</th>
          <th style="border:1px solid #ddd;padding:8px;">Quantidade</th>
        </tr>
      </thead>
      <tbody>${itensHTML}</tbody>
    </table>
    
    <div style="margin-top:20px;">
      <button class="btn btn-sm btn-success" onclick="aprovarSolicitacao('${sol.id}')">Aprovar</button>
      <button class="btn btn-sm btn-warning" onclick="rejeitarSolicitacao('${sol.id}')">Rejeitar</button>
      <button class="btn btn-sm btn-primary" onclick="atenderSolicitacao('${sol.id}')">Atender</button>
    </div>
  `;
  
  $('modalBody').innerHTML = detalhes;
  $('modalBackdrop').style.display = 'flex';
}

function aprovarSolicitacao(solId) {
  const sol = solicitacoesDB.find(s => s.id === solId);
  if (sol) {
    sol.status = 'aprovada';
    sol.dataAtualizacao = new Date().toISOString();
    saveToStorage(LS_SOLICITACOES, solicitacoesDB);
    renderSolicitacoes();
    $('modalBackdrop').style.display = 'none';
    alert('SolicitaÃ§Ã£o aprovada!');
  }
}

function rejeitarSolicitacao(solId) {
  const sol = solicitacoesDB.find(s => s.id === solId);
  if (sol) {
    sol.status = 'rejeitada';
    sol.dataAtualizacao = new Date().toISOString();
    saveToStorage(LS_SOLICITACOES, solicitacoesDB);
    renderSolicitacoes();
    $('modalBackdrop').style.display = 'none';
    alert('SolicitaÃ§Ã£o rejeitada!');
  }
}

function atenderSolicitacao(solId) {
  const sol = solicitacoesDB.find(s => s.id === solId);
  if (!sol) return;
  
  // Verificar estoque para cada item
  const faltas = [];
  sol.epis.forEach(item => {
    const estoqueItem = estoqueDB.find(e => e.epiId === item.epiId);
    const saldo = estoqueItem ? (estoqueItem.saldo || 0) : 0;
    if (saldo < item.quantidade) {
      faltas.push(`${item.epiNome} (faltam ${item.quantidade - saldo} unidades)`);
    }
  });
  
  if (faltas.length > 0) {
    alert(`NÃ£o Ã© possÃ­vel atender a solicitaÃ§Ã£o. Faltam:\n\n${faltas.join('\n')}`);
    return;
  }
  
  // Atualizar estoque para cada item
  sol.epis.forEach(item => {
    let estoqueItem = estoqueDB.find(e => e.epiId === item.epiId);
    if (estoqueItem) {
      estoqueItem.saidas = (estoqueItem.saidas || 0) + item.quantidade;
      estoqueItem.saldo = (estoqueItem.saldo || 0) - item.quantidade;
      
      // Registrar no histÃ³rico
      const historicoItem = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2),
        tipo: 'saida',
        quantidade: item.quantidade,
        dataISO: new Date().toISOString(),
        data: formatDate(),
        colaborador: sol.solicitante,
        setor: sol.setor,
        observacoes: `Atendimento da solicitaÃ§Ã£o ${sol.id}`,
        responsavel: 'Sistema'
      };
      
      if (!estoqueItem.historico) estoqueItem.historico = [];
      estoqueItem.historico.unshift(historicoItem);
    }
  });
  
  // Atualizar status da solicitaÃ§Ã£o
  sol.status = 'atendida';
  sol.dataAtualizacao = new Date().toISOString();
  
  // Salvar alteraÃ§Ãµes
  saveToStorage(LS_ESTOQUE, estoqueDB);
  saveToStorage(LS_SOLICITACOES, solicitacoesDB);
  
  // Atualizar interface
  renderEstoque();
  renderSolicitacoes();
  updateCharts();
  $('modalBackdrop').style.display = 'none';
  
  alert('SolicitaÃ§Ã£o atendida e estoque atualizado!');
}

function removerSolicitacao(solId) {
  if (!confirm('Tem certeza que deseja remover esta solicitaÃ§Ã£o?')) return;
  
  solicitacoesDB = solicitacoesDB.filter(s => s.id !== solId);
  saveToStorage(LS_SOLICITACOES, solicitacoesDB);
  renderSolicitacoes();
  
  alert('SolicitaÃ§Ã£o removida!');
}

// =========================
// RELATÃ“RIOS E GRÃFICOS
// =========================
function updateCharts() {
  // GrÃ¡fico 1: MovimentaÃ§Ã£o por EPI
  const ctx1 = $('chartEstoque')?.getContext('2d');
  if (ctx1 && window.Chart) {
    if (charts.estoque) charts.estoque.destroy();
    
    const labels = estoqueDB.map(item => {
      const epi = catalogoEPI.find(e => e.id === item.epiId);
      return epi ? epi.nome.substring(0, 20) : item.epiId.substring(0, 10);
    });
    
    const entradas = estoqueDB.map(item => item.entradas || 0);
    const saidas = estoqueDB.map(item => item.saidas || 0);
    
    charts.estoque = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Entradas',
            data: entradas,
            backgroundColor: '#3a9d5d',
            borderColor: '#2e7d32',
            borderWidth: 1
          },
          {
            label: 'SaÃ­das',
            data: saidas,
            backgroundColor: '#f7941d',
            borderColor: '#e68919',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Quantidade'
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 0
            }
          }
        }
      }
    });
  }
  
  // GrÃ¡fico 2: SaÃ­das por Colaborador (este mÃªs)
  const ctx2 = $('chartEstoqueOperador')?.getContext('2d');
  if (ctx2 && window.Chart) {
    if (charts.operador) charts.operador.destroy();
    
    const mesAtual = new Date().getMonth();
    const anoAtual = new Date().getFullYear();
    
    const saidasPorColaborador = {};
    
    estoqueDB.forEach(item => {
      if (item.historico) {
        item.historico.forEach(h => {
          if (h.tipo === 'saida') {
            const data = new Date(h.dataISO || h.data);
            if (data.getMonth() === mesAtual && data.getFullYear() === anoAtual) {
              const key = h.colaborador || 'Desconhecido';
              saidasPorColaborador[key] = (saidasPorColaborador[key] || 0) + (h.quantidade || 0);
            }
          }
        });
      }
    });
    
    const colaboradores = Object.keys(saidasPorColaborador);
    const quantidades = Object.values(saidasPorColaborador);
    
    // Ordenar do maior para o menor e pegar top 10
    const indices = colaboradores.map((_, i) => i);
    indices.sort((a, b) => quantidades[b] - quantidades[a]);
    
    const topColaboradores = indices.slice(0, 10).map(i => colaboradores[i]);
    const topQuantidades = indices.slice(0, 10).map(i => quantidades[i]);
    
    charts.operador = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: topColaboradores,
        datasets: [{
          label: 'SaÃ­das (este mÃªs)',
          data: topQuantidades,
          backgroundColor: '#005c8f',
          borderColor: '#003b5c',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Quantidade'
            }
          },
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 0
            }
          }
        }
      }
    });
  }
  
  // GrÃ¡fico 3: SaÃ­das por Turno
  const ctx3 = $('chartEstoqueTurno')?.getContext('2d');
  if (ctx3 && window.Chart) {
    if (charts.turno) charts.turno.destroy();
    
    const saidasPorTurno = {};
    
    estoqueDB.forEach(item => {
      if (item.historico) {
        item.historico.forEach(h => {
          if (h.tipo === 'saida' && h.turno) {
            saidasPorTurno[h.turno] = (saidasPorTurno[h.turno] || 0) + (h.quantidade || 0);
          }
        });
      }
    });
    
    const turnos = Object.keys(saidasPorTurno);
    const quantidadesTurno = Object.values(saidasPorTurno);
    
    charts.turno = new Chart(ctx3, {
      type: 'pie',
      data: {
        labels: turnos,
        datasets: [{
          data: quantidadesTurno,
          backgroundColor: [
            '#005c8f', '#3a9d5d', '#f7941d', '#d9534f',
            '#5bc0de', '#5cb85c', '#f0ad4e', '#d9534f'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // GrÃ¡fico 4: SaÃ­das por Ãrea / Frente (Setor)
  const ctx4 = $('chartEstoqueArea')?.getContext('2d');
  if (ctx4 && window.Chart) {
    if (charts.area) charts.area.destroy();

    const saidasPorArea = {};
    estoqueDB.forEach(item => {
      (item.historico || []).forEach(h => {
        if (h.tipo === 'saida') {
          const area = (h.setor || 'NÃ£o informado').toString().trim() || 'NÃ£o informado';
          saidasPorArea[area] = (saidasPorArea[area] || 0) + (h.quantidade || 0);
        }
      });
    });

    const areas = Object.keys(saidasPorArea);
    const qtdAreas = Object.values(saidasPorArea);

    // Ordenar por maior saÃ­da
    const order = areas.map((_, i) => i).sort((a,b) => (qtdAreas[b]||0) - (qtdAreas[a]||0));
    const labelsArea = order.map(i => areas[i]);
    const dataArea = order.map(i => qtdAreas[i]);

    charts.area = new Chart(ctx4, {
      type: 'bar',
      data: {
        labels: labelsArea,
        datasets: [{
          label: 'SaÃ­das (unid.)',
          data: dataArea,
          backgroundColor: '#0e7490',
          borderColor: '#0b5563',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Quantidade' } },
          x: { ticks: { maxRotation: 45, minRotation: 0 } }
        }
      }
    });
  }

  // GrÃ¡fico 5: Histograma de SaÃ­das (faixas de quantidade)
  const ctx5 = $('chartEstoqueHist')?.getContext('2d');
  if (ctx5 && window.Chart) {
    if (charts.hist) charts.hist.destroy();

    const saidas = [];
    estoqueDB.forEach(item => {
      (item.historico || []).forEach(h => {
        if (h.tipo === 'saida') saidas.push(Number(h.quantidade || 0));
      });
    });

    const bins = [
      { label: '1', min: 1, max: 1 },
      { label: '2â€“3', min: 2, max: 3 },
      { label: '4â€“5', min: 4, max: 5 },
      { label: '6â€“10', min: 6, max: 10 },
      { label: '11+', min: 11, max: Infinity },
    ];
    const freq = bins.map(b => saidas.filter(v => v>=b.min && v<=b.max).length);

    charts.hist = new Chart(ctx5, {
      type: 'bar',
      data: {
        labels: bins.map(b => b.label),
        datasets: [{
          label: 'FrequÃªncia (eventos)',
          data: freq,
          backgroundColor: '#7c3aed',
          borderColor: '#5b21b6',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'FrequÃªncia' } },
          x: { title: { display: true, text: 'Faixa (quantidade por saÃ­da)' } }
        }
      }
    });
  }

  // EstatÃ­stica (estilo Minitab) â€“ SaÃ­das
  (function renderMinitabStats(){
    const tb = $('tbEstoqueStats');
    if (!tb) return;

    const vals = [];
    estoqueDB.forEach(item => (item.historico || []).forEach(h => {
      if (h.tipo === 'saida') vals.push(Number(h.quantidade || 0));
    }));

    function median(arr){
      if (!arr.length) return 0;
      const a = [...arr].sort((x,y)=>x-y);
      const mid = Math.floor(a.length/2);
      return a.length%2 ? a[mid] : (a[mid-1]+a[mid])/2;
    }
    function mean(arr){ return arr.length ? arr.reduce((s,v)=>s+v,0)/arr.length : 0; }
    function stdev(arr){
      if (arr.length < 2) return 0;
      const m = mean(arr);
      const v = arr.reduce((s,x)=>s+Math.pow(x-m,2),0)/(arr.length-1);
      return Math.sqrt(v);
    }

    const n = vals.length;
    const m = mean(vals);
    const sd = stdev(vals);
    const mn = n ? Math.min(...vals) : 0;
    const mx = n ? Math.max(...vals) : 0;
    const med = median(vals);

    const rows = [
      ['N (eventos de saÃ­da)', n.toString()],
      ['MÃ©dia (qtd por saÃ­da)', n ? m.toFixed(2) : '0'],
      ['Desvio padrÃ£o (s)', n ? sd.toFixed(2) : '0'],
      ['MÃ­nimo', mn.toString()],
      ['Mediana', n ? med.toFixed(2) : '0'],
      ['MÃ¡ximo', mx.toString()],
    ];

    tb.innerHTML = rows.map(r => `<tr><td>${r[0]}</td><td><strong>${r[1]}</strong></td></tr>`).join('');
  })();

}

function gerarRelatorioEstoque() {
  const hoje = new Date();
  const dataFormatada = hoje.toLocaleDateString('pt-BR');
  const horaFormatada = hoje.toLocaleTimeString('pt-BR');
  
  let relatorioHTML = `
    <div style="font-family: Arial, sans-serif; padding: 20px;">
      <h1 style="color: #005c8f; border-bottom: 2px solid #005c8f; padding-bottom: 10px;">
        ğŸ“Š RelatÃ³rio de Estoque - CONTERPLAN
      </h1>
      <p><strong>Data do relatÃ³rio:</strong> ${dataFormatada} ${horaFormatada}</p>
      
      <h2 style="color: #003b5c; margin-top: 30px;">Resumo do Estoque</h2>
      <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tr style="background-color: #f3f6fb;">
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Item</th>
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Valor</th>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;">Total de EPIs cadastrados</td>
          <td style="border: 1px solid #ddd; padding: 10px;">${estoqueDB.length}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;">Saldo total em estoque</td>
          <td style="border: 1px solid #ddd; padding: 10px;">${estoqueDB.reduce((sum, item) => sum + (item.saldo || 0), 0)} unidades</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;">Valor total do estoque</td>
          <td style="border: 1px solid #ddd; padding: 10px;">R$ ${estoqueDB.reduce((sum, item) => sum + ((item.saldo || 0) * (item.valorUnitario || 0)), 0).toFixed(2)}</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;">Itens com estoque crÃ­tico</td>
          <td style="border: 1px solid #ddd; padding: 10px;">${estoqueDB.filter(item => (item.saldo || 0) <= (item.minimo || 0)).length}</td>
        </tr>
      </table>
      
      <h2 style="color: #003b5c; margin-top: 30px;">Itens com Estoque CrÃ­tico</h2>
  `;
  
  const criticos = estoqueDB.filter(item => (item.saldo || 0) <= (item.minimo || 0));
  if (criticos.length > 0) {
    relatorioHTML += `
      <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <tr style="background-color: #f3f6fb;">
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">EPI</th>
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">CÃ³digo</th>
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Saldo</th>
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">MÃ­nimo</th>
          <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Status</th>
        </tr>
    `;
    
    criticos.forEach(item => {
      const epiInfo = catalogoEPI.find(e => e.id === item.epiId) || { nome: 'Desconhecido', codigo: 'â€”' };
      relatorioHTML += `
        <tr>
          <td style="border: 1px solid #ddd; padding: 10px;">${epiInfo.nome}</td>
          <td style="border: 1px solid #ddd; padding: 10px;">${epiInfo.codigo}</td>
          <td style="border: 1px solid #ddd; padding: 10px;">${item.saldo || 0}</td>
          <td style="border: 1px solid #ddd; padding: 10px;">${item.minimo || 0}</td>
          <td style="border: 1px solid #ddd; padding: 10px; color: #d9534f;">CRÃTICO</td>
        </tr>
      `;
    });
    
    relatorioHTML += '</table>';
  } else {
    relatorioHTML += '<p>Nenhum item com estoque crÃ­tico.</p>';
  }
  
  relatorioHTML += `
      <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee;">
        <p><strong>Gerado por:</strong> Sistema de Controle de Estoque CONTERPLAN</p>
        <p><strong>PÃ¡gina:</strong> 1/1</p>
      </div>
    </div>
  `;
  
  // Gerar PDF
  exportHTMLToPDF(relatorioHTML, `Relatorio_Estoque_CONTERPLAN_${hoje.getFullYear()}${String(hoje.getMonth() + 1).padStart(2, '0')}${String(hoje.getDate()).padStart(2, '0')}.pdf`);
}

function mostrarAlertasEstoque() {
  const criticos = estoqueDB.filter(item => (item.saldo || 0) <= (item.minimo || 0));
  
  if (criticos.length === 0) {
    alert('âœ… Nenhum alerta de estoque crÃ­tico no momento.');
    return;
  }
  
  let alertasHTML = '<h3 style="color: #d9534f;">ğŸš¨ Alertas de Estoque CrÃ­tico</h3><ul style="margin-top: 15px;">';
  
  criticos.forEach(item => {
    const epiInfo = catalogoEPI.find(e => e.id === item.epiId) || { nome: 'Desconhecido', codigo: 'â€”' };
    alertasHTML += `
      <li style="margin-bottom: 10px;">
        <strong>${epiInfo.nome}</strong> (${epiInfo.codigo})<br>
        Estoque: ${item.saldo || 0} | MÃ­nimo: ${item.minimo || 0}<br>
        <span style="color: #d9534f;">âš ï¸ NecessÃ¡rio reposiÃ§Ã£o urgente!</span>
      </li>
    `;
  });
  
  alertasHTML += '</ul>';
  
  $('modalBody').innerHTML = alertasHTML;
  $('modalBackdrop').style.display = 'flex';
}

function gerarPDFSolicitacao() {
  try {
    const selecionadas = getSolicitacoesSelecionadas();
    const lista = selecionadas.length ? selecionadas : (solicitacoesDB.length ? [solicitacoesDB[0]] : []);
    if (!lista.length) { alert('Nenhuma solicitaÃ§Ã£o encontrada. Salve uma solicitaÃ§Ã£o primeiro.'); return; }

    const html = buildSolicitacoesPDFHTML(lista);
    const stamp = new Date();
    const fn = `Solicitacoes_EPI_${stamp.getFullYear()}${String(stamp.getMonth()+1).padStart(2,'0')}${String(stamp.getDate()).padStart(2,'0')}_${String(stamp.getHours()).padStart(2,'0')}${String(stamp.getMinutes()).padStart(2,'0')}.pdf`;
    exportHTMLToPDF(html, fn);
  } catch (e) {
    console.error(e);
    alert('NÃ£o foi possÃ­vel gerar o PDF. Verifique sua conexÃ£o e tente novamente.');
  }
}

async function enviarSolicitacao() {
  try {
    const selecionadas = getSolicitacoesSelecionadas();
    const lista = selecionadas.length ? selecionadas : (solicitacoesDB.length ? [solicitacoesDB[0]] : []);
    if (!lista.length) { alert('Nenhuma solicitaÃ§Ã£o encontrada. Salve uma solicitaÃ§Ã£o primeiro.'); return; }

    const html = buildSolicitacoesPDFHTML(lista);

    // 1) Tenta compartilhar o PDF como arquivo (Android/iOS modernos)
    const stamp = new Date();
    const filename = `Solicitacoes_EPI_${stamp.getFullYear()}${String(stamp.getMonth()+1).padStart(2,'0')}${String(stamp.getDate()).padStart(2,'0')}.pdf`;
    const blob = await exportHTMLToPDFBlob(html);

    const msg = buildWhatsAppResumoSolicitacoes(lista);

    if (navigator.share && blob) {
      try {
        const file = new File([blob], filename, { type: 'application/pdf' });
        await navigator.share({
          title: 'SolicitaÃ§Ã£o de EPIs',
          text: msg,
          files: [file]
        });
        return;
      } catch (shareErr) {
        console.warn('Share falhou, abrindo WhatsApp como fallback.', shareErr);
      }
    }

    // 2) Fallback: abre WhatsApp com texto (usuÃ¡rio anexa o PDF manualmente)
    const waUrl = 'https://wa.me/?text=' + encodeURIComponent(msg + "\n\n(Anexe o PDF gerado no botÃ£o \"Gerar PDF\" se precisar enviar como arquivo.)");
    window.open(waUrl, '_blank');
  } catch (e) {
    console.error(e);
    alert('NÃ£o foi possÃ­vel enviar. Tente novamente.');
  }
}

function getSolicitacoesSelecionadas() {
  const checks = Array.from(document.querySelectorAll('#tbSolicSalvas input[type="checkbox"]:checked'));
  const ids = checks.map(c => c.value).filter(Boolean);
  return ids.map(id => solicitacoesDB.find(s => s.id === id)).filter(Boolean);
}

function buildWhatsAppResumoSolicitacoes(lista) {
  const now = new Date().toLocaleString('pt-BR');
  const linhas = [];
  linhas.push('ğŸ“Œ *SolicitaÃ§Ã£o de EPIs*');
  linhas.push(`ğŸ•’ ${now}`);
  linhas.push('');
  lista.forEach((s, idx) => {
    linhas.push(`*#${idx+1}* â€” ${s.solicitante} | ${s.setor} | MatrÃ­cula: ${s.matricula}`);
    linhas.push(`Data: ${new Date(s.dataSolicitacao).toLocaleDateString('pt-BR')} | Status: ${String(s.status||'pendente').toUpperCase()}`);
    linhas.push('Itens:');
    (s.epis||[]).forEach(it => {
      linhas.push(`â€¢ ${it.quantidade}x ${it.epiNome} (${it.epiCodigo})`);
    });
    linhas.push(`Justificativa: ${s.justificativa}`);
    if (idx !== lista.length-1) linhas.push('â€” â€” â€”');
  });
  return linhas.join('\n');
}

function buildSolicitacoesPDFHTML(lista) {
  const now = new Date();
  const dataHora = now.toLocaleString('pt-BR');
  const cab = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div>
        <div style="font-size:18px;font-weight:800;color:#005c8f;">SolicitaÃ§Ã£o de EPIs</div>
        <div style="font-size:11px;color:#6b7280;margin-top:2px;">CONTERPLAN Â· ServiÃ§os de Campo e Obras</div>
        <div style="font-size:11px;color:#6b7280;margin-top:2px;">Gerado em: ${dataHora}</div>
      </div>
      <div style="font-size:11px;color:#6b7280;text-align:right;">
        <div><strong>Total:</strong> ${lista.length}</div>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;">
  `;

  const blocos = lista.map((s, idx) => {
    const itens = (s.epis||[]).map(it => `
      <tr>
        <td style="border:1px solid #e5e7eb;padding:6px 8px;">${escapeHtml(it.epiNome||'')}</td>
        <td style="border:1px solid #e5e7eb;padding:6px 8px;">${escapeHtml(it.epiCodigo||'')}</td>
        <td style="border:1px solid #e5e7eb;padding:6px 8px;text-align:center;">${it.quantidade||0}</td>
      </tr>
    `).join('');

    const status = String(s.status||'pendente');
    return `
      <div style="margin-top:${idx===0?0:14}px;">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
          <div style="font-size:13px;font-weight:800;color:#111;">#${idx+1} Â· ${escapeHtml(s.solicitante||'')}</div>
          <div style="font-size:11px;color:#6b7280;">ID: ${escapeHtml((s.id||'').slice(0,10))}</div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:8px;">
          <div style="border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
            <div style="font-size:10px;color:#6b7280;">Setor</div>
            <div style="font-size:12px;font-weight:700;">${escapeHtml(s.setor||'')}</div>
          </div>
          <div style="border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
            <div style="font-size:10px;color:#6b7280;">MatrÃ­cula</div>
            <div style="font-size:12px;font-weight:700;">${escapeHtml(s.matricula||'')}</div>
          </div>
          <div style="border:1px solid #e5e7eb;border-radius:10px;padding:8px;">
            <div style="font-size:10px;color:#6b7280;">Data / Status</div>
            <div style="font-size:12px;font-weight:700;">${new Date(s.dataSolicitacao).toLocaleDateString('pt-BR')} Â· ${escapeHtml(status.toUpperCase())}</div>
          </div>
        </div>

        <div style="margin-top:10px;border:1px solid #e5e7eb;border-radius:10px;padding:10px;">
          <div style="font-size:10px;color:#6b7280;">Justificativa</div>
          <div style="font-size:12px;margin-top:4px;white-space:pre-wrap;">${escapeHtml(s.justificativa||'')}</div>
        </div>

        <div style="margin-top:10px;">
          <div style="font-size:11px;font-weight:800;color:#003b5c;margin-bottom:6px;">Itens solicitados</div>
          <table style="width:100%;border-collapse:collapse;font-size:11px;">
            <thead>
              <tr style="background:#f3f6fb;">
                <th style="border:1px solid #e5e7eb;padding:6px 8px;text-align:left;">EPI</th>
                <th style="border:1px solid #e5e7eb;padding:6px 8px;text-align:left;">CÃ³digo</th>
                <th style="border:1px solid #e5e7eb;padding:6px 8px;text-align:center;width:80px;">Qtd</th>
              </tr>
            </thead>
            <tbody>${itens}</tbody>
          </table>
        </div>
      </div>
    `;
  }).join('<div style="page-break-inside:avoid;"></div>');

  return `
    <div style="font-family: Arial, sans-serif; padding: 18px; color:#111;">
      ${cab}
      ${blocos}
      <hr style="border:none;border-top:1px solid #e5e7eb;margin:14px 0 8px;">
      <div style="font-size:10px;color:#6b7280;">Documento gerado pelo aplicativo (PDF automÃ¡tico).</div>
    </div>
  `;
}

async function exportHTMLToPDFBlob(htmlStr) {
  if (!window.jspdf || !window.html2canvas) return null;

  // Criar elemento temporÃ¡rio para renderizaÃ§Ã£o
  const tempDiv = document.createElement('div');
  tempDiv.style.position = 'absolute';
  tempDiv.style.left = '-9999px';
  tempDiv.style.top = '0';
  tempDiv.style.width = '900px';
  tempDiv.style.padding = '20px';
  tempDiv.style.background = '#fff';
  tempDiv.innerHTML = htmlStr;
  document.body.appendChild(tempDiv);

  try {
    const canvas = await html2canvas(tempDiv, { scale: 2, useCORS: true, logging: false });
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth - 20;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    const imgData = canvas.toDataURL('image/png');

    // Paginar se necessÃ¡rio
    let y = 10;
    let remaining = imgHeight;
    let position = 0;

    while (remaining > 0) {
      pdf.addImage(imgData, 'PNG', 10, y - position, imgWidth, imgHeight);
      remaining -= (pageHeight - 20);
      position += (pageHeight - 20);
      if (remaining > 0) pdf.addPage();
    }

    return pdf.output('blob');
  } finally {
    document.body.removeChild(tempDiv);
  }
}

// =========================
// RECONHECIMENTO FACIAL
// =========================
async function initFaceAPI() {
  try {
    // Carregar modelos do face-api.js
    await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
    await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
    await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
    await faceapi.nets.faceExpressionNet.loadFromUri('/models');
    
    $('statusFace').textContent = 'Reconhecimento: Pronto';
    $('statusFace').className = 'status-badge status-ativo';
    
    console.log('Face API carregada com sucesso!');
  } catch (error) {
    console.error('Erro ao carregar Face API:', error);
    $('statusFace').textContent = 'Reconhecimento: Offline';
    $('statusFace').className = 'status-badge status-vencido';
    
    // Carregar dados de rostos do localStorage
    loadRostosFromStorage();
  }
  
  // Event listeners para reconhecimento facial
  $('btnIniciarCamera').addEventListener('click', iniciarCamera);
  $('btnCapturarRosto').addEventListener('click', capturarRosto);
  $('btnPararCamera').addEventListener('click', stopCamera);
  $('btnCadastrarRosto').addEventListener('click', cadastrarRosto);
  $('btnListarRostos').addEventListener('click', renderRostos);
  $('btnConfirmarIdentificacao').addEventListener('click', confirmarIdentificacao);
  $('btnTentarNovamente').addEventListener('click', () => {
    $('faceResult').style.display = 'none';
    currentFaceMatch = null;
  });
}

async function iniciarCamera() {
  try {
    const video = $('faceVideo');
    
    // Parar stream atual se existir
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
    }
    
    // Solicitar acesso Ã  cÃ¢mera
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 640 },
        height: { ideal: 480 },
        facingMode: 'user'
      },
      audio: false
    });
    
    video.srcObject = videoStream;
    video.play();
    
    // Iniciar detecÃ§Ã£o em tempo real
    iniciarDetecaoTempoReal();
    
    $('btnIniciarCamera').disabled = true;
    $('btnPararCamera').disabled = false;
    $('btnCapturarRosto').disabled = false;
    
  } catch (error) {
    console.error('Erro ao acessar cÃ¢mera:', error);
    alert('NÃ£o foi possÃ­vel acessar a cÃ¢mera. Verifique as permissÃµes.');
  }
}

function stopCamera() {
  if (videoStream) {
    videoStream.getTracks().forEach(track => track.stop());
    videoStream = null;
  }
  
  const video = $('faceVideo');
  if (video) {
    video.srcObject = null;
  }
  
  const canvas = $('faceCanvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  
  $('btnIniciarCamera').disabled = false;
  $('btnPararCamera').disabled = true;
  $('btnCapturarRosto').disabled = true;
}

async function iniciarDetecaoTempoReal() {
  const video = $('faceVideo');
  const canvas = $('faceCanvas');
  const displaySize = { width: video.width, height: video.height };
  
  faceapi.matchDimensions(canvas, displaySize);
  
  async function detectar() {
    if (!videoStream) return;
    
    const detections = await faceapi
      .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks()
      .withFaceDescriptors()
      .withFaceExpressions();
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const resizedDetections = faceapi.resizeResults(detections, displaySize);
    faceapi.draw.drawDetections(canvas, resizedDetections);
    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
    faceapi.draw.drawFaceExpressions(canvas, resizedDetections);
    
    // Verificar se hÃ¡ rostos detectados
    if (detections.length > 0) {
      const descriptor = detections[0].descriptor;
      currentFaceDescriptor = descriptor;
      
      // Tentar reconhecer o rosto
      if (rostosDB.length > 0) {
        const faceMatcher = new faceapi.FaceMatcher(rostosDB.map(r => {
          return new faceapi.LabeledFaceDescriptors(r.nome, [new Float32Array(r.descriptor)]);
        }));
        
        const bestMatch = faceMatcher.findBestMatch(descriptor);
        
        if (bestMatch && bestMatch.distance < 0.6) { // Threshold de similaridade
          currentFaceMatch = {
            nome: bestMatch.label,
            distancia: bestMatch.distance,
            expressoes: detections[0].expressions
          };
          
          // Mostrar resultado
          $('faceMatchText').textContent = `ğŸ‘¤ Identificado: ${bestMatch.label}`;
          $('faceMatchText').className = 'face-match';
          $('faceConfidence').textContent = `ConfianÃ§a: ${((1 - bestMatch.distance) * 100).toFixed(1)}%`;
          $('btnConfirmarIdentificacao').style.display = 'inline-block';
          $('faceResult').style.display = 'block';
        }
      }
    } else {
      currentFaceDescriptor = null;
      currentFaceMatch = null;
    }
    
    if (videoStream) {
      requestAnimationFrame(detectar);
    }
  }
  
  detectar();
}

async function capturarRosto() {
  if (!currentFaceDescriptor) {
    alert('Nenhum rosto detectado! Posicione-se melhor na cÃ¢mera.');
    return;
  }
  
  const nome = prompt('Digite o nome para este rosto:');
  if (!nome) return;
  
  const matricula = prompt('Digite a matrÃ­cula/chapa:');
  const descricao = prompt('Digite uma descriÃ§Ã£o (opcional):');
  
  const novoRosto = {
    id: 'face_' + Date.now().toString(36),
    nome: nome.trim(),
    matricula: matricula ? matricula.trim() : '',
    descricao: descricao ? descricao.trim() : '',
    descriptor: Array.from(currentFaceDescriptor),
    dataCadastro: new Date().toISOString()
  };
  
  rostosDB.push(novoRosto);
  saveToStorage(LS_ROSTOS, rostosDB);
  
  renderRostos();
  alert('Rosto cadastrado com sucesso!');
}

async function cadastrarRosto() {
  const nome = $('faceNome').value.trim();
  const matricula = $('faceMatricula').value.trim();
  const descricao = $('faceDescricao').value.trim();
  
  if (!nome || !currentFaceDescriptor) {
    alert('Preencha o nome e certifique-se de que hÃ¡ um rosto detectado!');
    return;
  }
  
  const novoRosto = {
    id: 'face_' + Date.now().toString(36),
    nome,
    matricula,
    descricao,
    descriptor: Array.from(currentFaceDescriptor),
    dataCadastro: new Date().toISOString()
  };
  
  rostosDB.push(novoRosto);
  saveToStorage(LS_ROSTOS, rostosDB);
  
  // Limpar formulÃ¡rio
  $('faceNome').value = '';
  $('faceMatricula').value = '';
  $('faceDescricao').value = '';
  
  renderRostos();
  alert('Rosto cadastrado com sucesso!');
}

function confirmarIdentificacao() {
  if (!currentFaceMatch) {
    alert('Nenhuma identificaÃ§Ã£o confirmada!');
    return;
  }
  
  // Preencher automaticamente o formulÃ¡rio de movimentaÃ§Ã£o
  const rostoInfo = rostosDB.find(r => r.nome === currentFaceMatch.nome);
  if (rostoInfo) {
    $('estoqueColaborador').value = rostoInfo.nome;
    $('estoqueCPF').value = rostoInfo.matricula;
    
    // Ir para a seÃ§Ã£o de movimentaÃ§Ãµes
    setSection('sec-estoque-mov');
    
    // Focar no campo de EPI
    setTimeout(() => {
      $('estoqueEPI').focus();
    }, 100);
  }
  
  $('faceResult').style.display = 'none';
  currentFaceMatch = null;
}

function renderRostos() {
  const tbody = $('tbRostosCadastrados');
  
  if (rostosDB.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
          Nenhum rosto cadastrado ainda.
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = rostosDB.map(rosto => {
    const data = new Date(rosto.dataCadastro).toLocaleDateString('pt-BR');
    
    return `
      <tr>
        <td>${escapeHtml(rosto.nome)}</td>
        <td>${escapeHtml(rosto.matricula || 'â€”')}</td>
        <td>${escapeHtml(rosto.descricao || 'â€”')}</td>
        <td>${data}</td>
        <td>
          <button class="btn btn-sm btn-outline" onclick="verDetalhesRosto('${rosto.id}')">Ver</button>
          <button class="btn btn-sm btn-danger" onclick="removerRosto('${rosto.id}')">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `;
  }).join('');
}

function verDetalhesRosto(rostoId) {
  const rosto = rostosDB.find(r => r.id === rostoId);
  if (!rosto) return;
  
  const data = new Date(rosto.dataCadastro).toLocaleString('pt-BR');
  
  const detalhes = `
    <h3>Detalhes do Rosto Cadastrado</h3>
    <p><strong>Nome:</strong> ${rosto.nome}</p>
    <p><strong>MatrÃ­cula/Chapa:</strong> ${rosto.matricula || 'â€”'}</p>
    <p><strong>DescriÃ§Ã£o:</strong> ${rosto.descricao || 'â€”'}</p>
    <p><strong>Data de Cadastro:</strong> ${data}</p>
    <p><strong>ID:</strong> ${rosto.id}</p>
  `;
  
  $('modalBody').innerHTML = detalhes;
  $('modalBackdrop').style.display = 'flex';
}

function removerRosto(rostoId) {
  if (!confirm('Tem certeza que deseja remover este rosto cadastrado?')) return;
  
  rostosDB = rostosDB.filter(r => r.id !== rostoId);
  saveToStorage(LS_ROSTOS, rostosDB);
  renderRostos();
  
  alert('Rosto removido com sucesso!');
}

function loadRostosFromStorage() {
  // Converter dados do localStorage para o formato esperado
  const rawRostos = loadFromStorage(LS_ROSTOS, []);
  rostosDB = rawRostos.map(r => ({
    ...r,
    descriptor: r.descriptor ? new Float32Array(r.descriptor) : new Float32Array(128)
  }));
}

function atualizarDatalistColaboradores() {
  const datalist = $('dlColaboradores');
  if (!datalist) return;
  
  // Coletar colaboradores Ãºnicos do histÃ³rico
  const colaboradoresSet = new Set();
  
  estoqueDB.forEach(item => {
    if (item.historico) {
      item.historico.forEach(h => {
        if (h.colaborador && h.colaborador.trim()) {
          colaboradoresSet.add(h.colaborador.trim());
        }
      });
    }
  });
  
  // Adicionar rostos cadastrados
  rostosDB.forEach(r => {
    if (r.nome && r.nome.trim()) {
      colaboradoresSet.add(r.nome.trim());
    }
  });
  
  // Ordenar alfabeticamente
  const colaboradores = Array.from(colaboradoresSet).sort((a, b) => 
    a.localeCompare(b, 'pt-BR')
  );
  
  // Atualizar datalist
  datalist.innerHTML = colaboradores.map(nome => 
    `<option value="${escapeHtml(nome)}"></option>`
  ).join('');
}

// =========================
// FUNÃ‡ÃƒO DE EXPORTAÃ‡ÃƒO PDF
// =========================
async function exportHTMLToPDF(htmlStr, filename) {
  if (!window.jspdf || !window.html2canvas) {
    alert('Bibliotecas de PDF nÃ£o carregadas. Verifique sua conexÃ£o.');
    return;
  }
  
  try {
    // Criar elemento temporÃ¡rio para renderizaÃ§Ã£o
    const tempDiv = document.createElement('div');
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    tempDiv.style.top = '0';
    tempDiv.style.width = '800px';
    tempDiv.style.padding = '20px';
    tempDiv.style.background = '#fff';
    tempDiv.innerHTML = htmlStr;
    
    document.body.appendChild(tempDiv);
    
    // Converter para canvas
    const canvas = await html2canvas(tempDiv, {
      scale: 2,
      useCORS: true,
      logging: false
    });
    
    document.body.removeChild(tempDiv);
    
    // Criar PDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    
    // Calcular dimensÃµes da imagem
    const imgWidth = pageWidth - 20; // Margens de 10mm cada lado
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    // Adicionar imagem ao PDF
    const imgData = canvas.toDataURL('image/png');
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    
    // Salvar PDF
    pdf.save(filename);
    
  } catch (error) {
    console.error('Erro ao gerar PDF:', error);
    alert('Erro ao gerar PDF. Tente novamente.');
  }
}

// =========================
// INICIALIZAÃ‡ÃƒO DA APLICAÃ‡ÃƒO
// =========================
document.addEventListener('DOMContentLoaded', initApp);

// Fechar modal
$('modalClose').addEventListener('click', () => {
  $('modalBackdrop').style.display = 'none';
});

$('modalBackdrop').addEventListener('click', (e) => {
  if (e.target.id === 'modalBackdrop') {
    $('modalBackdrop').style.display = 'none';
  }
});

// Helper para definir seÃ§Ã£o (usado pelo reconhecimento facial)
function setSection(sectionId) {
  $$('.nav-btn').forEach(b => b.classList.remove('active'));
  $$('.section').forEach(s => s.classList.remove('active'));
  
  const btn = $(`[data-sec="${sectionId}"]`);
  const section = $(sectionId);
  
  if (btn) btn.classList.add('active');
  if (section) section.classList.add('active');
}
</script>
</body>
</html>
</template>
<script>
(function(){
  function boot(){
    var ifr=document.getElementById('ifrEstoqueSamarco');
    var tpl=document.getElementById('tplEstoqueSamarco');
    if(!ifr||!tpl) return;
    try{ ifr.srcdoc = tpl.innerHTML; }
    catch(e){ console.warn('Falha ao carregar mÃ³dulo de Estoque via srcdoc', e); }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>
</body>
</html>
